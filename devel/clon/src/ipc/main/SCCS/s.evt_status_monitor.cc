h39756
s 00001/00001/00529
d D 1.41 07/10/21 23:54:45 boiarino 45 44
c clonxt3 -> clondaq2
c 
e
s 00000/00003/00530
d D 1.40 07/10/12 10:22:21 boiarino 44 43
c *** empty log message ***
e
s 00006/00001/00527
d D 1.39 07/10/11 18:26:20 boiarino 43 42
c fix for Linux
c 
e
s 00008/00003/00520
d D 1.38 06/11/28 00:06:47 boiarino 42 41
c *** empty log message ***
e
s 00002/00002/00521
d D 1.37 06/11/27 23:59:50 boiarino 41 40
c *** empty log message ***
e
s 00012/00010/00511
d D 1.36 06/11/27 12:37:02 boiarino 40 39
c *** empty log message ***
e
s 00001/00000/00520
d D 1.35 02/10/11 09:46:47 wolin 39 38
c Added scstatmon
e
s 00001/00001/00519
d D 1.34 02/09/30 11:48:55 wolin 38 37
c No -daq1
e
s 00005/00001/00515
d D 1.33 01/11/27 15:20:30 wolin 37 36
c Reset nstd if not clasprod
e
s 00001/00001/00515
d D 1.32 01/11/26 13:34:42 wolin 36 35
c Tyhpo
e
s 00023/00024/00493
d D 1.31 01/11/26 13:32:23 wolin 35 34
c Defaults to non-master, no file, no info, no print
e
s 00002/00002/00515
d D 1.30 01/10/18 10:16:09 wolin 34 33
c coda_l3_clasprod, etc.
e
s 00001/00001/00516
d D 1.29 01/10/17 13:51:50 wolin 33 32
c Typo
e
s 00003/00004/00514
d D 1.28 01/10/17 13:49:01 wolin 32 31
c Typo for extra procs
e
s 00004/00004/00514
d D 1.27 01/10/11 14:02:33 wolin 31 30
c Reorder std procs
e
s 00030/00031/00488
d D 1.26 01/10/11 13:55:27 wolin 30 29
c Finally solved strdup problem
e
s 00008/00003/00511
d D 1.25 01/10/11 13:22:52 wolin 29 28
c Minor mods
e
s 00017/00016/00497
d D 1.24 01/10/11 12:59:14 wolin 28 27
c Minor mods...not sure why get core dump if extra procs exist
e
s 00018/00000/00495
d D 1.23 01/02/08 16:18:41 wolin 27 26
c Added to status poll results
e
s 00022/00023/00473
d D 1.22 00/11/30 10:49:30 wolin 26 24
i 25
c Accepted child's version in workspace "/usr/local/clas/devel/source".
c 
e
s 00001/00001/00494
d D 1.19.1.3 00/11/27 17:48:18 wolin 25 23
c mon_clasprod
e
s 00001/00001/00494
d D 1.21 00/11/30 10:34:20 wolin 24 22
c mon_clasprod
e
s 00001/00001/00494
d D 1.19.1.2 00/11/27 17:37:29 wolin 23 21
c trigmon_clasprod
e
s 00001/00001/00494
d D 1.20 00/11/30 09:22:12 wolin 22 20
c trigmon_clasprod
e
s 00023/00023/00472
d D 1.19.1.1 00/10/26 16:00:39 wolin 21 20
c const
e
s 00001/00001/00494
d D 1.19 00/10/25 12:29:44 wolin 20 19
c Typo
e
s 00004/00002/00491
d D 1.18 00/10/25 12:29:07 wolin 19 18
c Added et2et to clon04
e
s 00001/00001/00492
d D 1.17 00/10/24 14:28:15 wolin 18 17
c Moved stuff to clon04
e
s 00001/00001/00492
d D 1.16 00/10/19 14:44:52 wolin 17 16
c Typo
e
s 00006/00003/00487
d D 1.15 00/10/17 15:20:26 wolin 16 15
c Truncated name for printout
e
s 00003/00003/00487
d D 1.14 00/01/06 16:28:18 wolin 15 14
c Removed et2ipc
e
s 00005/00015/00485
d D 1.13 99/11/22 14:11:29 wolin 14 13
c Removed dd
e
s 00004/00004/00496
d D 1.12 99/09/27 15:29:39 wolin 13 12
c Minor mods to print format
c 
e
s 00002/00002/00498
d D 1.11 99/09/09 15:06:17 wolin 12 11
c No more et system on clon04	
c 
e
s 00006/00006/00494
d D 1.10 99/08/27 09:45:33 wolin 11 10
c Output format mod
c 
e
s 00001/00001/00499
d D 1.9 99/07/06 12:56:40 wolin 10 9
c Minor mods
c 
e
s 00002/00001/00498
d D 1.8 99/06/29 11:56:31 wolin 9 8
c Added ptp processes
c 
e
s 00001/00001/00498
d D 1.7 99/06/03 13:23:48 wolin 8 7
c no more dd
c 
e
s 00006/00000/00493
d D 1.6 99/05/27 09:47:23 wolin 7 6
c Trim node names
c 
e
s 00006/00006/00487
d D 1.5 99/04/30 13:19:11 wolin 6 5
c Minor mods
c 
e
s 00003/00003/00490
d D 1.4 99/03/11 09:58:07 wolin 5 4
c Reordered some code
c 
e
s 00040/00039/00453
d D 1.3 99/03/09 14:27:16 wolin 4 3
c Seems to be working
e
s 00019/00002/00473
d D 1.2 99/02/16 16:39:00 wolin 3 1
c Added quit callback
c 
e
s 00000/00000/00000
d R 1.2 99/02/16 16:30:42 Codemgr 2 1
c SunPro Code Manager data about conflicts, renames, etc...
c Name history : 1 0 evtutil/s/evt_status_monitor.cc
e
s 00475/00000/00000
d D 1.1 99/02/16 16:30:41 wolin 1 0
c 
e
u
U
f e 0
t
T
I 1
// evt_status_monitor

//  can broadcast evt_status request message, prints all replies,
//    and create info server message

I 28
//  still to do:
D 35
//     strdup?
E 35


E 28
D 14
// eventually eliminate dd stuff

// ejw, 12-feb-99
E 14
I 14
// ejw, 22-nov-99
E 14



#define _POSIX_SOURCE 1
#define __EXTENSIONS__


//  for smartsockets
#include <rtworks/cxxipc.hxx>


// CLAS ipc
#include <clas_ipc_prototypes.h>


//  system
#include <fstream.h>
#include <stdlib.h>
#include <stdio.h>
#include <iomanip.h>
#include <time.h>
I 43

D 44
#ifdef SunOS
E 43
#include <macros.h>
I 43
#endif
E 44
E 43

I 43
#define MIN(a,b)  ( (a) < (b) ? (a) : (b) )
E 43

I 43

E 43
// misc
D 21
D 26
static char *application = "clastest";
E 26
I 26
static char *application = (char*)"clastest";
E 26
E 21
I 21
static char *application = (char*)"clastest";
E 21
static int wait_time     = 3;
static int pause_time    = 7;
D 35
static int no_broadcast  = 0;
E 35
I 35
static int broadcast     = 0;
E 35
static int no_print      = 0;
D 35
static int no_info       = 0;
static int no_file       = 0;
E 35
I 35
static int info          = 0;
static int file          = 0;
E 35
I 3
static int done          = 0;
E 3
static int once          = 0;
I 27
static int nreq          = 0;
E 27
static time_t last_time  = 0;
D 21
D 26
static char *info_file   = "evt/evt_status_monitor.txt";
E 26
I 26
static char *info_file   = (char*)"evt/evt_status_monitor.txt";
E 26
E 21
I 21
static char *info_file   = (char*)"evt/evt_status_monitor.txt";
E 21
static ofstream *ofile;
static char filename[120];


// storage for standard procs
D 28
#define MAX_PROC 100
D 4
char *std_id[] = {"et2ipc_10_clasprod","ipc2dd_00_clasprod","mon_00_clasprod",
		  "dd2status_clasprod","dd2scaler_clasprod","ipcbank2et_10_clasprod",
		  "recsis_clasprod"};
E 4
I 4
D 8
char *std_id[] = {"et2ipc_10_clasprod","ipcbank2et_10_clasprod","ipc2dd_00_clasprod",
E 8
I 8
D 9
char *std_id[] = {"et2ipc_10_clasprod","ipcbank2et_10_clasprod","ipc2et_00_clasprod",
E 9
I 9
D 10
char *std_id[] = {"ipcbank2et_10_clasprod","et2ipc_10_clasprod","ipc2et_00_clasprod",
E 10
I 10
D 12
char *std_id[] = {"et2ipc_10_clasprod","ipcbank2et_10_clasprod","ipc2et_00_clasprod",
E 10
		  "et2ptp_10_clasprod:5678","ptp2et_04_clasprod_10:5678",
E 12
I 12
D 15
char *std_id[] = {"et2ipc_10_clasprod","ipcbank2et_10_clasprod",
		  "et2ptp_10_clasprod:5678","ptp2et_00_clasprod_10:5678",
E 15
I 15
D 16
char *std_id[] = {"et2ptp_10_clasprod:5678","ipcbank2et_10_clasprod",
		  "ptp2et_00_clasprod_10:5678",
E 16
I 16
D 17
char *std_id[] = {"et2et_clasprod_clon00_clasprod_clon00-daq1","ipcbank2et_10_clasprod",
E 17
I 17
D 21
D 26
char *std_id[] = {"et2et_clasprod_clon10_clasprod_clon00-daq1","ipcbank2et_10_clasprod",
E 17
E 16
E 15
E 12
E 9
E 8
		  "evstatmon_clasprod","scaler_server_clasprod",
D 15
		  "mon_00_clasprod","recsis_clasprod"};
E 15
I 15
D 18
		  "mon_00_clasprod","recsis_clasprod","trigmon_00_clasprod"};
E 18
I 18
D 19
		  "mon_04_clasprod","recsis_clasprod","trigmon_04_clasprod"};
E 19
I 19
D 22
		  "mon_04_clasprod","recsis_clasprod","trigmon_04_clasprod",
E 22
I 22
D 24
		  "mon_04_clasprod","recsis_clasprod","trigmon_clasprod",
E 24
I 24
		  "mon_clasprod","recsis_clasprod","trigmon_clasprod",
E 24
E 22
		  "et2et_clasprod_clon10_clasprod_clon04"
E 26
I 26
const char *std_id[] = {"et2et_clasprod_clon10_clasprod_clon00-daq1","ipcbank2et_10_clasprod",
			"evstatmon_clasprod","scaler_server_clasprod",
E 26
E 21
I 21
const char *std_id[] = {"et2et_clasprod_clon10_clasprod_clon00-daq1","ipcbank2et_10_clasprod",
			"evstatmon_clasprod","scaler_server_clasprod",
D 23
			"mon_04_clasprod","recsis_clasprod","trigmon_04_clasprod",
E 23
I 23
D 25
			"mon_04_clasprod","recsis_clasprod","trigmon_clasprod",
E 25
I 25
			"mon_clasprod","recsis_clasprod","trigmon_clasprod",
E 28
I 28
#define MAX_PROC 200
D 31
const char *std_id[] = {"ipcbank2et_10_clasprod","l3",
			"scaler_server_clasprod","evstatmon_clasprod",
			"mon_clasprod","recsis_clasprod","coda_pr","coda_tr",
E 31
I 31
D 32
const char *std_id[] = {"ipcbank2et_10_clasprod","l3","scaler_server_clasprod",
E 32
I 32
D 33
const char *std_id[] = {"ipcbank2et_10_clasprod","cxxoda_l3","scaler_server_clasprod",
E 33
I 33
D 34
const char *std_id[] = {"ipcbank2et_10_clasprod","coda_l3","scaler_server_clasprod",
E 34
I 34
D 42
const char *std_id[] = {"ipcbank2et_10_clasprod","coda_l3_clasprod","scaler_server_clasprod",
E 42
I 42
const char *std_id[] = {"ipcbank2et_10_clasprod",
                        "coda_l3_clasprod",
                        "scaler_server_clasprod",
E 42
E 34
E 33
E 32
E 31
D 38
			"et2et_clasprod_clon10_clasprod_clon00-daq1",
E 38
I 38
D 40
			"et2et_clasprod_clon10_clasprod_clon00",
E 40
I 40
			"et2et_daq_mon_clasprod",
E 40
E 38
E 28
I 26
D 31
			"et2et_clasprod_clon10_clasprod_clon04"
E 31
I 31
D 34
			"coda_pr","coda_tr",
E 34
I 34
D 42
			"coda_pr_clasprod","coda_tr_clasprod",
E 42
I 42
			"coda_pr_clasprod",
                        "coda_tr_clasprod",
E 42
E 34
D 40
			"et2et_clasprod_clon10_clasprod_clon04",
E 40
I 40
			"et2et_daq_mon2_clasprod",
E 40
D 42
			"evstatmon_clasprod","mon_clasprod","recsis_clasprod",
E 42
I 42
			"evstatmon_clasprod",
                        "mon_clasprod",
                        "recsis_clasprod",
E 42
I 39
			"scstatmon_clasprod",
I 40
D 41
			"et2et_clonxt1_clonxt3-daq2_clasprod",
			"et2et_clonxt3_clon10-daq1_clasprod",
E 41
I 41
D 45
			"et2et_eb_clonxt3-daq2_clasprod",
E 45
I 45
			"et2et_eb_clondaq2-daq2_clasprod",
E 45
			"et2et_er_clon10-daq1_clasprod",
E 41
E 40
E 39
E 31
E 26
E 25
E 23
			"et2et_clasprod_clon10_clasprod_clon04"
E 21
};
I 30
#define CSIZE 256
E 30
E 19
E 18
E 15
E 4
struct evtinfo {
D 30
  char *id;
D 19
  char *node;
E 19
I 19
D 20
  char *node;mak
E 20
I 20
  char *node;
E 20
E 19
  char *srvnode;
  char *name;
E 30
I 30
  char id[CSIZE];
  char node[CSIZE];
  char srvnode[CSIZE];
  char name[CSIZE];
E 30
  T_INT4 nevt_rec;
  T_REAL8 rec_rate;
  T_INT4  nevt_proc;
  T_REAL8 proc_rate;
  T_INT4 flag;
D 30
  char *source;
E 30
I 30
  char source[CSIZE];
E 30
};
static evtinfo proc_info[MAX_PROC];
D 28
static int nextra;
static int nstd = sizeof(std_id)/sizeof(char*);
E 28
I 28
static int nextra = 0;
D 30
static int nstd   = sizeof(std_id)/sizeof(char*);
E 30
I 30
D 37
static const int nstd   = sizeof(std_id)/sizeof(char*);
E 37
I 37
static int nstd   = sizeof(std_id)/sizeof(char*);
E 37
E 30
E 28
static char temp[200];


// prototypes
void broadcast_request(void);
void print_title(void);
I 26
void print_results(void);
void send_info_server_msg(void);
E 26
I 21
void print_results(void);
void send_info_server_msg(void);
E 21
void receive_info(
		  T_IPC_CONN conn,
		  T_IPC_CONN_PROCESS_CB_DATA data,
		  T_CB_ARG arg);
D 21
D 26
void print_results(void);
void send_info_server_msg(void);
E 26
I 26
extern "C"{
I 27
void status_poll_callback(T_IPC_MSG msg);
E 27
E 26
E 21
I 21
extern "C"{
E 21
I 3
void quit_callback(int sig);
E 3
void decode_command_line(int argc, char **argv);
D 21
D 26
extern "C"{
int insert_msg(char *name, char *facility, char *process, char *msgclass, 
	      int severity, char *status, int code, char *message);
E 26
I 26
int insert_msg(const char *name, const char *facility, const char *process, const char *msgclass, 
	      int severity, const char *status, int code, const char *message);
E 26
E 21
I 21
int insert_msg(const char *name, const char *facility, const char *process, const char *msgclass, 
	      int severity, const char *status, int code, const char *message);
E 21
}


// ref to server (connection created later)
TipcSrv &server=TipcSrv::Instance();


//---------------------------------------------------------------


int main(int argc, char **argv) {

  FILE *fp;
  int status;


  // synch with stdio
  ios::sync_with_stdio();


  // decode command line
  decode_command_line(argc,argv);


  // connect to ipc...no info server message if not broadcasting request
  TutSetOutputFunc(ipc_output_dummy);
  ipc_set_application(application);
I 27
  ipc_set_user_status_poll_callback(status_poll_callback);
E 27
I 3
  ipc_set_quit_callback(quit_callback);
E 3
D 35
  if(no_broadcast==0) {
E 35
I 35
  if(broadcast!=0) {
E 35
    status=ipc_init("evt_status_monitor","evt status monitor (master)");
  } else {
    status=ipc_init("","evt status monitor");
D 35
    no_info=1;
    no_file=1;
E 35
I 35
    info=0;
    file=0;
E 35
  }
  if(status<0) {
    cerr << "\n?Unable to connect to server..."
	 << "probably duplicate unique id\n"
	 << "   ...check for another evt_status_monitor connected to "
	 << application << " using ipc_info\n"
	 << "   ...only one such process allowed!" << endl << endl;
    exit(EXIT_FAILURE);
  }
I 37


  // reset nstd if not clasprod project
  if(strcasecmp(application,"clasprod")!=0)nstd=0;
E 37


  // receive evt_status messages
D 14
  server.SubjectSubscribe("/dd_system/status",TRUE);
E 14
D 21
D 26
  server.SubjectSubscribe("/evt_system/status",TRUE);
D 14
  TipcMt mt("dd_status");
  server.ProcessCbCreate(mt,receive_info,NULL);
E 14
  TipcMt mt2("evt_status");
E 26
I 26
  server.SubjectSubscribe((T_STR)"/evt_system/status",TRUE);
  TipcMt mt2((T_STR)"evt_status");
E 26
E 21
I 21
  server.SubjectSubscribe((T_STR)"/evt_system/status",TRUE);
  TipcMt mt2((T_STR)"evt_status");
E 21
  server.ProcessCbCreate(mt2,receive_info,NULL);
  TutSetOutputFunc(NULL);


  // get output file name
D 35
  if(no_file==0) {
E 35
I 35
  if(file!=0) {
E 35
    sprintf(filename,"%s/%s",getenv("CLON_PARMS"),info_file);
  }


  // flush outgoing messages and output
  server.Flush();
  cout << flush;


  // warning message if not in broadcast mode
D 35
  if(no_broadcast==1) {
E 35
I 35
  if(broadcast==0) {
E 35
    cout << "\n  *** NOTE...evt_status_monitor (master) must be running ***" 
	 << endl << endl;
  }


  // post startup message for master
D 35
  if(no_broadcast==0) {
E 35
I 35
  if(broadcast!=0) {
E 35
    sprintf(temp,"Process startup:    %15s  in application:  %s","evt_status_monitor (master)",
	    application);
    status=insert_msg("evt_status_monitor","online","evt_status_monitor","status",0,"START",0,temp);
  }


  // loop forever
D 3
  while(0==0) {
E 3
I 3
  while(done==0) {
E 3


D 5
    server.MainLoop((double)pause_time);


E 5
    // clear arrays, etc.
    nextra=0;
    for(int i=0; i<nstd; i++) {
D 28
      if(i<nstd) {
	proc_info[i].id=strdup(std_id[i]);
      } else {
	proc_info[i].id=NULL;
      }
E 28
I 28
D 30
      proc_info[i].id=(char*)std_id[i];
E 28
D 21
D 26
      proc_info[i].node="unknown";
      proc_info[i].srvnode="unknown";
      proc_info[i].name="unknown";
E 26
I 26
      proc_info[i].node=(char*)"unknown";
      proc_info[i].srvnode=(char*)"unknown";
      proc_info[i].name=(char*)"unknown";
E 30
I 30
      strcpy(proc_info[i].id,std_id[i]);
      strcpy(proc_info[i].node,"unknown");
      strcpy(proc_info[i].srvnode,"unknown");
      strcpy(proc_info[i].name,"unknown");
E 30
E 26
E 21
I 21
      proc_info[i].node=(char*)"unknown";
      proc_info[i].srvnode=(char*)"unknown";
      proc_info[i].name=(char*)"unknown";
E 21
      proc_info[i].nevt_rec=0;
      proc_info[i].rec_rate=0.0;
      proc_info[i].nevt_proc=0;
      proc_info[i].proc_rate=0.0;
      proc_info[i].flag=0;
D 21
D 26
      proc_info[i].source="unknown";
E 26
I 26
D 30
      proc_info[i].source=(char*)"unknown";
E 30
I 30
      strcpy(proc_info[i].source,"unknown");
E 30
E 26
E 21
I 21
      proc_info[i].source=(char*)"unknown";
E 21
    }

    
I 5
    server.MainLoop((double)pause_time);


E 5
    // broadcast mode
D 35
    if(no_broadcast==0) {
E 35
I 35
    if(broadcast!=0) {
E 35
      broadcast_request();
D 35
      if(no_file==0)ofile = new ofstream(filename);
E 35
I 35
      if(file!=0)ofile = new ofstream(filename);
E 35
      server.MainLoop((double)wait_time);
      print_title();
      print_results();
D 35
      if(no_file==0) {
E 35
I 35
      if(file!=0) {
E 35
	ofile->close();
	delete ofile;
      }
D 35
      if(no_info==0)send_info_server_msg();
E 35
I 35
      if(info==1)send_info_server_msg();
E 35


    // non-broadcast mode
    } else {
      server.MainLoop((double)wait_time);
      print_title();
      print_results();
    }


    //  repeat or quit
    if(once==1) break;
  }


  // done
  TutSetOutputFunc(ipc_output_dummy);
D 35
  if(no_broadcast==0) {
E 35
I 35
  if(broadcast!=0) {
E 35
D 3
    sprintf(temp,"Process shutdown:  evt_status_monitor (master)");
E 3
I 3
    sprintf(temp,"Process shutdown:    %15s  in application:  %s","evt_status_monitor (master)",
	    application);
E 3
    status=insert_msg("evt_status_monitor","online","evt_status_monitor","status",0,"STOP",0,temp);
  }
  exit(EXIT_SUCCESS);
}


//------------------------------------------------------------------


void broadcast_request() {

D 4
  TipcMsg msg(TipcMtLookupByNum(T_MT_CONTROL));
E 4
I 4
D 14
  TipcMsg msg1(TipcMtLookupByNum(T_MT_CONTROL));
  TipcMsg msg2(TipcMtLookupByNum(T_MT_CONTROL));
E 14
I 14
  TipcMsg msg(TipcMtLookupByNum(T_MT_CONTROL));
E 14
E 4

I 27
  nreq++;
  
E 27
D 4
  msg.Dest("dd_system");
  msg << "dd_status_poll";
  server.Send(msg,TRUE);

  msg.Dest("evt_system");
  msg << "evt_status_poll";
  server.Send(msg,TRUE);
E 4
I 4
D 14
  msg1.Dest("dd_system");
  msg1 << "dd_status_poll";
  server.Send(msg1,TRUE);

  msg2.Dest("evt_system");
  msg2 << "evt_status_poll";
  server.Send(msg2,TRUE);
E 14
I 14
D 21
D 26
  msg.Dest("evt_system");
  msg << "evt_status_poll";
E 26
I 26
  msg.Dest((T_STR)"evt_system");
  msg << (T_STR)"evt_status_poll";
E 26
E 21
I 21
  msg.Dest((T_STR)"evt_system");
  msg << (T_STR)"evt_status_poll";
E 21
  server.Send(msg,TRUE);
E 14
E 4

  server.Flush();

  return;
}


//-----------------------------------------------------------------------


void print_title() {
  
  
  if(no_print==0) {
    cout << endl << endl
D 4
	 << setw(25) << "Program" << "  " << setw(8) << "Node" << "  " << setw(8) << "EVT name" << "  " 
	 << setw(8) << "Server" << "  " << setw(8) << "Evt Rec" << "  " << setw(9) << "Rec Rate" << "  "  
	 << setw(8) << "Evt Proc" << "  " << setw(9) << "Proc Rate" << "  "
	 << setw(4) << "Flag" << "  " << setw(4) << "Source" << endl;
    cout << setw(25) << "-------" << "  " << setw(8) << "----" << "  " << setw(8) << "--------" << "  " 
	 << setw(8) << "------" << "  " << setw(8) << "-------" << "  " << setw(9) << "--------" << "  " 
	 << setw(8) << "--------" << "  " << setw(9) << "---------" << "  " 
	 << setw(4) << "----" << "  " << setw(4) << "-----" << endl;
E 4
I 4
D 6
	 << setw(23) << "Program" << " " << setw(8) << "Node" << " " << setw(8) << "Session" << " " 
E 6
I 6
D 40
	 << setw(26) << "Program" << " " << setw(8) << "Node" << " " << setw(8) << "Session" << " " 
E 40
I 40
	 << setw(26) << "Program" << " " << setw(12) << "Node" << " " << setw(8) << "Session" << " " 
E 40
E 6
D 11
	 << setw(8) << "Server" << " " << setw(8) << "Evt Rec" << " " << setw(9) << "Rec Rate" << " "  
E 11
I 11
D 32
	 << setw(8) << "Server" << " " << setw(9) << "Evt Rec" << " " << setw(9) << "Rec Rate" << " "  
E 32
I 32
	 << setw(8) << "Server" << " " << setw(9) << "Evt Rec" << " " << setw(9) << "Rec Rate" << "  "  
E 32
E 11
	 << setw(8) << "Evt Proc" << " " << setw(9) << "Proc Rate" << " "
	 << setw(4) << "Flag" << " " << setw(4) << "Data Flow" << endl;
D 6
    cout << setw(23) << "-------" << " " << setw(8) << "----" << " " << setw(8) << "-------" << " " 
E 6
I 6
D 40
    cout << setw(26) << "-------" << " " << setw(8) << "----" << " " << setw(8) << "-------" << " " 
E 40
I 40
    cout << setw(26) << "-------" << " " << setw(12) << "----" << " " << setw(8) << "-------" << " " 
E 40
E 6
D 11
	 << setw(8) << "------" << " " << setw(8) << "-------" << " " << setw(9) << "--------" << " " 
E 11
I 11
D 32
	 << setw(8) << "------" << " " << setw(9) << "-------" << " " << setw(9) << "--------" << " " 
E 32
I 32
	 << setw(8) << "------" << " " << setw(9) << "-------" << " " << setw(9) << "--------" << "  " 
E 32
E 11
	 << setw(8) << "--------" << " " << setw(9) << "---------" << " " 
	 << setw(4) << "----" << " " << setw(4) << "---------" << endl;
E 4
    cout << endl;
  }


D 35
  if(no_file==0) {
E 35
I 35
  if(file!=0) {
E 35
    time_t now = time(NULL);
    *ofile << "\n  Written by evt_status_monitor on " << ctime(&now) << endl << endl;
D 4
    *ofile << setw(25) << "Program" << "  " << setw(8) << "Node" << "  " << setw(8) << "EVT name" << "  " 
	   << setw(8) << "Server" << "  " << setw(8) << "Evt Rec" << "  " << setw(9) << "Rec Rate" << "  "  
	   << setw(8) << "Evt Proc" << "  " << setw(9) << "Proc Rate" << "  "
	   << setw(4) << "Flag" << "  " << setw(4) << "Source" << endl;
    *ofile << setw(25) << "-------" << "  " << setw(8) << "----" << "  " << setw(8) << "--------" << "  " 
	   << setw(8) << "------" << "  " << setw(8) << "-------" << "  " << setw(9) << "--------" << "  " 
	   << setw(8) << "--------" << "  " << setw(9) << "---------" << "  " 
	   << setw(4) << "----" << "  " << setw(4) << "-----" << endl;
E 4
I 4
D 6
    *ofile << setw(23) << "Program" << " " << setw(8) << "Node" << " " << setw(8) << "Session" << " " 
E 6
I 6
D 40
    *ofile << setw(26) << "Program" << " " << setw(8) << "Node" << " " << setw(8) << "Session" << " " 
E 40
I 40
    *ofile << setw(26) << "Program" << " " << setw(12) << "Node" << " " << setw(8) << "Session" << " " 
E 40
E 6
D 11
	   << setw(8) << "Server" << " " << setw(8) << "Evt Rec" << " " << setw(9) << "Rec Rate" << " "  
E 11
I 11
	   << setw(8) << "Server" << " " << setw(9) << "Evt Rec" << " " << setw(9) << "Rec Rate" << " "  
E 11
D 13
	   << setw(8) << "Evt Proc" << " " << setw(9) << "Proc Rate" << " "
E 13
I 13
	   << setw(9) << "Evt Proc" << " " << setw(9) << "Proc Rate" << " "
E 13
	   << setw(4) << "Flag" << " " << setw(4) << "Data Flow" << endl;
D 6
    *ofile << setw(23) << "-------" << " " << setw(8) << "----" << " " << setw(8) << "-------" << " " 
E 6
I 6
D 40
    *ofile << setw(26) << "-------" << " " << setw(8) << "----" << " " << setw(8) << "-------" << " " 
E 40
I 40
    *ofile << setw(26) << "-------" << " " << setw(12) << "----" << " " << setw(8) << "-------" << " " 
E 40
E 6
D 11
	   << setw(8) << "------" << " " << setw(8) << "-------" << " " << setw(9) << "--------" << " " 
E 11
I 11
	   << setw(8) << "------" << " " << setw(9) << "-------" << " " << setw(9) << "--------" << " " 
E 11
D 13
	   << setw(8) << "--------" << " " << setw(9) << "---------" << " " 
E 13
I 13
	   << setw(9) << "--------" << " " << setw(9) << "---------" << " " 
E 13
	   << setw(4) << "----" << " " << setw(4) << "---------" << endl;
E 4
    *ofile << endl;
  }

  return;
}


//------------------------------------------------------------------


void receive_info(T_IPC_CONN conn,
		  T_IPC_CONN_PROCESS_CB_DATA data,
		  T_CB_ARG arg) {
  
  int i;

  T_STR id;
  T_STR node;
  T_STR name;
  T_STR srvnode;
  T_INT4 nevt_rec,nevt_proc;
  T_REAL8 rec_rate,proc_rate;
  T_INT4 flag;
  T_STR source;
I 7
  char *p;
E 7
    
  T_IPC_MSG msg = data->msg;
  
  
  // unpack message
  TipcMsgSetCurrent(msg,0);
  TipcMsgNextStr(msg,&id);
  TipcMsgNextStr(msg,&node);
  TipcMsgNextStr(msg,&name);
  TipcMsgNextStr(msg,&srvnode);
  TipcMsgNextInt4(msg,&nevt_rec);
  TipcMsgNextReal8(msg,&rec_rate);
  TipcMsgNextInt4(msg,&nevt_proc);
  TipcMsgNextReal8(msg,&proc_rate);
  TipcMsgNextInt4(msg,&flag);
  TipcMsgNextStr(msg,&source);

I 7


  // trim node names after first "."
  p=strchr(   node,'.'); if(p!=NULL)*p=NULL;
  p=strchr(srvnode,'.'); if(p!=NULL)*p=NULL;
E 7


  // store info...check if this is std proc
  int ptr=-1;
  for(i=0; i<nstd; i++) {
    if(strcasecmp(std_id[i],id)==0) { ptr=i; break; }
  }
  if(ptr<0) {
I 30
D 32
    return;
E 32
E 30
    nextra++;
D 43
    ptr=min(nstd+nextra-1,MAX_PROC);
E 43
I 43
    ptr=MIN(nstd+nextra-1,MAX_PROC);
E 43
  }

D 28
  proc_info[ptr].id=strdup(id);
  proc_info[ptr].node=strdup(node);
  proc_info[ptr].srvnode=strdup(srvnode);
  proc_info[ptr].name=strdup(name);
E 28
I 28
D 30
  proc_info[ptr].id=id;
  proc_info[ptr].node=node;
  proc_info[ptr].srvnode=srvnode;
  proc_info[ptr].name=name;
E 28
  proc_info[ptr].nevt_rec=nevt_rec;
  proc_info[ptr].rec_rate=rec_rate;
  proc_info[ptr].nevt_proc=nevt_proc;
  proc_info[ptr].proc_rate=proc_rate;
  proc_info[ptr].flag=flag;
D 28
  proc_info[ptr].source=strdup(source);
E 28
I 28
  proc_info[ptr].source=source;
E 30
I 30
  strcpy(proc_info[ptr].id,id);
  strcpy(proc_info[ptr].node,node);
  strcpy(proc_info[ptr].srvnode,srvnode);
  strcpy(proc_info[ptr].name,name);
  proc_info[ptr].nevt_rec  = nevt_rec;
  proc_info[ptr].rec_rate  = rec_rate;
  proc_info[ptr].nevt_proc = nevt_proc;
  proc_info[ptr].proc_rate = proc_rate;
  proc_info[ptr].flag      = flag;
  strcpy(proc_info[ptr].source,source);
E 30
E 28
  

  return;
}


//------------------------------------------------------------------


void print_results() {

  int i;
I 16
D 30
  char *t;
E 30
E 16


D 30
  if(no_print==0) {
E 30
I 30
if(no_print==0) {
E 30
    cout.clear();
    cout.precision(2);
    cout.setf(ios::fixed);
    for(i=0; i<nstd+nextra; i++) {
D 4
      cout << setw(25) << proc_info[i].id << "  " << setw(8) << proc_info[i].node << "  " 
	   << setw(8) << proc_info[i].name << "  " 
	   << setw(8) << proc_info[i].srvnode << "  " << setw(8) << proc_info[i].nevt_rec << "  " 
	   << setw(9) << proc_info[i].rec_rate << "  "
	   << setw(8) << proc_info[i].nevt_proc << "  " << setw(9) << proc_info[i].proc_rate << "  "
	   << setw(4) << proc_info[i].flag << "  " << setw(8) 
E 4
I 4
D 6
      cout << setw(23) << proc_info[i].id << " " << setw(8) << proc_info[i].node << " " 
E 6
I 6
D 16
      cout << setw(26) << proc_info[i].id << " " << setw(8) << proc_info[i].node << " " 
E 16
I 16
D 30
      t=strdup(proc_info[i].id);
D 29
      if(strlen(t)>26)t[26]='\0';
      cout << setw(26) << t << " " << setw(8) << proc_info[i].node << " " 
E 29
I 29
      if(strlen(t)>26)t[25]='\0';
      cout << setw(26) << t
E 30
I 30
      strcpy(temp,proc_info[i].id);
D 40
      if(strlen(temp)>26)temp[25]='\0';
      cout << setw(26) << temp
E 40
I 40
      if(strlen(temp)>30) temp[29]='\0';
      cout << setw(30) << temp
E 40
E 30
	   << " " << setw(8) << proc_info[i].node << " " 
E 29
E 16
E 6
	   << setw(8) << proc_info[i].name << " " 
D 11
	   << setw(8) << proc_info[i].srvnode << " " << setw(8) << proc_info[i].nevt_rec << " " 
E 11
I 11
	   << setw(8) << proc_info[i].srvnode << " " << setw(9) << proc_info[i].nevt_rec << " " 
E 11
	   << setw(9) << proc_info[i].rec_rate << " "
D 13
	   << setw(8) << proc_info[i].nevt_proc << " " << setw(9) << proc_info[i].proc_rate << " "
E 13
I 13
	   << setw(9) << proc_info[i].nevt_proc << " " << setw(9) << proc_info[i].proc_rate << " "
E 13
	   << setw(4) << proc_info[i].flag << " " << setw(8) 
E 4
	   << setiosflags(ios::left) << proc_info[i].source << resetiosflags(ios::left) << endl;
I 16
D 30
      free(t);
E 30
E 16
    }
  }


D 35
  if(no_file==0) {
E 35
I 35
  if(file!=0) {
E 35
    ofile->precision(2);
    ofile->setf(ios::fixed);
    for(i=0; i<nstd+nextra; i++) {
D 4
      *ofile << setw(25) << proc_info[i].id << "  " << setw(8) << proc_info[i].node << "  " 
	     << setw(8) << proc_info[i].name << "  " 
	     << setw(8) << proc_info[i].srvnode << "  " << setw(8) << proc_info[i].nevt_rec << "  " 
	     << setw(9) << proc_info[i].rec_rate << "  "
	     << setw(8) << proc_info[i].nevt_proc << "  " << setw(9) << proc_info[i].proc_rate << "  "
	     << setw(4) << proc_info[i].flag << "  " << setw(8) 
E 4
I 4
D 6
      *ofile << setw(23) << proc_info[i].id << " " << setw(8) << proc_info[i].node << " " 
E 6
I 6
D 29
      *ofile << setw(26) << proc_info[i].id << " " << setw(8) << proc_info[i].node << " " 
E 29
I 29
D 30
      t=strdup(proc_info[i].id);
      if(strlen(t)>26)t[25]='\0';
      *ofile << setw(26) << t
E 30
I 30
      strcpy(temp,proc_info[i].id);
D 40
      if(strlen(temp)>26)temp[25]='\0';
      *ofile << setw(26) << temp
E 40
I 40
      if(strlen(temp)>30)temp[29]='\0';
      *ofile << setw(30) << temp
E 40
E 30
	     << " " << setw(8) << proc_info[i].node << " " 
E 29
E 6
	     << setw(8) << proc_info[i].name << " " 
D 11
	     << setw(8) << proc_info[i].srvnode << " " << setw(8) << proc_info[i].nevt_rec << " " 
E 11
I 11
	     << setw(8) << proc_info[i].srvnode << " " << setw(9) << proc_info[i].nevt_rec << " " 
E 11
	     << setw(9) << proc_info[i].rec_rate << " "
D 13
	     << setw(8) << proc_info[i].nevt_proc << " " << setw(9) << proc_info[i].proc_rate << " "
E 13
I 13
	     << setw(9) << proc_info[i].nevt_proc << " " << setw(9) << proc_info[i].proc_rate << " "
E 13
	     << setw(4) << proc_info[i].flag << " " << setw(8) 
E 4
	     << setiosflags(ios::left) << proc_info[i].source << resetiosflags(ios::left) << endl;
I 29
D 30
      free(t);
E 30
E 29
    }
  }

  return;
}


//-----------------------------------------------------------------------


void send_info_server_msg() {


  // create message
D 21
D 26
  TipcMsg msg("info_server");
  msg.Dest("info_server/in/evt_status_monitor");
E 26
I 26
  TipcMsg msg((T_STR)"info_server");
  msg.Dest((T_STR)"info_server/in/evt_status_monitor");
E 26
E 21
I 21
  TipcMsg msg((T_STR)"info_server");
  msg.Dest((T_STR)"info_server/in/evt_status_monitor");
E 21


  // fill msg
D 21
D 26
  msg << "evt_status_monitor" << (T_INT4) nstd;
E 26
I 26
  msg << (T_STR)"evt_status_monitor" << (T_INT4) nstd;
E 26
E 21
I 21
  msg << (T_STR)"evt_status_monitor" << (T_INT4) nstd;
E 21
  for(int i=0; i<nstd; i++) {
    msg	<< proc_info[i].id << proc_info[i].node << proc_info[i].srvnode << proc_info[i].name
	<< proc_info[i].nevt_rec << proc_info[i].rec_rate 
	<< proc_info[i].nevt_proc << proc_info[i].proc_rate
	<< proc_info[i].flag << proc_info[i].source;
  }


  // send and flush
  server.Send(msg,TRUE);
  server.Flush();


  return;
}


//-----------------------------------------------------------------------
I 27


void status_poll_callback(T_IPC_MSG msg) {

  
  TipcMsgAppendStr(msg,(char*)"Number of broadcasts");
  TipcMsgAppendInt4(msg,nreq);

  return;
}


//-------------------------------------------------------------------
E 27
I 3


void quit_callback(int sig) {
  
  // received signal or quit control command
  cout << "...stopping, received signal: " << sig << endl;
  done=1;
  
  return;
}


//----------------------------------------------------------------------
E 3


void decode_command_line(int argc, char **argv) {

D 21
D 26
  char *help ="\nusage:\n\n   evt_status_monitor [-a application] [-once] [-p pause_time] [-w wait_time] [-no_broadcast] [-no_print] [-no_info] [-no_file]\n\n";
E 26
I 26
D 35
  const char *help ="\nusage:\n\n   evt_status_monitor [-a application] [-once] [-p pause_time] [-w wait_time] [-no_broadcast] [-no_print] [-no_info] [-no_file]\n\n";
E 35
I 35
D 36
  const char *help ="\nusage:\n\n   evt_status_monitor [-a application] [-once] [-p pause_time] [-w wait_time] [-broadcast] [-no_print] [info] [-file]\n\n";
E 36
I 36
  const char *help ="\nusage:\n\n   evt_status_monitor [-a application] [-once] [-p pause_time] [-w wait_time] [-broadcast] [-no_print] [-info] [-file]\n\n";
E 36
E 35
E 26
E 21
I 21
  const char *help ="\nusage:\n\n   evt_status_monitor [-a application] [-once] [-p pause_time] [-w wait_time] [-no_broadcast] [-no_print] [-no_info] [-no_file]\n\n";
E 21
  int i=1;

  while(i<argc) {
    
    if(strncasecmp(argv[i],"-h",2)==0) {
      printf("%s", help);
      exit(EXIT_SUCCESS);
    } 
D 35
    else if (strncasecmp(argv[i],"-no_broadcast",13)==0) {
      no_broadcast=1;
E 35
I 35
    else if (strncasecmp(argv[i],"-broadcast",10)==0) {
      broadcast=1;
E 35
      i=i+1;
    }
    else if (strncasecmp(argv[i],"-no_print",9)==0) {
      no_print=1;
      i=i+1;
    }
D 35
    else if (strncasecmp(argv[i],"-no_info",8)==0) {
      no_info=1;
E 35
I 35
    else if (strncasecmp(argv[i],"-info",5)==0) {
      info=1;
E 35
      i=i+1;
    }
D 35
    else if (strncasecmp(argv[i],"-no_file",8)==0) {
      no_file=1;
E 35
I 35
    else if (strncasecmp(argv[i],"-file",5)==0) {
      file=1;
E 35
      i=i+1;
    }
    else if (strncasecmp(argv[i],"-once",5)==0) {
      once=1;
      i=i+1;
    }
    else if (strncasecmp(argv[i],"-a",2)==0) {
      application=strdup(argv[i+1]);
      i=i+2;
    }
    else if (strncasecmp(argv[i],"-w",2)==0) {
      wait_time=atoi(argv[i+1]);
      i=i+2;
    }
    else if (strncasecmp(argv[i],"-p",2)==0) {
      pause_time=atoi(argv[i+1]);
      i=i+2;
    }
    else {
      printf("Unknown command line arg: %s\n",argv[i]);
      i=i+1;
    }
  }
}


//-------------------------------------------------------------------
E 1
