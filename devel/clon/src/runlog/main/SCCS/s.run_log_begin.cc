h32518
s 00002/00002/01400
d D 1.74 10/03/19 13:22:21 boiarino 84 83
c remove dead channel
c 
e
s 00006/00002/01396
d D 1.73 10/03/19 13:08:57 boiarino 83 82
c remove dead channels
c 
e
s 00036/00002/01362
d D 1.72 10/03/19 11:39:35 boiarino 82 81
c add some channels on g9frost request
c 
e
s 00249/00025/01115
d D 1.71 10/03/19 11:30:54 boiarino 81 80
c add RTPC stuff
c 
e
s 00007/00000/01133
d D 1.70 09/11/04 18:08:48 boiarino 80 79
c *** empty log message ***
e
s 00002/00001/01131
d D 1.69 09/06/16 17:46:50 boiarino 79 78
c *** empty log message ***
e
s 00006/00004/01126
d D 1.68 09/06/03 15:45:31 boiarino 78 77
c *** empty log message ***
e
s 00001/00001/01129
d D 1.67 09/06/03 12:04:28 boiarino 77 76
c *** empty log message ***
e
s 00282/00039/00848
d D 1.66 09/06/03 11:53:38 boiarino 76 75
c *** empty log message ***
e
s 00003/00000/00884
d D 1.65 09/06/01 11:52:34 boiarino 75 74
c *** empty log message ***
e
s 00036/00019/00848
d D 1.64 09/04/30 16:10:51 boiarino 74 73
c uncomment run_log_polar, fix polar_db_name
c 
e
s 00073/00051/00794
d D 1.63 07/11/06 13:25:18 boiarino 73 72
c bugs fixed
c 
e
s 00162/00198/00683
d D 1.62 07/10/29 10:47:36 boiarino 72 71
c migrate from cdev to ca
c change 'epics_val' and 'polar_epics_val' type from 'double' to 'float'
c 
e
s 00003/00003/00878
d D 1.61 02/08/27 13:36:09 wolin 71 70
c New ped names, etc
e
s 00039/00025/00842
d D 1.60 02/06/12 14:48:51 wolin 70 69
c Accept all of file name after parms/
e
s 00004/00003/00863
d D 1.59 01/02/13 12:40:40 wolin 69 68
c Fixed parsing of ts registers
e
s 00005/00005/00861
d D 1.58 01/02/13 09:53:18 wolin 68 67
c istrstream >> no longer can parse hex!
e
s 00056/00055/00810
d D 1.57 01/02/01 14:37:05 wolin 67 58
i 66
c Accepted child's version in workspace "/usr/local/clas/devel/source".
c 
e
s 00011/00003/00855
d D 1.55.1.3 01/01/30 14:25:05 wolin 66 65
c Added and RVAL
e
s 00007/00007/00851
d D 1.55.1.2 01/01/03 10:59:21 wolin 65 64
c is_open()
e
s 00049/00048/00809
d D 1.55.1.1 00/12/07 10:46:52 wolin 64 57
i 63
c Accepted child's version in workspace "/usr/local/clas/devel/source".
c 
e
s 00001/00001/00857
d D 1.54.1.2 00/12/06 12:57:09 wolin 63 62
c beam_polarization_error is new name
e
s 00049/00048/00809
d D 1.54.1.1 00/12/05 16:55:52 wolin 62 56
i 61
c Accepted child's version in workspace "/usr/local/clas/devel/source".
c 
e
s 00001/00001/00857
d D 1.53.1.4 00/12/05 15:11:28 wolin 61 60
c torus_current
e
s 00001/00001/00857
d D 1.53.1.3 00/10/27 09:52:16 wolin 60 59
c const...
e
s 00003/00003/00855
d D 1.53.1.2 00/10/27 09:50:32 wolin 59 55
c const
e
s 00011/00003/00854
d D 1.56 00/12/12 13:21:24 wolin 58 57
c Another RVAL needed in epics
e
s 00001/00001/00856
d D 1.55 00/12/06 12:56:35 wolin 57 56
c beam_polarization_error is new name
e
s 00001/00001/00856
d D 1.54 00/12/05 15:15:57 wolin 56 54
c torus_current
e
s 00045/00044/00813
d D 1.53.1.1 00/10/27 09:49:19 wolin 55 54
c const
e
s 00010/00008/00847
d D 1.53 00/10/11 16:44:55 wolin 54 53
c Sending polar to datastream and to ipc
e
s 00080/00109/00775
d D 1.52 00/10/11 16:35:17 wolin 53 52
c Write polar data to file, removed -polar flag
e
s 00001/00001/00883
d D 1.51 00/10/04 09:58:42 wolin 52 51
c Added epics channel names
e
s 00013/00002/00871
d D 1.50 00/09/28 14:34:24 wolin 51 50
c Now can get other than VAL
e
s 00005/00005/00868
d D 1.49 00/09/27 13:20:42 wolin 50 49
c Typo in polar epics channel names, order messed up
e
s 00323/00208/00550
d D 1.48 00/09/26 14:47:33 wolin 49 48
c Added run_log_polar
e
s 00022/00022/00736
d D 1.47 00/09/08 13:12:42 wolin 48 47
c New clon_root
e
s 00001/00001/00757
d D 1.46 99/09/09 15:15:57 wolin 47 46
c IPM2C22A renamed to IPM2C21A
c 
e
s 00004/00004/00754
d D 1.45 99/08/31 09:58:50 wolin 46 45
c Do file first
c 
e
s 00001/00001/00757
d D 1.44 99/08/27 16:21:01 wolin 45 44
c Should not have added scaler_calc1...removed
c 
e
s 00001/00001/00757
d D 1.43 99/08/27 13:29:43 wolin 44 43
c Added scaler_calc1 to list
c 
e
s 00001/00001/00757
d D 1.42 99/05/05 15:53:57 wolin 43 42
c Increased pend to 6 sec
c 
e
s 00025/00099/00733
d D 1.41 99/03/11 13:19:10 wolin 42 41
c Uses ipcbank2et instead of dd
c 
e
s 00003/00003/00829
d D 1.40 99/01/22 13:31:52 wolin 41 40
c Fixes for info_server
c 
e
s 00003/00004/00829
d D 1.39 99/01/11 15:34:18 wolin 40 39
c Fixed info_server msg
c 
e
s 00105/00072/00728
d D 1.38 98/11/13 14:54:02 wolin 39 38
c Updated for polar
c 
e
s 00003/00002/00797
d D 1.37 98/05/28 13:23:17 wolin 38 37
c Fixed timer[5] bug, using -9999 for missing epics channels
c 
e
s 00001/00001/00798
d D 1.36 98/05/12 11:25:02 wolin 37 36
c Epics channels
c 
e
s 00003/00016/00796
d D 1.35 98/05/07 17:18:07 clasrun 36 35
c Typo in epics channel name
c 
e
s 00002/00003/00810
d D 1.34 98/05/07 10:45:29 wolin 35 34
c New epics channels
c 
e
s 00005/00005/00808
d D 1.33 98/05/06 15:30:13 wolin 34 33
c Uses new pedman scheme
c 
e
s 00001/00001/00812
d D 1.32 98/03/30 17:22:49 wolin 33 32
c Switched from MT,TM set currents to readbacks
c 
e
s 00001/00001/00812
d D 1.31 98/03/06 14:14:15 wolin 32 31
c Using 0,0,0,0 for dd ctl words
c 
e
s 00009/00009/00804
d D 1.30 98/02/21 00:57:23 clasrun 31 30
c Temp eliminated BREP bank (ejw)
c 
e
s 00026/00018/00787
d D 1.29 98/02/13 17:30:49 wolin 30 29
c Bombproofed reading pretrig files
c 
e
s 00001/00002/00804
d D 1.28 98/02/13 16:27:06 wolin 29 28
c More doc mods
c 
e
s 00000/00001/00806
d D 1.27 98/02/13 16:22:21 wolin 28 27
c Doc mods
c 
e
s 00003/00001/00804
d D 1.26 98/02/13 15:58:47 wolin 27 26
c fixed ec discriminator ordering
c 
e
s 00001/00029/00804
d D 1.25 98/02/11 17:30:01 wolin 26 25
c Removed mapmgr, now in bor2map
c 
e
s 00006/00002/00827
d D 1.24 98/02/11 16:09:43 wolin 25 24
c Most epics channels now working
c 
e
s 00012/00003/00817
d D 1.23 98/02/09 11:51:10 wolin 24 23
c Added current_run_session.txt again, needed by elogbook (temporary)
c 
e
s 00044/00039/00776
d D 1.22 98/01/20 11:48:32 wolin 23 22
c Minor mods, seems to be working ok
c 
e
s 00272/00160/00543
d D 1.21 98/01/19 16:00:09 wolin 22 21
c Major mods...new columns, callable DP_ask, etc.
c 
e
s 00130/00090/00573
d D 1.20 98/01/03 13:12:00 wolin 21 20
c Many improvements:  file, updated database stuff, etc...more to do
c 
e
s 00004/00004/00659
d D 1.19 97/12/10 04:39:44 clasrun 20 19
c Typo in BREP bank filling
c 
e
s 00002/00002/00661
d D 1.18 97/11/19 09:28:31 wolin 19 18
c New head bank scheme
c 
e
s 00023/00027/00640
d D 1.17 97/11/17 16:11:05 wolin 18 17
c create_header now has new args name1,name2
c 
e
s 00087/00054/00580
d D 1.16 97/08/19 17:06:46 wolin 17 16
c Added mapmanager calls
c 
e
s 00066/00046/00568
d D 1.15 97/06/24 13:19:17 wolin 16 15
c Almost finished pretrig,discr
e
s 00002/00002/00612
d D 1.14 97/06/02 12:15:07 wolin 15 14
c Now does l1 program name
e
s 00024/00024/00590
d D 1.13 97/05/30 13:20:54 wolin 14 13
c Channels mostly correct, still no cmlog
e
s 00079/00083/00535
d D 1.12 97/05/28 13:14:17 wolin 13 12
c No insert_msg, otherwise working with new epics channels, etc.
e
s 00009/00002/00609
d D 1.11 97/05/06 11:40:12 wolin 12 11
c Updated documentation
e
s 00053/00006/00558
d D 1.10 97/05/02 17:26:39 wolin 11 10
c Added get_prescale_factors
e
s 00010/00006/00554
d D 1.9 97/04/29 14:32:59 wolin 10 9
c Added l1_prog and l1_thresh
e
s 00002/00002/00558
d D 1.8 97/04/29 14:20:17 wolin 9 8
c Added slit pos and thermionic gun
e
s 00005/00003/00555
d D 1.7 97/04/18 13:39:49 wolin 8 7
c Redid current run file naming scheme
e
s 00044/00014/00514
d D 1.6 97/04/18 13:04:44 wolin 7 6
c Now writes out current_run.txt
e
s 00003/00003/00525
d D 1.5 97/04/15 13:50:19 wolin 6 5
c Added beam current channels
e
s 00021/00012/00507
d D 1.4 97/04/14 13:19:47 wolin 5 4
c Minor improvements, new epics names
e
s 00001/00001/00518
d D 1.3 97/04/10 17:40:50 wolin 4 3
c Typo
c 
e
s 00026/00014/00493
d D 1.2 97/04/10 13:32:29 wolin 3 1
c Minor cdev improvements, etc.
e
s 00000/00000/00000
d R 1.2 97/04/10 11:42:35 Codemgr 2 1
c SunPro Code Manager data about conflicts, renames, etc...
c Name history : 2 1 run_log/s/run_log_begin.cc
c Name history : 1 0 s/run_log_begin.cc
e
s 00507/00000/00000
d D 1.1 97/04/10 11:42:34 wolin 1 0
c Makes begin run logbook entry
e
u
U
f e 0
t
T
I 1
D 13
//
E 13
//  run_log_begin
//
D 22
//  collects and inserts run log begin info into database and datastream
E 22
I 22
D 49
//  collects and inserts run log begin info into database, datastream, info_server, and file
//  n.b. files all assume CLON prefix
I 40
//       changing epics channels requires changing info_server.cfg
E 40
E 22
//
E 49
I 49
//  collects and inserts run log begin info into database, datastream, info_server,
//     and file
E 49
//
I 76
// Usage: run_log_begin -a clasprod (from rcscript)
I 79
//        run_log_begin -a clasprod -debug (debugging)
E 79
//        run_log_begin -a clasprod -s clasprod -debug 59908 (if recovering and debugging)
//        run_log_begin -a clasprod -s clasprod 59908 (if recovering)
//
E 76
D 17
//  usage:
D 16
//     run_log_begin [-a application] [-u uniq_dgrp] [-i id_string] [-debug]
D 7
//                   [-d destination] [-t tk_script] [-m msql_database]
//                   [-s session]     [-no_dbr]      [-no_dd]  [-g gmd_time] [-c cdev_pend_time]
E 7
I 7
//                   [-d destination] [-t tk_script] [-m msql_database] [-f current_run_file]
//                   [-s session] [-no_dbr] [-no_dd] [-no_file] [-g gmd_time] [-c cdev_pend_time]
E 16
I 16
//   run_log_begin [-a application] [-u uniq_dgrp] [-i id_string] [-debug]
//                 [-d destination] [-t tk_script] [-m msql_database] 
//                 [-frun current_run_file] [-fpre current_pretrig_file] [-fdiscr current_discr_file]
//                 [-s session] [-no_dbr] [-no_dd] [-no_file] [-g gmd_time] [-c cdev_pend_time]
E 16
E 7
//
E 17
D 22
//      use -no_dbr to NOT insert data into database
//      use -no_dd  to NOT insert data into DD system
I 7
//      use -no_file  to NOT insert data into file
I 17
//      use -no_mapmgr to NOT insert data into map manager
E 17
E 7
//      use -debug to just dump SQL string to stdout
//
//
E 22
//   still to do:
I 27
D 29
//       *** order of pretrig data ***
E 27
I 24
//       epics channel names!
E 29
I 29
D 35
//       epics channel names
E 35
E 29
E 24
I 21
D 22
//       copy file to fileserver
//       epics values floats in database
E 21
I 18
//       lots of new columns 
D 21
//       epics values as floats
E 21
//       l1mask, trigger config file name, config file contents, etc.
E 18
I 16
D 17
//       epics channels
E 17
I 17
D 21
//       epics channels (torus voltage?)
E 17
E 16
//       get header ctl words, event class correct
E 21
D 13
//       bombproofing:  no msqld, etc.
E 13
I 13
D 18
//       insert_msg broken
E 18
I 16
D 17
//       finish discr,pretrig
E 17
I 17
//       use $CLON_PARMS
I 21
//       what if can't open file in insert_into_file
E 22
I 22
D 23
//       check ts reg offsets
E 23
//       tagger trigger words
I 31
D 36
//       reinstate BREP bank
E 36
E 31
E 22
E 21
D 18
//       epics values as floats
E 18
E 17
E 16
E 13
//
D 31
//
E 31
D 12
//  ejw, 20-mar-97
E 12
I 12
D 21
//   Note...currently stores:
//      coda:    run, time, session, config
D 13
//      epics:   beam energy, current, magnet currents and voltages, cryo p and t, beamline vac
//      online:  file names for ts, l1, l1thresh, discr, sparsification threshholds  
//               8 ts prescale factors
E 13
I 13
//      epics:   beam energy, current, magnet currents and voltages, cryo p and t, beam and tgt vac
D 16
//      online:  file names for ts, l1, l1hresh, discr, sparsification threshholds  
E 16
I 16
//      online:  file names for ts, l1 prog, pretrig, discr, sparsification threshholds  
E 16
//               8 ts prescale factors, etc.
E 13
//
//
//  ejw, 6-may-97
E 21
I 21
D 22
//  ejw, 3-jan-98
E 22
I 22
D 36
//  ejw, 19-jan-98
E 36
I 36
D 49
//  ejw, 7-may-98
E 49
I 49
//  ejw, 21-sep-2000
I 72
// sergey 29-oct-2007 migrate from cdev to ca
//   also 'epics_val' and 'polar_epics_val' are 'float' now, they were 'double' - is it Ok ?????
I 77
// sergey may 2009 added recovery mode
E 77
I 75
//
D 77
// NEED TO ADD RECOVERY MODE (a la run_log_end)
E 77
//
E 75
E 72
E 49
E 36
E 22
E 21
E 12

I 80
D 81

/*
#define FILL_RTPC
*/

E 81
E 80
D 72

E 72
// for posix
#define _POSIX_SOURCE_ 1
#define __EXTENSIONS__


D 14
// sql string and DD buffer sizes
#define DDBUFFERSIZE  1200     // longwords
E 14
I 14
D 42
// DD buffer size
D 21
#define DDBUFFERSIZE  2000     // longwords
E 21
I 21
#define DDBUFFERSIZE  4000     // longwords
E 21
E 14


E 42
// system stuff
I 72

using namespace std;
#include <strstream>

E 72
#include <iostream.h>
I 22
#include <iomanip.h>
E 22
I 5
#include <fstream.h>
E 5
D 72
#include <strstream.h>
E 72
I 11
#include <sys/types.h>
#include <unistd.h>
E 11


D 72
// for cdev
#include <cdev.h>
#include <cdevData.h>
#include <cdevDevice.h>
#include <cdevRequestObject.h>
#include <cdevSystem.h>


E 72
// for ipc
#include <rtworks/cxxipc.hxx>


// online and coda stuff
D 49
extern "C"{
E 49
I 49
extern "C" {
E 49
#include <clas_ipc_prototypes.h>
D 42
#include <dd_user.h>
E 42
D 13
#include <msql.h>
E 13
}

I 72
#include "epicsutil.h"
E 72

I 74

E 74
D 21
// for record segment header
static int nevnt  = 0;
static int nphys  = 0;
D 17
static int trig   = 17;               // fpack class, 17 for prestart event, 0 for normal event, etc.
E 17
I 17
static int trig   = 0;
E 17


// constants for head bank
static int nvers  = 0;
D 17
static int type   = 1;
E 17
I 17
D 19
static int type   = 0;
E 19
I 19
static int type   = 100;
E 19
E 17
static int rocst  = 0;
D 17
static int evcls  = 17;               // fpack class again?
static int presc  = 1;
E 17
I 17
static int evcls  = 0;
D 19
static int presc  = 100;
E 19
I 19
static int presc  = 0;
E 19
E 17


E 21
D 42
// DD event control words
D 32
static int ddctl[4] = {-1,-1,-1,-1};
E 32
I 32
static int ddctl[4] = {0,0,0,0};
E 32


E 42
// flags to inhibit event recording, etc.
D 7
static int no_dbr = 0;
static int no_dd  = 0;
static int debug  = 0;
E 7
I 7
D 17
static int no_dbr  = 0;
static int no_dd   = 0;
static int no_file = 0;
static int debug   = 0;
E 17
I 17
static int no_dbr    = 0;
I 22
static int no_info   = 0;
E 22
D 42
static int no_dd     = 0;
E 42
I 42
static int no_data   = 0;
E 42
static int no_file   = 0;
D 26
static int no_mapmgr = 0;
E 26
static int debug     = 0;
E 17
E 7


D 21
// parameters resettable on command line
D 7
static char *application    = "clastest";
static char *uniq_dgrp      = "run_log_begin";
static char *id_string      = "run_log_begin";
static char *dest           = "dbrouter";
static char *msql_database  = "clasrun";
static char *session        =  getenv("DD_NAME");
E 7
I 7
static char *application       = "clastest";
static char *uniq_dgrp         = "run_log_begin";
static char *id_string         = "run_log_begin";
static char *dest              = "dbrouter";
static char *msql_database     = "clasrun";
static char *session           =  getenv("DD_NAME");
static char *config;
D 8
static char *current_run_file  = "/usr/local/clas/parms/run_log/current_run.txt";
E 8
I 8
D 16
static char *current_run_file  = "/usr/local/clas/parms/run_log/current_run_%s.txt";
E 16
I 16
D 17
static char *current_run_file      = "/usr/local/clas/parms/run_log/current_run_%s.txt";
static char *current_pretrig_file  = "/usr/local/clas/parms/pretrigger/current_pretrig_%s.txt";
static char *current_discr_file    = "/usr/local/clas/parms/discr/current_discr_%s.txt";
E 17
I 17
static char *current_run_name      = "/usr/local/clas/parms/run_log/current_run_%s.txt";
static char *current_pretrig_name  = "/usr/local/clas/parms/pretrigger/current_pretrig.txt";
static char *current_discr_name    = "/usr/local/clas/parms/discr/current_discr.txt";
E 21
I 21
// control params
D 42
static char *session           	   =  getenv("DD_NAME");
E 42
I 42
D 76
static char *session           	   =  NULL;
E 42
D 49
static char *application       	   = "clastest";
E 49
I 49
D 55
D 62
D 64
D 67
static char *project       	   = "clastest";
E 49
I 39
D 53
static int polar                   = 0;
E 53
E 39
D 49
static char *uniq_dgrp         	   = "run_log_begin";
E 49
I 49
static char *uniq_subj         	   = "run_log_begin";
E 49
static char *id_string         	   = "run_log_begin";
D 49
static char *dest              	   = "dbrouter";
E 49
static char *msql_database     	   = "clasrun";
E 67
I 67
static char *project       	   = (char*)"clastest";
E 76
I 76
static char *application       	   = (char*)"clastest";
E 76
static char *uniq_subj         	   = (char*)"run_log_begin";
static char *id_string         	   = (char*)"run_log_begin";
static char *msql_database     	   = (char*)"clasrun";
I 76
static char session[50]          = "";
E 76
E 67
E 64
I 64
static char *project       	   = (char*)"clastest";
static char *uniq_subj         	   = (char*)"run_log_begin";
static char *id_string         	   = (char*)"run_log_begin";
static char *msql_database     	   = (char*)"clasrun";
E 64
E 62
I 62
static char *project       	   = (char*)"clastest";
static char *uniq_subj         	   = (char*)"run_log_begin";
static char *id_string         	   = (char*)"run_log_begin";
static char *msql_database     	   = (char*)"clasrun";
E 62
E 55
I 55
static char *project       	   = (char*)"clastest";
static char *uniq_subj         	   = (char*)"run_log_begin";
static char *id_string         	   = (char*)"run_log_begin";
static char *msql_database     	   = (char*)"clasrun";
E 55
D 22
static char *archive_file_name 	   = "/usr/local/clas/parms/run_log/archive/begin_%s_%06d.txt";
static char *pretrig_file_name 	   = "/usr/local/clas/parms/pretrigger/archive/pretrig_%s_%06d.txt";
E 21
static char *current_tsfile_name   = "/usr/local/clas/parms/ts/ts_file.txt";
static char *current_l1prog_name   = "/usr/local/clas/parms/ts/Current.Config";
static char *current_presc_name    = "/usr/local/clas/parms/ts/current_prescale.txt";
D 21
static char *get_prescale_factors  = "/usr/local/clas/bin/get_prescale_factors";
E 21
I 18
static char *get_ts_l1mask         = "/usr/local/clas/bin/get_ts_l1mask";
E 18
D 21
static char *discr_manager         = "/usr/local/clas/bin/discr_manager";
E 21
static char *croc06_spar_name      = "/usr/local/clas/parms/initfiles/croc06.spar";
static char *croc07_spar_name      = "/usr/local/clas/parms/initfiles/croc07.spar";
static char *croc08_spar_name      = "/usr/local/clas/parms/initfiles/croc08.spar";
static char *croc11_spar_name      = "/usr/local/clas/parms/initfiles/croc11.spar";
static char *croc19_spar_name      = "/usr/local/clas/parms/initfiles/croc19.spar";
static char *mapmgr_file_name      = "/usr/local/clas/parms/Maps/RUN_CONTROL.map";
E 17
E 16
E 8
E 7
D 20
static int gmd_time         =  5;
static int cdev_pend_time   =  5;
E 20
I 20
static int gmd_time         =  3;
static int cdev_pend_time   =  3;
E 22
I 22
static int gmd_time                =  3;
I 76
static int filep               	 = 0;
E 76
D 43
static int cdev_pend_time          =  3;   
E 43
I 43
D 72
static int cdev_pend_time          =  6;
E 72
E 43
E 22
E 20

I 49

E 49
I 22
// file names
D 48
static char *archive_file_name 	   = "parms/run_log/archive/begin_%s_%06d.txt";
static char *pretrig_file_name 	   = "parms/pretrigger/archive/pretrig_%s_%06d.txt";
static char *current_trigger_name  = "parms/trigger/current_trig_config.txt";
static char *current_channel_name  = "parms/channel/current_channel_config.txt";
static char *current_tsfile_name   = "parms/ts/ts_file.txt";
static char *current_l1prog_name   = "parms/ts/Current.Config";
D 34
static char *sc_spar_name          = "parms/initfiles/croc06.spar";
static char *cc_spar_name          = "parms/initfiles/croc07.spar";
static char *ec1_spar_name         = "parms/initfiles/croc08.spar";
static char *ec2_spar_name         = "parms/initfiles/croc11.spar";
static char *lac_spar_name         = "parms/initfiles/croc19.spar";
E 34
I 34
static char *sc_spar_name          = "parms/pedman/archive/sc.ped";
static char *cc_spar_name          = "parms/pedman/archive/cc.ped";
static char *ec1_spar_name         = "parms/pedman/archive/ec1.ped";
static char *ec2_spar_name         = "parms/pedman/archive/ec2.ped";
static char *lac_spar_name         = "parms/pedman/archive/lac.ped";
E 48
I 48
D 55
D 62
D 64
D 67
static char *archive_file_name 	   = "run_log/archive/begin_%s_%06d.txt";
static char *pretrig_file_name 	   = "pretrigger/archive/pretrig_%s_%06d.txt";
static char *current_trigger_name  = "trigger/current_trig_config.txt";
static char *current_channel_name  = "channel/current_channel_config.txt";
static char *current_tsfile_name   = "ts/ts_file.txt";
static char *current_l1prog_name   = "ts/Current.Config";
static char *sc_spar_name          = "pedman/archive/sc.ped";
static char *cc_spar_name          = "pedman/archive/cc.ped";
static char *ec1_spar_name         = "pedman/archive/ec1.ped";
static char *ec2_spar_name         = "pedman/archive/ec2.ped";
static char *lac_spar_name         = "pedman/archive/lac.ped";
E 67
I 67
static char *archive_file_name 	   = (char*)"run_log/archive/begin_%s_%06d.txt";
static char *pretrig_file_name 	   = (char*)"pretrigger/archive/pretrig_%s_%06d.txt";
static char *current_trigger_name  = (char*)"trigger/current_trig_config.txt";
static char *current_channel_name  = (char*)"channel/current_channel_config.txt";
static char *current_tsfile_name   = (char*)"ts/ts_file.txt";
static char *current_l1prog_name   = (char*)"ts/Current.Config";
D 71
static char *sc_spar_name          = (char*)"pedman/archive/sc.ped";
static char *cc_spar_name          = (char*)"pedman/archive/cc.ped";
E 71
I 71
static char *sc_spar_name          = (char*)"pedman/archive/sc1.ped";
static char *cc_spar_name          = (char*)"pedman/archive/cc1.ped";
E 71
static char *ec1_spar_name         = (char*)"pedman/archive/ec1.ped";
static char *ec2_spar_name         = (char*)"pedman/archive/ec2.ped";
D 71
static char *lac_spar_name         = (char*)"pedman/archive/lac.ped";
E 71
I 71
static char *lac_spar_name         = (char*)"pedman/archive/lac1.ped";
E 71
E 67
E 64
I 64
static char *archive_file_name 	   = (char*)"run_log/archive/begin_%s_%06d.txt";
static char *pretrig_file_name 	   = (char*)"pretrigger/archive/pretrig_%s_%06d.txt";
static char *current_trigger_name  = (char*)"trigger/current_trig_config.txt";
static char *current_channel_name  = (char*)"channel/current_channel_config.txt";
static char *current_tsfile_name   = (char*)"ts/ts_file.txt";
static char *current_l1prog_name   = (char*)"ts/Current.Config";
static char *sc_spar_name          = (char*)"pedman/archive/sc.ped";
static char *cc_spar_name          = (char*)"pedman/archive/cc.ped";
static char *ec1_spar_name         = (char*)"pedman/archive/ec1.ped";
static char *ec2_spar_name         = (char*)"pedman/archive/ec2.ped";
static char *lac_spar_name         = (char*)"pedman/archive/lac.ped";
E 64
E 62
I 62
static char *archive_file_name 	   = (char*)"run_log/archive/begin_%s_%06d.txt";
static char *pretrig_file_name 	   = (char*)"pretrigger/archive/pretrig_%s_%06d.txt";
static char *current_trigger_name  = (char*)"trigger/current_trig_config.txt";
static char *current_channel_name  = (char*)"channel/current_channel_config.txt";
static char *current_tsfile_name   = (char*)"ts/ts_file.txt";
static char *current_l1prog_name   = (char*)"ts/Current.Config";
static char *sc_spar_name          = (char*)"pedman/archive/sc.ped";
static char *cc_spar_name          = (char*)"pedman/archive/cc.ped";
static char *ec1_spar_name         = (char*)"pedman/archive/ec1.ped";
static char *ec2_spar_name         = (char*)"pedman/archive/ec2.ped";
static char *lac_spar_name         = (char*)"pedman/archive/lac.ped";
E 62
E 55
I 55
static char *archive_file_name 	   = (char*)"run_log/archive/begin_%s_%06d.txt";
static char *pretrig_file_name 	   = (char*)"pretrigger/archive/pretrig_%s_%06d.txt";
static char *current_trigger_name  = (char*)"trigger/current_trig_config.txt";
static char *current_channel_name  = (char*)"channel/current_channel_config.txt";
static char *current_tsfile_name   = (char*)"ts/ts_file.txt";
static char *current_l1prog_name   = (char*)"ts/Current.Config";
static char *sc_spar_name          = (char*)"pedman/archive/sc.ped";
static char *cc_spar_name          = (char*)"pedman/archive/cc.ped";
static char *ec1_spar_name         = (char*)"pedman/archive/ec1.ped";
static char *ec2_spar_name         = (char*)"pedman/archive/ec2.ped";
static char *lac_spar_name         = (char*)"pedman/archive/lac.ped";
E 55
E 48
E 34
D 26
static char *mapmgr_file_name      = "parms/Maps/RUN_CONTROL.map";
E 26
E 22

I 22

E 22
I 21
//  run start data
int run;
D 76
static char *config;
E 76
I 76
static char config[30] = "";
static char *configin;
E 76
static char startdate[30];
I 22
D 23
static int ts_csr,ts_control,ts_roc_enable,ts_synch,ts_timer[5];
E 23
I 23
D 39
static unsigned long ts_csr,ts_control,ts_roc_enable,ts_synch,ts_timer[5];
E 39
I 39
static unsigned long ts_csr=0,ts_control=0,ts_roc_enable=0,ts_synch=0,ts_timer[5];
E 39
E 23
E 22
static int prescale[8];
D 22
static int l1mask;
static char ts_file[100], l1_prog[100];
static char croc06_spar[100], croc07_spar[100], croc08_spar[100], croc11_spar[100], croc19_spar[100];
static int pretrig_data[12];
E 22
I 22
static char ts_file[100], l1_prog[120], trigger_config[80], channel_config[80];
static char sc_spar[100], cc_spar[100], ec1_spar[100], ec2_spar[100], lac_spar[100];
D 30
static int ec_inner_hi,ec_inner_lo,ec_outer_hi,ec_outer_lo,ec_total_hi,ec_total_lo;
static int cc_hi,cc_lo;
static int sc_thresh,sc_width;
E 30
I 30
static int ec_inner_hi=0,ec_inner_lo=0,ec_outer_hi=0,ec_outer_lo=0,ec_total_hi=0,ec_total_lo=0;
static int cc_hi=0,cc_lo=0;
static int sc_thresh=0,sc_width=0;
I 49
static unsigned long ts_reg[128];
E 49
E 30
E 22


E 21
D 49
// epics channel names, etc.
E 49
I 49
// run_log_begin epics channel names, etc.
E 49
D 3
char *epics_chan[] = {"MBSY2C_energy", "scaler","TMSETI","TMVRBCK","MTSETI","MTVRBCK"};
char *epics_name[] = {"beam_energy", "scaler", "tagger_current", "tagger_voltage",
		      "mini_current", "mini_voltage",
		      "beam_energy", "beam_slit", "beam_ion_current",
		      "torus_current", "torus_voltage",
		      "mini_current", "mini_voltage",
		      "tagger_current", "tagger_voltage",
		      "cryo_pressure", "cryo_temperature",
		      "beam_tgt_vac"};
E 3
I 3
D 6
char *db_name[] = {"beam_energy", "beam_slit", "beam_ion_current",
E 6
I 6
D 9
char *db_name[] = {"beam_energy", "hallb_slit_position", "gun_control_electrode","laser_optical_amplitude",
E 9
I 9
D 14
char *db_name[] = {"beam_energy", "slit_position", "thermionic_gun","polarized_gun",
E 14
I 14
D 22
static char *db_name[] = {"beam_energy", "slit_position", "thermionic_gun","polarized_gun",
E 14
E 9
E 6
D 18
		   "torus_current", "torus_voltage",
E 18
I 18
		   "torus_current",
E 18
		   "mini_current", "mini_voltage",
		   "tagger_current", "tagger_voltage",
D 14
		   "cryo_pressure", "cryo_temperature",
E 14
I 14
		   "cryo_pressure", "cryo_temperature", "cryo_status",
E 14
D 13
		   "beam_tgt_vac"};
E 13
I 13
		   "upstream_beam_vac","target_vac",
E 22
I 22
D 55
D 62
D 64
D 67
static char *db_name[] = {
E 67
I 67
D 72
static const char *db_name[] = {
E 67
E 64
I 64
static const char *db_name[] = {
E 64
E 62
I 62
static const char *db_name[] = {
E 62
E 55
I 55
static const char *db_name[] = {
E 55
  "beam_energy", "thermionic_gun","polarized_gun",
  "a_slit_position", "b_slit_position", "c_slit_position", "radiator_position",
  "torus_current", "mini_current", "mini_voltage", "tagger_current", "tagger_voltage",
  "cryo_pressure", "cryo_temperature", "cryo_status",
  "upstream_beam_vac","target_vac",
  "halo_up_up", "halo_up_down", "halo_up_left", "halo_up_right", 
  "halo_down_up", "halo_down_down", "halo_down_left", "halo_down_right", 
D 25
  "bpm_1_x", "bpm_1_y", "bpm_1_i", "bpm_2_x", "bpm_2_y", "bpm_2_i", "bpm_3_x", "bpm_3_y", "bpm_3_i",
E 25
I 25
  "bpm_1_x", "bpm_1_y", "bpm_1_i",
  "bpm_2_x", "bpm_2_y", "bpm_2_i", 
  "bpm_3_x", "bpm_3_y", "bpm_3_i",
E 72
I 72
static char *db_name[] = {
  "beam_energy",
D 73
  "thermionic_gun",
E 73
I 73
  /*"thermionic_gun",*/
E 73
  "polarized_gun",
  "a_slit_position",
  "b_slit_position",
  "c_slit_position",
D 73
  "radiator_position",
E 73
I 73
  /*"radiator_position",*/
E 73
  "torus_current",
  "mini_current",
  "mini_voltage",
  "tagger_current",
  "tagger_voltage",
D 73
  "cryo_pressure",
  "cryo_temperature",
  "cryo_status",
E 73
I 73

  /*"cryo_pressure",*/ /*timeout or zero*/
  /*"cryo_temperature",*/ /*timeout or zero*/
  /*"cryo_status",*/ /*timeout or zero*/

E 73
  "upstream_beam_vac",
  "target_vac",
  "halo_up_up",
  "halo_up_down",
  "halo_up_left",
  "halo_up_right", 
  "halo_down_up",
  "halo_down_down",
  "halo_down_left",
  "halo_down_right", 
  "bpm_1_x",
  "bpm_1_y",
  "bpm_1_i",
  "bpm_2_x",
  "bpm_2_y",
  "bpm_2_i", 
  "bpm_3_x",
  "bpm_3_y",
D 73
  "bpm_3_i",
E 73
I 73
D 82
  "bpm_3_i"
E 82
I 82
  "bpm_3_i",

  /*since g9frost*/
  "helicity_clock",
  "helicity_t_settle",
  "helicity_t_stable",
  "helicity_delay",
  "helicity_pattern",
  "helicity_frequency",
  "helicity_wien_angle_zy",
  "helicity_wien_angle_yx",
  "helicity_wien_angle_zx",
  "helicity_half_wave_plate",
  "nmr_polarization_lf",
  "magnet_current_lf",
  "cohbrems_edge",
  "cohbrems_plane",
  "cohbrems_radiator"
E 82
E 73
E 72
E 25
E 22
};
E 13
D 22

D 6
char *epics_chan[] = {"MBSY2C_energy", "scaler", "scaler",
E 6
I 6
D 9
char *epics_chan[] = {"MBSY2C_energy", "scaler", "scaler", "scaler",
E 9
I 9
D 14
char *epics_chan[] = {"MBSY2C_energy", "SMRPOSB", "IGT0I00BIASET", "scaler",
E 14
I 14
D 17
static char *epics_chan[] = {"MBSY2C_energy", "SMRPOSB", "IGT0I00BIASET", "scaler",
E 14
E 9
E 6
D 16
		      "scaler", "scaler",
E 16
I 16
		      "hallb_sf_xy560_0_5", "scaler",
E 17
I 17
static char *epics_chan[] = {"MBSY2C_energy", "SMRPOSB", "IGT0I00BIASET", "unknown",
D 18
		      "hallb_sf_xy560_0_5", "unknown",
E 18
I 18
		      "hallb_sf_xy560_0_5",
E 18
E 17
E 16
		      "MTSETI", "MTVRBCK",
		      "TMSETI", "TMVRBCK",
D 5
		      "scaler", "scaler",
E 5
I 5
D 14
		      "pressure", "temperature",
E 14
I 14
		      "B_cryotarget_pressure", "B_cryotarget_temperature", "B_cryotarget_status",
E 14
E 5
D 13
                      "scaler"};

E 13
I 13
D 17
                      "scaler","scaler",
E 17
I 17
                      "unknown","unknown",
E 22
I 22
D 55
D 62
D 64
D 67
static char *epics_chan[] = {
E 67
I 67
D 72
static const char *epics_chan[] = {
E 67
E 64
I 64
static const char *epics_chan[] = {
E 64
E 62
I 62
static const char *epics_chan[] = {
E 62
E 55
I 55
static const char *epics_chan[] = {
E 55
D 35
  "MBSY2C_energy", "IGT0I00BIASET", "unknown",
E 35
I 35
  "MBSY2C_energy", "IGT0I00BIASET", "IGL1I00DAC2",
E 35
D 36
  "SMRPOSA", "SMRPOSB", "SMRPOSC", "unknown",
D 33
  "hallb_sf_xy560_0_5", "MTSETI", "MTVRBCK", "TMSETI", "TMVRBCK",
E 33
I 33
  "hallb_sf_xy560_0_5", "MTIRDBK", "MTVRBCK", "TMIRDBK", "TMVRBCK",
E 36
I 36
D 37
  "SMRPOSA", "SMRPOSB", "SMRPOSC", "harp.DRBV",
E 37
I 37
  "SMRPOSA", "SMRPOSB", "SMRPOSC", "harp",
E 37
D 56
D 61
  "hallb_sf_xy560_0_5", "MTIRBCK", "MTVRBCK", "TMIRBCK", "TMVRBCK",
E 56
I 56
  "torus_current", "MTIRBCK", "MTVRBCK", "TMIRBCK", "TMVRBCK",
E 56
E 61
I 61
  "torus_current", "MTIRBCK", "MTVRBCK", "TMIRBCK", "TMVRBCK",
E 61
E 36
E 33
  "B_cryotarget_pressure", "B_cryotarget_temperature", "B_cryotarget_status",
E 72
I 72

static char *epics_chan[] = {
  "MBSY2C_energy",
D 73
  "IGT0I00BIASET",
E 73
I 73
  /*"IGT0I00BIASET", does not exist*/
E 73
  "IGL1I00DAC2",
  "SMRPOSA",
  "SMRPOSB",
  "SMRPOSC",
D 73
  "harp",
E 73
I 73
  /*"harp", does not exist*/
E 73
  "torus_current",
  "MTIRBCK",
  "MTVRBCK",
  "TMIRBCK",
  "TMVRBCK",
D 73
  "B_cryotarget_pressure",
  "B_cryotarget_temperature",
  "B_cryotarget_status",
E 72
D 35
  "unknown","unknown",
E 35
I 35
D 44
  "VCG2C24","VCG2H01",
E 44
I 44
D 45
  "VCG2C24","VCG2H01","scaler_calc1",
E 45
I 45
  "VCG2C24","VCG2H01",
E 73
I 73

  /*"B_cryotarget_pressure",*/ /*timeout or zero*/
  /*"B_cryotarget_temperature",*/ /*timeout or zero*/
  /*"B_cryotarget_status",*/ /*timeout or zero*/

  "VCG2C24",
  "VCG2H01",
E 73
E 45
E 44
E 35
D 72
  "scalerS2o", "scalerS3o", "scalerS4o", "scalerS5o", 
  "scalerS6o", "scalerS7o", "scalerS8o", "scalerS9o", 
D 25
  "unknown", "unknown", "unknown", "unknown", "unknown", "unknown", "unknown", "unknown", "unknown",
E 25
I 25
  "IPM2H01.XPOS","IPM2H01.YPOS","IPM2H01",
  "IPM2C24A.XPOS","IPM2C24A.YPOS","IPM2C24A",
D 47
  "IPM2C22A.XPOS","IPM2C22A.YPOS","IPM2C22A",
E 47
I 47
  "IPM2C21A.XPOS","IPM2C21A.YPOS","IPM2C21A",
E 72
I 72
  "scalerS2o",
  "scalerS3o",
  "scalerS4o",
  "scalerS5o", 
  "scalerS6o",
  "scalerS7o",
  "scalerS8o",
  "scalerS9o", 
  "IPM2H01.XPOS",
  "IPM2H01.YPOS",
  "IPM2H01",
  "IPM2C24A.XPOS",
  "IPM2C24A.YPOS",
  "IPM2C24A",
  "IPM2C21A.XPOS",
  "IPM2C21A.YPOS",
D 73
  "IPM2C21A",
E 73
I 73
D 82
  "IPM2C21A"
E 82
I 82
  "IPM2C21A",

  /*since g9frost*/
  "HELCLOCKd",
  "HELTSETTLEd",
  "HELTSTABLEd",
  "HELDELAYd",
  "HELPATTERNd",
  "HELFREQ",
  "VWienAngle",
  "Phi_FG",
  "HWienAngle",
  "IGL1I00DI24_24M",
  "frost_Pol_LF",
  "frost_Amps_LF",
  "coh_edge",
  "coh_plane",
  "coh_radiator"
E 82
E 73
E 72
E 47
E 25
E 22
E 17
};
I 51
D 55
D 62
D 64
D 67
static char *epics_get[] = {
E 67
I 67
D 72
static const char *epics_get[] = {
E 67
E 64
I 64
static const char *epics_get[] = {
E 64
E 62
I 62
static const char *epics_get[] = {
E 62
E 55
I 55
static const char *epics_get[] = {
E 55
"get","get","get","get","get",   "get","get","get","get","get",
"get","get","get","get","get",   "get","get","get","get","get",
"get","get","get","get","get",   "get","get","get","get","get",
"get","get","get","get",
};
E 51
E 13
D 5
char *epics_get[]  = {"get","get","get S1",
		      "get S2","get S3",
E 5
I 5
D 6
char *epics_get[]  = {"get","get","get",
E 6
I 6
D 14
char *epics_get[]  = {"get","get","get","get",
E 14
I 14
D 22
static char *epics_get[]  = {"get","get","get","get",
I 18
		      "get",
E 18
E 14
E 6
E 5
		      "get","get",
		      "get","get",
D 5
		      "get S4","get S5",
		      "get S6"};
E 5
I 5
D 18
		      "get","get",
E 18
I 14
		      "get","get","get",
E 14
		      "get","get",
D 13
		      "get"};
E 13
I 13
D 14
		      "get","get",
E 14
};
E 22
E 13
E 5
E 3
D 17
static int epics_val[sizeof(epics_chan)/sizeof(char *)];
E 17
I 17
D 41
static float epics_val[sizeof(epics_chan)/sizeof(char *)];
E 41
I 41
static double epics_val[sizeof(epics_chan)/sizeof(char *)];
E 72
I 72

E 72
E 41
E 17
static int ncallback = 0;
I 72
D 73
static float epics_val[sizeof(epics_chan)/sizeof(char *)];
E 73
E 72
I 14
static int nepics    = sizeof(epics_chan)/sizeof(char *);
I 73
static float epics_val[sizeof(epics_chan)/sizeof(char *)];
E 73
E 14
I 13
D 72
cdevRequestObject *obj[sizeof(epics_chan)/sizeof(char *)];
cdevCallback *cb[sizeof(epics_chan)/sizeof(char *)];
E 72
E 13

I 80
D 81
#ifdef FILL_RTPC
#endif
E 81
E 80

I 21
D 49
// for record segment header
static int nevnt  = 0;
static int nphys  = 0;
static int trig   = 0;


// constants for head bank
static int nvers  = 0;
static int type   = 100;
static int rocst  = 0;
static int evcls  = 0;
static int presc  = 0;
E 49
I 49
// run_log_polar epics channel names
D 55
D 62
D 64
D 67
static char *polar_db_name[] = {
E 67
I 67
D 72
static const char *polar_db_name[] = {
E 67
E 64
I 64
static const char *polar_db_name[] = {
E 64
E 62
I 62
static const char *polar_db_name[] = {
E 62
E 55
I 55
static const char *polar_db_name[] = {
E 55
"raster_status",
"raster_set_x","raster_set_y","raster_set_x_offset","raster_set_y_offset",
"raster_x_offset","raster_y_offset",
"raster_rate","raster_x_size","raster_y_size",
"half_wave_plate","wien_angle","pair_sync_rate",
"beam_polarization","beam_polarization_err",
"pos_helicity_rate","helicity_flip_scheme",
"pt_banjo_he_level","pt_minicup_he_level",
"pt_polarization","pt_polarization_err",
"pt_calib_const","pt_loc_index","pt_encoder",
D 50
"pt_current","pt_temperature"
E 50
I 50
"pt_current","pt_temperature",
E 72
I 72
static char *polar_db_name[] = {
  "raster_status",
  "raster_set_x",
  "raster_set_y",
  "raster_set_x_offset",
  "raster_set_y_offset",
  "raster_x_offset",
  "raster_y_offset",
  "raster_rate",
  "raster_x_size",
  "raster_y_size",
  "half_wave_plate",
D 84
  "wien_angle",
E 84
I 84
  /*"wien_angle",*/
E 84
  "pair_sync_rate",
  "beam_polarization",
  "beam_polarization_err",
  "pos_helicity_rate",
D 83
  "helicity_flip_scheme",
E 83
I 83
  "helicity_flip_scheme"
  /*
E 83
  "pt_banjo_he_level",
  "pt_minicup_he_level",
  "pt_polarization",
  "pt_polarization_err",
  "pt_calib_const",
  "pt_loc_index",
D 74
  "pt_encoder",
E 74
I 74
  "pt_encoded",
E 74
  "pt_current",
  "pt_temperature",
I 83
*/
E 83
E 72
E 50
};
D 55
D 62
D 64
D 67
static char *polar_epics_chan[] = {
E 67
I 67
D 72
static const char *polar_epics_chan[] = {
E 67
E 64
I 64
static const char *polar_epics_chan[] = {
E 64
E 62
I 62
static const char *polar_epics_chan[] = {
E 62
E 55
I 55
static const char *polar_epics_chan[] = {
E 55
"raster_status_ttl",
"RASTSETPATTERNX","RASTSETPATTERNY","RASTSETXOFFSET","RASTSETYOFFSET",
"RASTXOFFSET","RASTYOFFSET",
"RASTCYCLETIME","RASTPATSIZEX","RASTPATSIZEY",
"IGL1I00OD16_16","HallProbe2_val","scaler_dS5b",
D 50
"unknown","unknown"
E 50
I 50
D 52
"unknown","unknown",
E 52
I 52
D 57
D 63
"beam_polarization","beam_polarization_err",
E 57
I 57
"beam_polarization","beam_polarization_error",
E 57
E 63
I 63
"beam_polarization","beam_polarization_error",
E 63
E 52
E 50
"scaler_dS6b","IGL1I00DIOFHRD",
"LL8240","LL8245",
D 50
"hallbptpol","unknown"
"hallbptcal","hallbptindex","hallbptenc"   
"hallbptcur","hallbpttemp"
E 50
I 50
"hallbptpol","unknown",
"hallbptcal","hallbptindex","hallbptenc",
"hallbptcur","hallbpttemp",
E 72
I 72

static char *polar_epics_chan[] = {
  "raster_status_ttl.RVAL",
  "RASTSETPATTERNX",
  "RASTSETPATTERNY",
  "RASTSETXOFFSET",
  "RASTSETYOFFSET",
  "RASTXOFFSET",
  "RASTYOFFSET",
  "RASTCYCLETIME",
  "RASTPATSIZEX",
  "RASTPATSIZEY",
  "IGL1I00OD16_16.RVAL",
D 84
  "HallProbe2_val",
E 84
I 84
  /*"HallProbe2_val",*/
E 84
  "scaler_dS5b",
  "beam_polarization",
  "beam_polarization_error",
  "scaler_dS6b",
D 83
  "IGL1I00DIOFHRD",
E 83
I 83
  "IGL1I00DIOFHRD"
  /*
E 83
  "LL8240",
  "LL8245",
  "hallbptpol",
  "unknown",
  "hallbptcal",
  "hallbptindex",
  "hallbptenc",
  "hallbptcur",
  "hallbpttemp",
I 83
  */
E 83
E 72
E 50
};
I 51
D 55
D 62
D 64
D 67
static char *polar_epics_get[] = {
E 67
I 67
D 72
static const char *polar_epics_get[] = {
E 67
D 58
E 64
I 64
static const char *polar_epics_get[] = {
E 64
E 62
I 62
static const char *polar_epics_get[] = {
E 62
E 55
I 55
static const char *polar_epics_get[] = {
E 55
D 66
"get RVAL","get","get","get","get",   "get","get","get","get","get",
"get","get","get","get","get",        "get","get","get","get","get",
"get","get","get","get","get",        "get",
E 58
I 58
"get RVAL",
"get","get","get","get",        
"get","get",
"get","get","get",
"get RVAL","get","get",
"get","get",
"get","get",
"get","get",
"get","get",
"get","get","get",
"get","get",
E 58
E 66
I 66
"get RVAL",
"get","get","get","get",
"get","get",
"get","get","get",
"get RVAL","get","get",
"get","get",
"get","get",
"get","get",
"get","get",
"get","get","get",
"get","get",
E 66
};
E 51
static double polar_epics_val[sizeof(epics_chan)/sizeof(char *)];
E 72
I 72

E 72
static int npolcallback = 0;
I 72
D 73
static float polar_epics_val[sizeof(epics_chan)/sizeof(char *)];
E 73
E 72
static int npolepics    = sizeof(polar_epics_chan)/sizeof(char *);
I 73
static float polar_epics_val[sizeof(polar_epics_chan)/sizeof(char *)];
E 73
D 72
cdevRequestObject *polobj[sizeof(polar_epics_chan)/sizeof(char *)];
cdevCallback *polcb[sizeof(polar_epics_chan)/sizeof(char *)];
E 72
E 49


I 81
#ifdef _RTPC_RUN_LOG_
// run_log_rtpc epics channel names
static char *rtpc_db_name[] = {
  "solenoid_current",
  "rtpc_drft_pres",		
  "rtpc_tagt_pres",		
  "rtpc_wrk_gas_flow",	
  "rtpc_qch_gas_flow",	
  "rtpc_he_bag_flow",	
  "rtpc_hv_gem",		
  "rtpc_hv_cath",		
};

static char *rtpc_epics_chan[] = {
  "MSL2H01M",
  "mks1_c1_val_chk",
  "HPI86BT44", 
  "mks1_c3_val_chk",
  "mks1_c2_val_chk", 
  "mks1_c4_val_chk",
  "rtpc_hv_gem",
  "rtpc_hv_cath",
};

static int nrtpccallback = 0;
static int nrtpcepics    = sizeof(rtpc_epics_chan)/sizeof(char *);
static float rtpc_epics_val[sizeof(rtpc_epics_chan)/sizeof(char *)];
#endif


E 81
E 21
I 18
// misc
D 22
static char filename[200];
I 21
static char line[200];
E 22
I 22
static char filename[256];
D 74
static char line[4096];
E 74
I 74
//static char line[4096];
E 74
D 49
static unsigned long ts_reg[128];
E 49
E 22
E 21


E 18
// prototypes
void decode_command_line(int argc, char **argv);
D 21
void collect_data(int &run, strstream &sql_string);
E 21
I 21
D 49
void collect_data(strstream &sql_string);
E 49
I 49
void collect_data(void);
I 76
int read_from_file(void);
I 81
#ifdef _RTPC_RUN_LOG_
void create_sql(strstream &rlb_string, strstream &rlp_string, strstream &rlr_string);
#else
E 81
E 76
void create_sql(strstream &rlb_string, strstream &rlp_string);
I 81
#endif
E 81
E 49
E 21
I 11
D 13
void read_prescale_factors(void);
E 13
E 11
void get_epics_data(void);
D 22
void insert_into_database(char *entry);
E 22
I 22
D 49
void insert_into_ipc(char *entry);
E 22
D 21
void insert_into_dd(int &run, char *entry);
I 7
void insert_into_file(int &run);
I 17
void insert_into_mapmgr(int &run);
E 21
I 21
D 42
void insert_into_dd(char *entry);
E 42
I 42
void insert_into_data(char *entry);
E 49
I 49
void get_polar_epics_data(void);
I 81
#ifdef _RTPC_RUN_LOG_
void get_rtpc_epics_data(void);
#endif
E 81
void insert_into_ipc(void);
D 55
D 62
D 64
D 67
void insert_into_database(char *entry);
D 54
void insert_into_datastream(char *entry);
E 54
I 54
void insert_into_datastream(char *entry, int banknum);
E 67
I 67
void insert_into_database(const char *entry);
void insert_into_datastream(const char *entry, int banknum);
E 67
E 64
I 64
void insert_into_database(const char *entry);
void insert_into_datastream(const char *entry, int banknum);
E 64
E 62
I 62
void insert_into_database(const char *entry);
void insert_into_datastream(const char *entry, int banknum);
E 62
E 55
I 55
void insert_into_database(const char *entry);
void insert_into_datastream(const char *entry, int banknum);
E 55
E 54
E 49
E 42
void insert_into_file();
D 26
void insert_into_mapmgr();
E 26
E 21
E 17
E 7
D 72
void epics_callback_func(int status, void *userarg, cdevRequestObject &epics_req_obj,
			    cdevData& result);
I 49
void polar_epics_callback_func(int status, void *userarg, cdevRequestObject &pol_epics_req_obj,
			    cdevData& result);
E 72
E 49
I 21
D 55
D 62
D 64
D 67
int find_tag_line(ifstream &file, char *tag, char buffer[], int buflen);
E 67
I 67
int find_tag_line(ifstream &file, const char *tag, char buffer[], int buflen);
E 67
E 64
I 64
int find_tag_line(ifstream &file, const char *tag, char buffer[], int buflen);
E 64
E 62
I 62
int find_tag_line(ifstream &file, const char *tag, char buffer[], int buflen);
E 62
E 55
I 55
int find_tag_line(ifstream &file, const char *tag, char buffer[], int buflen);
E 55
int get_next_line(ifstream &file, char buffer[], int buflen);
I 22
D 55
D 62
D 64
D 67
char *env_name(char *env, char *name);
E 67
I 67
char *env_name(const char *env, const char *name);
E 67
E 64
I 64
char *env_name(const char *env, const char *name);
E 64
E 62
I 62
char *env_name(const char *env, const char *name);
E 62
E 55
I 55
char *env_name(const char *env, const char *name);
E 55
I 49

I 70
char *name_only(char *x);
E 70
E 49
E 22
E 21
extern "C" {
I 13
D 17
int fork_and_wait(char *command);
E 17
I 17
D 18
int fork_and_wait(char *command, int timeout=0);
E 18
I 18
D 24
int fork_and_wait(char *command, int timeout, ...);
E 24
E 18
E 17
E 13
D 42
int create_header(int *p, int fevlen, int &banksize,
D 18
		  int nrun, int nevnt, int nphys, int trig);
E 18
I 18
D 21
		  int name1, int name2, int nrun, int nevnt, int nphys, int trig);
E 21
I 21
		  int name1, int name2, int run, int nevnt, int nphys, int trig);
E 21
E 18
int add_bank(int *p2fev, int fevlen, 
      char *name, int num, char *format, int ncol, int nrow, int ndata, int &banksize, int *data);
int va_add_bank(int *p2fev, int fevlen, 
      char *name, int num, char *format, int ncol, int nrow, int ndata, int &banksize, ...);
E 42
I 13
D 18
int insert_msg(char *name, char *facility, char *process, char *msgclass, 
	       int severity, char *status, int code, char *text);
E 18
D 55
D 62
D 64
D 67
void get_run_config(char *msql_database, char *session, int *run, char **config);
E 67
I 67
void get_run_config(const char *msql_database, const char *session, int *run, char **config);
E 67
E 64
I 64
void get_run_config(const char *msql_database, const char *session, int *run, char **config);
E 64
E 62
I 62
void get_run_config(const char *msql_database, const char *session, int *run, char **config);
E 62
E 55
I 55
void get_run_config(const char *msql_database, const char *session, int *run, char **config);
E 55
I 17
D 26
int map_put_float(const char filename[], const char subsystemname[],
		  const char itemname[], int arraylength,
		  const float farray[], int firsttime);
E 26
I 22
D 72
void DP_cmd_init(char *msql_tcp_host);
void DP_cmd(char *roc, char *cmd, char *buf, int timeout);
E 72
I 72
D 74
void tcpClientCmd(char *roc, char *cmd, char *buf);
E 74
I 74
int tcpClientCmd(char *roc, char *cmd, char *buf);
E 74
E 72
E 22
E 17
E 13
}


I 13
D 70
// macros
#define NAME_ONLY(x)  ((strrchr(x,'/')==NULL)?x:(strrchr(x,'/')+1)) 
E 13

I 13

E 70
E 13
// program start time
static time_t start=time(NULL);


D 72
// ref to cdev system object
cdevSystem &cdevsys = cdevSystem::defaultSystem ();


E 72
I 49
// ipc connection
TipcSrv &server=TipcSrv::Instance();


E 49
//--------------------------------------------------------------------------


D 53
main(int argc,char **argv){
E 53
I 53
D 73
main(int argc,char **argv) {
E 53

E 73
I 73
main(int argc,char **argv)
{
E 73
D 21
  int nrun=0;
E 21
I 13
D 18
  ostrstream temp;
E 18
E 13
D 49
  strstream sql_string;
I 13
  int status;
E 49
I 49
D 81
  strstream rlb_string,rlp_string;
E 81
I 81
  strstream rlb_string, rlp_string, rlr_string;
E 81
I 76
  int ret;
E 76
E 49
E 13


  // decode command line
  decode_command_line(argc,argv);

I 21

I 76
  // no ipc or file in recovery mode
  if(filep!=0)
  {
    no_info=1;
    no_file=1;
  }

E 76
E 21
  // set session name if not specified via env variable or on command line
D 55
D 62
D 64
D 67
  if(session==NULL)session="clasprod";
E 67
I 67
D 76
  if(session==NULL)session=(char*)"clasprod";
E 76
I 76
  if(filep==0) {
    if(strlen(session)==0) strcpy(session,"clasprod");
  }
E 76
E 67
E 64
I 64
  if(session==NULL)session=(char*)"clasprod";
E 64
E 62
I 62
  if(session==NULL)session=(char*)"clasprod";
E 62
E 55
I 55
  if(session==NULL)session=(char*)"clasprod";
E 55

I 21

E 21
D 72
  // only print cdev error messages
  cdevsys.setThreshold(CDEV_SEVERITY_ERROR);

I 13
D 18
  // post startup message
  temp << "Process startup:   run_log_begin" << ends;
  // status=insert_msg("run_log_begin","online","run_log_begin","status",0,"START",0,temp.str());

E 18
E 13
D 21
  // collect data (returns run number and sql string)
  collect_data(nrun,sql_string);
E 21

E 72
I 21
D 49
  // collect data (returns sql string)
  collect_data(sql_string);
E 49
I 49
D 76
  // collect data and create sql strings
  collect_data();
  create_sql(rlb_string,rlp_string);
E 76
I 76
  // normal mode
  if(filep==0)
  {
E 76
E 49

I 76
    // collect data and create sql strings
    collect_data();
E 76

I 81
#ifdef _RTPC_RUN_LOG_
    create_sql(rlb_string,rlp_string,rlr_string);
#else
E 81
I 46
D 49
  // write run begin info to file
  if((no_file==0)&&(debug==0))insert_into_file();
E 49
I 49
D 76
  // make entries
  if(debug==0) {
E 76
I 76
    create_sql(rlb_string,rlp_string);
I 81
#endif
E 81
E 76
E 49

I 49
D 53
    // write run begin info to file
E 53
I 53
D 54
    // write run begin info to file, including rlp
E 54
I 54
D 76
    // write rlb,rlp to file
E 54
E 53
    insert_into_file();
E 76
E 49
D 81

E 81
E 46
E 21
D 42
  // insert sql string into DD system as special database event
D 21
  if((no_dd ==0)&&(debug==0))insert_into_dd(nrun,sql_string.str());
E 21
I 21
  if((no_dd ==0)&&(debug==0))insert_into_dd(sql_string.str());
E 42
I 42
D 49
  // insert sql string into data stream as special database event
  if((no_data ==0)&&(debug==0))insert_into_data(sql_string.str());
E 49
I 49
D 76
    // connect to server
    dbr_init(uniq_subj,project,id_string);
E 76
I 76
    // make entries
    if(debug==0) {
E 76
E 49
E 42
E 21

I 49
D 54
    // insert rlb into data stream
    insert_into_datastream(rlb_string.str());
E 54
I 54
D 76
    // insert into data stream
    insert_into_datastream(rlb_string.str(),1);
D 72
    insert_into_datastream(rlp_string.str(),4);
E 72
I 72
D 74
    //////insert_into_datastream(rlp_string.str(),4);
E 74
I 74
    insert_into_datastream(rlp_string.str(),4); //polar
E 76
I 76
      // write rlb,rlp to file
      insert_into_file();
E 76
E 74
E 72
E 54
E 49
I 21

E 21
D 22
  // ship sql string to database router
  if((no_dbr==0)&&(debug==0))insert_into_database(sql_string.str());
E 22
I 22
D 49
  // ship sql string to database router and/or info_server
  if(debug==0)insert_into_ipc(sql_string.str());
E 49
I 49
D 54
    // ship rlb to info_server
E 54
I 54
D 76
    // ship to info_server
E 54
    insert_into_ipc();
E 76
I 76
      // connect to server
      dbr_init(uniq_subj,application,id_string);
E 76
E 49
E 22
D 46

I 7
D 21
  // write to file
  if((no_file==0)&&(debug==0))insert_into_file(nrun);
E 21

I 21
  // write run begin info to file
  if((no_file==0)&&(debug==0))insert_into_file();
E 46

I 49
D 54
    // ship rlb,rlp to database router
E 54
I 54
D 76
    // ship to database router
E 54
    insert_into_database(rlb_string.str());
D 72
    insert_into_database(rlp_string.str());
E 72
I 72
D 74
    //////insert_into_database(rlp_string.str());
E 74
I 74
    insert_into_database(rlp_string.str()); //polar
E 76
I 76
      // insert into data stream
      insert_into_datastream(rlb_string.str(),1);
      insert_into_datastream(rlp_string.str(),4); //polar
I 81
#ifdef _RTPC_RUN_LOG_
      insert_into_datastream(rlr_string.str(),8); //rtpc
#endif
E 81
E 76
E 74
E 72
E 49

E 21
I 17
D 26
  // write to mapmgr
D 21
  if((no_mapmgr==0)&&(debug==0))insert_into_mapmgr(nrun);
E 21
I 21
  if((no_mapmgr==0)&&(debug==0))insert_into_mapmgr();
E 21

I 21

E 26
E 21
E 17
E 7
D 49
  // debug...just print sql string
  if(debug!=0){
D 21
    cout << "\nsql string for run " << nrun << " is:\n\n" << sql_string.str() << endl << endl;
E 21
I 21
    cout << "\nsql string for run " << run << " is:\n\n" << sql_string.str() << endl << endl;
E 49
I 49
D 76
    // close ipc connection
    dbr_close();
E 76
I 76
      // ship to info_server
      insert_into_ipc();
E 76

I 76
      // ship to database router
      insert_into_database(rlb_string.str());
      insert_into_database(rlp_string.str()); //polar
I 81
#ifdef _RTPC_RUN_LOG_
      insert_into_database(rlr_string.str()); //rtpc
#endif
E 81
E 76

I 76
      // close ipc connection
      dbr_close();


    } else {

      // just print sql strings
      cout << "\nrlb for run " << run << " is:\n\n" << rlb_string.str()
	   << endl << endl;

	  // polar
      cout << "\nrlp for run " << run << " is:\n\n" << rlp_string.str()
	   << endl << endl;
I 81

#ifdef _RTPC_RUN_LOG_
	  // rtpc
      cout << "\nrlr for run " << run << " is:\n\n" << rlr_string.str()
	   << endl << endl;
#endif
E 81
    }

  // recovery mode
E 76
  } else {

D 76
    // just print sql strings
    cout << "\nrlb for run " << run << " is:\n\n" << rlb_string.str()
	 << endl << endl;
E 76
I 76
    printf("RECOVERY MODE\n");
E 76
D 72
    cout << "\nrlp for run " << run << " is:\n\n" << rlp_string.str()
	 << endl << endl;
E 72
I 72
D 74
    //////cout << "\nrlp for run " << run << " is:\n\n" << rlp_string.str()
	////// << endl << endl;
E 74
I 74

D 76
	// polar
    cout << "\nrlp for run " << run << " is:\n\n" << rlp_string.str()
	 << endl << endl;
E 74
E 72
E 49
E 21
  }
E 76
I 76
    for(int i=filep; i<argc; i++)
    {
      // read data from text file and create sql strings
      run = atoi(argv[i]);
      printf("Trying to read archive file for run number %d (>%s<)\n",run,argv[i]);
      ret = read_from_file();
      if(ret) continue; // did not get anything
E 76

I 81
#ifdef _RTPC_RUN_LOG_
      create_sql(rlb_string,rlp_string,rlr_string);
#else
E 81
I 76
      create_sql(rlb_string,rlp_string);
I 81
#endif
E 81
E 76
I 21

I 76
      // make entries
      if(debug==0) {

        // connect to server
        dbr_init(uniq_subj,application,id_string);
D 81

E 81
I 81
	
E 81
        // ship to database router
        insert_into_database(rlb_string.str());
        insert_into_database(rlp_string.str()); //polar
D 81

E 81
I 81
#ifdef _RTPC_RUN_LOG_
        insert_into_database(rlr_string.str()); //rtpc
#endif
E 81
        // close ipc connection
        dbr_close();
D 81
	  }
	  else
	  {
        // just print sql strings
        cout << "\nrlb for run " << run << " is:\n\n" << rlb_string.str()
	     << endl << endl;

	    // polar
        cout << "\nrlp for run " << run << " is:\n\n" << rlp_string.str()
	     << endl << endl;
	  }
E 81
I 81
      }
      else
	{
	  // just print sql strings
	  cout << "\nrlb for run " << run << " is:\n\n" << rlb_string.str()
	       << endl << endl;
	  
	  // polar
	  cout << "\nrlp for run " << run << " is:\n\n" << rlp_string.str()
	       << endl << endl;
	  
#ifdef _RTPC_RUN_LOG_
        // rtpc
	  cout << "\nrlr for run " << run << " is:\n\n" << rlr_string.str()
	       << endl << endl;
#endif
E 81
	}
I 81
    }
E 81
  }

E 76
E 21
  // done
I 13
D 18
  temp.seekp(0,ios::beg);
  temp << "Process shutdown:  run_log_begin" << ends;
  // status=insert_msg("run_log_begin","online","run_log_begin","status",0,"STOP",0,temp.str());
E 18
E 13
  exit(EXIT_SUCCESS);

}
       

//----------------------------------------------------------------


D 21
void collect_data(int &run, strstream &sql){
E 21
I 21
D 49
void collect_data(strstream &sql){
E 49
I 49
D 73
void collect_data(void) {
E 49
E 21

E 73
I 73
void
collect_data(void)
{
E 73
D 49

D 13
  m_result *result;
  m_row row_out;
E 13
  ostrstream query;
I 11
D 21
  int prescale[8];
I 18
  int l1mask;
E 18
E 11
D 7
  char *config;
E 7
  char startdate[30];
D 5
  char *ts_file, *l1_file, *discr_file, *thresh_file;
E 5
I 5
D 10
  char ts_file[80], l1_file[80], discr_file[80], thresh_file[80];
E 10
I 10
D 13
  char ts_file[80], l1_prog[80], l1_thresh[80], discr_file[80], thresh_file[80];
E 13
I 13
D 16
  char ts_file[100], l1_prog[100], l1_thresh[100], discr_file[100];
  char croc06_file[100], croc07_file[100], croc08_file[100], croc11_file[100], croc19_file[100];
E 16
I 16
  char ts_file[100], l1_prog[100], pretrig_file[100], discr_file[100];
  char croc06_spar[100], croc07_spar[100], croc08_spar[100], croc11_spar[100], croc19_spar[100];
E 16
  int flen;
E 13
E 10
E 5
  char *comma = ", ";
  char *prime = "'";
D 13
  int i;
E 13
I 13
  int i,status;
E 21
I 21
  int i,status,flen;
D 22
  char *comma = ", ", *prime = "'";
E 22
I 22
  char *comma = ",", *prime = "'";
E 49
I 49
D 68
  int i,flen;
E 68
I 68
D 69
  int i,j,k,ind,flen;
E 69
I 69
D 74
  int i,ind,flen;
E 74
I 74
  int i,ind,flen,ret;
E 74
  char *p;
I 74
  char line[4096];
E 74
E 69
E 68
E 49
E 22
E 21
E 13
  

D 5
  // ??? debug...
  ts_file = "tsjunk";
  l1_file = "l1junk";
  discr_file = "discrjunk";
  thresh_file = "threshjunk";
E 5
I 5
D 11
  // read names from files
  ifstream tsfile("/usr/local/clas/parms/run_log/ts_file.txt");
D 10
  ifstream l1file("/usr/local/clas/parms/run_log/l1_file.txt");
E 10
I 10
  ifstream l1prog("/usr/local/clas/parms/run_log/l1_prog.txt");
E 11
I 11
D 13
  // read prescaler factors...set to -1 if can't read them
  read_prescale_factors();
E 13
I 13
D 49
  // create epics callbacks and wait for data cdev_pend_time seconds
E 49
I 49
  // get all epics data
E 49
  get_epics_data();
I 49
  get_polar_epics_data();
E 49
E 13
D 81

E 81
I 81
#ifdef _RTPC_RUN_LOG_
  get_rtpc_epics_data();
#endif
E 81
D 73

E 73
I 13
  // get run number and config
D 76
  get_run_config(msql_database,session,&run,&config);
I 16
D 23
  if(strlen(session)==0)session="No session!";
  if(strlen(config)==0)config="No configuration!";
E 23
I 23
D 55
D 62
D 64
D 67
  if(strlen(session)==0)session="No_session!";
  if(strlen(config)==0)config="No_configuration!";
E 67
I 67
  if(strlen(session)==0)session=(char*)"No_session!";
  if(strlen(config)==0)config=(char*)"No_configuration!";
E 76
I 76
  get_run_config(msql_database,session,&run,&configin);
  if(strlen(session)==0) strcpy(session,"No_session!");
D 79
  if(strlen(config)==0) strcpy(config,"No_configuration!");
E 79
I 79
  if(strlen(configin)==0) strcpy(config,"No_configuration!");
E 79
  else strcpy(config,configin);
E 76
E 67
E 64
I 64
  if(strlen(session)==0)session=(char*)"No_session!";
  if(strlen(config)==0)config=(char*)"No_configuration!";
E 64
E 62
I 62
  if(strlen(session)==0)session=(char*)"No_session!";
  if(strlen(config)==0)config=(char*)"No_configuration!";
E 62
E 55
I 55
  if(strlen(session)==0)session=(char*)"No_session!";
  if(strlen(config)==0)config=(char*)"No_configuration!";
E 55
E 23
E 16

D 76

E 76
  // form start date
  tm *tstruct = localtime(&start);
D 72
  strftime(startdate, 25, "%d-%b-%Y %H:%M", tstruct);
E 72
I 72

  /*sergey strftime(startdate, 25, "%d-%b-%Y %H:%M", tstruct);*/
  strftime(startdate,25,"%Y-%m-%d %H:%M:%S",tstruct);
E 72
  

D 16
  // fork processes that data into files
E 16
I 16
D 21
  // fork processes that load data into files
E 16
D 17
  status=fork_and_wait("/usr/local/clas/bin/get_prescale_factors");
I 16
  //  status=fork_and_wait("/usr/local/clas/bin/discr_manager");
E 17
I 17
D 18
  status=fork_and_wait(get_prescale_factors,10);
  status=fork_and_wait(discr_manager,10);
E 18
I 18
  // status=fork_and_wait(get_prescale_factors,10,NULL);
  //  status=fork_and_wait(discr_manager,10,NULL);
  l1mask=fork_and_wait(get_ts_l1mask,10,NULL);
E 21
I 21
D 22
  // get l1 mask
  l1mask=fork_and_wait(get_ts_l1mask,3,NULL);
E 22
I 22
  // get l1 program file name
D 39
  ifstream l1prog(env_name("CLON_ROOT",current_l1prog_name));
D 23
  l1prog.getline(l1_prog,sizeof(l1_prog));
  l1prog.close();
E 23
I 23
  if(!l1prog.bad()) {
    l1prog.getline(l1_prog,sizeof(l1_prog));
    l1prog.close();
E 39
I 39
D 53
  if(polar==0) {
D 48
    ifstream l1prog(env_name("CLON_ROOT",current_l1prog_name));
E 48
I 48
    ifstream l1prog(env_name("CLON_PARMS",current_l1prog_name));
E 48
    if(!l1prog.bad()) {
      l1prog.getline(l1_prog,sizeof(l1_prog));
      l1prog.close();
    }
  } else {
    strcpy(l1_prog,"none");
E 53
I 53
  ifstream l1prog(env_name("CLON_PARMS",current_l1prog_name));
D 65
D 67
  if(!l1prog.bad()) {
E 67
I 67
  if(l1prog.is_open()) {
E 67
E 65
I 65
  if(l1prog.is_open()) {
E 65
    l1prog.getline(l1_prog,sizeof(l1_prog));
    l1prog.close();
E 53
E 39
  }
E 23
E 22
E 21
E 18
E 17
E 16
D 53


E 53
I 53
  
  
E 53
E 13
D 21
  // read startup data from various files
I 16
D 18
  char filename[120];
E 18
E 16
D 17
  ifstream   tsfile("/usr/local/clas/parms/run_log/ts_file.txt");
D 15
  ifstream   l1prog("/usr/local/clas/parms/run_log/l1_prog.txt");
E 15
I 15
D 16
  ifstream   l1prog("/home/clasrun/Current.Config");
E 15
E 11
  ifstream l1thresh("/usr/local/clas/parms/run_log/l1_thresh.txt");
E 10
D 11
  ifstream dsfile("/usr/local/clas/parms/run_log/discr_file.txt");
  ifstream thfile("/usr/local/clas/parms/run_log/thresh_file.txt");
E 11
I 11
  ifstream   dsfile("/usr/local/clas/parms/run_log/discr_file.txt");
E 16
I 16
  ifstream   l1prog("/usr/local/clas/parms/ts/Current.Config");
  sprintf(filename,current_pretrig_file,session);
  ifstream pretrig(filename);
  sprintf(filename,current_discr_file,session);
  ifstream   dsfile(filename);
E 16
D 13
  ifstream   thfile("/usr/local/clas/parms/run_log/thresh_file.txt");
E 13
  ifstream   prfile("/usr/local/clas/parms/run_log/prescale_factors.txt");
E 17
I 17
  ifstream   tsfile(current_tsfile_name);
  ifstream   l1prog(current_l1prog_name);
  ifstream pretrig(current_pretrig_name);
  ifstream   dsfile(current_discr_name);
  ifstream   prescfile(current_presc_name);
E 21
I 21
D 22
  // read file names and prescales
  ifstream tsfile(current_tsfile_name);
  ifstream l1prog(current_l1prog_name);
  ifstream prescfile(current_presc_name);
E 21
E 17

E 22
I 22
  // get ts file name
D 39
  ifstream tsfile(env_name("CLON_ROOT",current_tsfile_name));
E 22
E 11
D 23
  tsfile.getline(ts_file,sizeof(ts_file));
D 10
  l1file.getline(l1_file,sizeof(l1_file));
E 10
I 10
D 22
  l1prog.getline(l1_prog,sizeof(l1_prog));
D 16
  l1thresh.getline(l1_thresh,sizeof(l1_thresh));
E 16
I 16
D 21
  pretrig.getline(pretrig_file,sizeof(pretrig_file));
E 16
E 10
  dsfile.getline(discr_file,sizeof(discr_file));
E 21
D 13
  thfile.getline(thresh_file,sizeof(thresh_file));
E 13
I 11
D 17
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){ prfile >> prescale[i]; }
E 17
I 17
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){ prescfile >> prescale[i]; }
E 17

E 22
E 11
  tsfile.close();
E 23
I 23
  if(!tsfile.bad()) {
    tsfile.getline(ts_file,sizeof(ts_file));
    tsfile.close();
E 39
I 39
D 53
  if(polar==0) {
D 48
    ifstream tsfile(env_name("CLON_ROOT",current_tsfile_name));
E 48
I 48
    ifstream tsfile(env_name("CLON_PARMS",current_tsfile_name));
E 48
    if(!tsfile.bad()) {
      tsfile.getline(ts_file,sizeof(ts_file));
      tsfile.close();
    }
  } else {
    strcpy(ts_file,"none");
E 53
I 53
  ifstream tsfile(env_name("CLON_PARMS",current_tsfile_name));
D 65
D 67
  if(!tsfile.bad()) {
E 67
I 67
  if(tsfile.is_open()) {
E 67
E 65
I 65
  if(tsfile.is_open()) {
E 65
    tsfile.getline(ts_file,sizeof(ts_file));
    tsfile.close();
E 53
E 39
  }
E 23
D 10
  l1file.close();
E 10
I 10
D 22
  l1prog.close();
D 16
  l1thresh.close();
E 16
I 16
D 21
  pretrig.close();
E 16
E 10
  dsfile.close();
E 21
D 13
  thfile.close();
E 13
I 11
D 17
  prfile.close();
E 17
I 17
  prescfile.close();
E 22
E 17
E 11
E 5


D 13
  // create epics callbacks and wait for data cdev_pend_time seconds
D 11
  get_epics_data();
E 11
I 11
D 12
  //  get_epics_data();
E 12
I 12
  //  get_epics_data(); ???
E 13
I 13
D 21
  // read links
E 21
I 21
D 22
  // read sparsification threshold links 
E 21
D 16
  flen=readlink("/usr/local/clas/parms/initfiles/croc06.spar",croc06_file,sizeof(croc06_file));
  croc06_file[flen]=NULL;
  flen=readlink("/usr/local/clas/parms/initfiles/croc07.spar",croc07_file,sizeof(croc07_file));
  croc07_file[flen]=NULL;
  flen=readlink("/usr/local/clas/parms/initfiles/croc08.spar",croc08_file,sizeof(croc08_file));
  croc08_file[flen]=NULL;
  flen=readlink("/usr/local/clas/parms/initfiles/croc11.spar",croc11_file,sizeof(croc11_file));
  croc11_file[flen]=NULL;
  flen=readlink("/usr/local/clas/parms/initfiles/croc19.spar",croc19_file,sizeof(croc19_file));
  croc19_file[flen]=NULL;
E 16
I 16
D 17
  flen=readlink("/usr/local/clas/parms/initfiles/croc06.spar",croc06_spar,sizeof(croc06_spar));
E 17
I 17
  flen=readlink(croc06_spar_name,croc06_spar,sizeof(croc06_spar));
E 17
  croc06_spar[flen]=NULL;
D 17
  flen=readlink("/usr/local/clas/parms/initfiles/croc07.spar",croc07_spar,sizeof(croc07_spar));
E 17
I 17
  flen=readlink(croc07_spar_name,croc07_spar,sizeof(croc07_spar));
E 17
  croc07_spar[flen]=NULL;
D 17
  flen=readlink("/usr/local/clas/parms/initfiles/croc08.spar",croc08_spar,sizeof(croc08_spar));
E 17
I 17
  flen=readlink(croc08_spar_name,croc08_spar,sizeof(croc08_spar));
E 17
  croc08_spar[flen]=NULL;
D 17
  flen=readlink("/usr/local/clas/parms/initfiles/croc11.spar",croc11_spar,sizeof(croc11_spar));
E 17
I 17
  flen=readlink(croc11_spar_name,croc11_spar,sizeof(croc11_spar));
E 17
  croc11_spar[flen]=NULL;
D 17
  flen=readlink("/usr/local/clas/parms/initfiles/croc19.spar",croc19_spar,sizeof(croc19_spar));
E 17
I 17
  flen=readlink(croc19_spar_name,croc19_spar,sizeof(croc19_spar));
E 17
  croc19_spar[flen]=NULL;
E 22
I 22
  // get trigger config file name
D 39
  ifstream trigfile(env_name("CLON_ROOT",current_trigger_name));
D 23
  trigfile.getline(trigger_config,sizeof(trigger_config));
  trigfile.close();
E 23
I 23
  if(!trigfile.bad()) {
    trigfile.getline(trigger_config,sizeof(trigger_config));
    trigfile.close();
E 39
I 39
D 53
  if(polar==0) {
D 48
    ifstream trigfile(env_name("CLON_ROOT",current_trigger_name));
E 48
I 48
    ifstream trigfile(env_name("CLON_PARMS",current_trigger_name));
E 48
    if(!trigfile.bad()) {
      trigfile.getline(trigger_config,sizeof(trigger_config));
      trigfile.close();
    }
  } else {
    strcpy(trigger_config,"none");
E 53
I 53
  ifstream trigfile(env_name("CLON_PARMS",current_trigger_name));
D 65
D 67
  if(!trigfile.bad()) {
E 67
I 67
  if(trigfile.is_open()) {
E 67
E 65
I 65
  if(trigfile.is_open()) {
E 65
    trigfile.getline(trigger_config,sizeof(trigger_config));
    trigfile.close();
E 53
E 39
  }
E 23
E 22
E 16
E 13
E 12
E 11


I 22
  // get channel config file name
D 39
  ifstream chanfile(env_name("CLON_ROOT",current_channel_name));
D 23
  chanfile.getline(channel_config,sizeof(channel_config));
  chanfile.close();
E 23
I 23
  if(!chanfile.bad()) {
    chanfile.getline(channel_config,sizeof(channel_config));
    chanfile.close();
E 39
I 39
D 53
  if(polar==0) {
D 48
    ifstream chanfile(env_name("CLON_ROOT",current_channel_name));
E 48
I 48
    ifstream chanfile(env_name("CLON_PARMS",current_channel_name));
E 48
    if(!chanfile.bad()) {
      chanfile.getline(channel_config,sizeof(channel_config));
      chanfile.close();
    }
  } else {
    strcpy(channel_config,"none");
E 53
I 53
  ifstream chanfile(env_name("CLON_PARMS",current_channel_name));
D 65
D 67
  if(!chanfile.bad()) {
E 67
I 67
  if(chanfile.is_open()) {
E 67
E 65
I 65
  if(chanfile.is_open()) {
E 65
    chanfile.getline(channel_config,sizeof(channel_config));
    chanfile.close();
E 53
E 39
  }
E 23


D 72
  // get TS register data using callable DP_ask
D 39
  DP_cmd_init(getenv("MSQL_TCP_HOST"));
  DP_cmd("clastrig2","exec ts_reg()",line,3);
  istrstream tsreg_dp(line,sizeof(line));
  for(i=0; i<128; i++) tsreg_dp >> ts_reg[i];

  ts_csr=ts_reg[0];
  ts_control=ts_reg[1]&0xffff;
  ts_roc_enable=ts_reg[2];
  ts_synch=ts_reg[3]&0xffff;
D 38
  for(i=0; i<5; i++) ts_timer[i]=ts_reg[16+i]&0xffff;
E 38
I 38
  for(i=0; i<4; i++) ts_timer[i]=ts_reg[16+i]&0xffff;
  ts_timer[4]=ts_reg[20]&0xff;
E 38
  for(i=0; i<4; i++) prescale[i]=ts_reg[ 8+i]&0xffffff;
  for(i=4; i<8; i++) prescale[i]=ts_reg[ 8+i]&0xffff;
E 39
I 39
D 53
  if(polar==0) {
    DP_cmd_init(getenv("MSQL_TCP_HOST"));
    DP_cmd("clastrig2","exec ts_reg()",line,3);
    istrstream tsreg_dp(line,sizeof(line));
    for(i=0; i<128; i++) tsreg_dp >> ts_reg[i];
    
    ts_csr=ts_reg[0];
    ts_control=ts_reg[1]&0xffff;
    ts_roc_enable=ts_reg[2];
    ts_synch=ts_reg[3]&0xffff;
    for(i=0; i<4; i++) ts_timer[i]=ts_reg[16+i]&0xffff;
    ts_timer[4]=ts_reg[20]&0xff;
    for(i=0; i<4; i++) prescale[i]=ts_reg[ 8+i]&0xffffff;
    for(i=4; i<8; i++) prescale[i]=ts_reg[ 8+i]&0xffff;
  } else {
    for(i=0; i<5; i++) ts_timer[i]=0;
    for (i=0; i<sizeof(prescale)/sizeof(int); i++) prescale[i]=0;
  }
E 53
I 53
  DP_cmd_init(getenv("MSQL_TCP_HOST"));
D 55
D 62
D 64
D 67
  DP_cmd("clastrig2","exec ts_reg()",line,3);
E 67
I 67
  DP_cmd((char*)"clastrig2",(char*)"exec ts_reg()",line,3);
E 72
I 72
  // get TS register data
D 74
  tcpClientCmd((char*)"clastrig2",(char*)"ts_reg()",line);
E 72
E 67
E 64
I 64
  DP_cmd((char*)"clastrig2",(char*)"exec ts_reg()",line,3);
E 64
E 62
I 62
  DP_cmd((char*)"clastrig2",(char*)"exec ts_reg()",line,3);
E 62
E 55
I 55
  DP_cmd((char*)"clastrig2",(char*)"exec ts_reg()",line,3);
E 55
D 68
  istrstream tsreg_dp(line,sizeof(line));
  for(i=0; i<128; i++) tsreg_dp >> ts_reg[i];
E 68
I 68
D 69
  k=0; ind=0;
  for(i=0; i<128; i++) {k+=ind; sscanf(strchr(&line[k],'x')+1,"%x %n",&ts_reg[i],&ind);}
E 69
I 69
  p=line;
  for(i=0; i<128; i++) {p=strchr(p,'x')+1; sscanf(p,"%x %n",&ts_reg[i],&ind); p+=ind; }
E 74
I 74
  ret=tcpClientCmd((char*)"clastrig2",(char*)"ts_reg()",(char*)line);
  if(ret<0)
  {
    printf("tcpClientCmd returns %d - skip clastrig2 request\n",ret);
  }
  else
  {
    p=line;
    for(i=0; i<128; i++)
    {
      p=strchr(p,'x')+1;
      sscanf(p,"%x %n",&ts_reg[i],&ind);
	  //printf("[%3d] 0x%08x %d\n",i,ts_reg[i],ind);
      p+=ind;
    }
E 74
E 69
E 68
  
D 74
  ts_csr=ts_reg[0];
  ts_control=ts_reg[1]&0xffff;
  ts_roc_enable=ts_reg[2];
  ts_synch=ts_reg[3]&0xffff;
  for(i=0; i<4; i++) ts_timer[i]=ts_reg[16+i]&0xffff;
  ts_timer[4]=ts_reg[20]&0xff;
  for(i=0; i<4; i++) prescale[i]=ts_reg[ 8+i]&0xffffff;
  for(i=4; i<8; i++) prescale[i]=ts_reg[ 8+i]&0xffff;
E 74
I 74
    ts_csr=ts_reg[0];
    ts_control=ts_reg[1]&0xffff;
    ts_roc_enable=ts_reg[2];
    ts_synch=ts_reg[3]&0xffff;
    for(i=0; i<4; i++) ts_timer[i]=ts_reg[16+i]&0xffff;
    ts_timer[4]=ts_reg[20]&0xff;
    for(i=0; i<4; i++) prescale[i]=ts_reg[ 8+i]&0xffffff;
    for(i=4; i<8; i++) prescale[i]=ts_reg[ 8+i]&0xffff;
  }
E 74
E 53
E 39

 
  // read sparsification threshold links 
D 39
  flen=readlink(env_name("CLON_ROOT",sc_spar_name),sc_spar,sizeof(sc_spar));
  sc_spar[flen]=NULL;
  flen=readlink(env_name("CLON_ROOT",cc_spar_name),cc_spar,sizeof(cc_spar));
  cc_spar[flen]=NULL;
  flen=readlink(env_name("CLON_ROOT",ec1_spar_name),ec1_spar,sizeof(ec1_spar));
  ec1_spar[flen]=NULL;
  flen=readlink(env_name("CLON_ROOT",ec2_spar_name),ec2_spar,sizeof(ec2_spar));
  ec2_spar[flen]=NULL;
  flen=readlink(env_name("CLON_ROOT",lac_spar_name),lac_spar,sizeof(lac_spar));
  lac_spar[flen]=NULL;
 
 
E 39
I 39
D 53
  if(polar==0) {
D 48
    flen=readlink(env_name("CLON_ROOT",sc_spar_name),sc_spar,sizeof(sc_spar));
E 48
I 48
    flen=readlink(env_name("CLON_PARMS",sc_spar_name),sc_spar,sizeof(sc_spar));
E 48
    sc_spar[flen]=NULL;
D 48
    flen=readlink(env_name("CLON_ROOT",cc_spar_name),cc_spar,sizeof(cc_spar));
E 48
I 48
    flen=readlink(env_name("CLON_PARMS",cc_spar_name),cc_spar,sizeof(cc_spar));
E 48
    cc_spar[flen]=NULL;
D 48
    flen=readlink(env_name("CLON_ROOT",ec1_spar_name),ec1_spar,sizeof(ec1_spar));
E 48
I 48
    flen=readlink(env_name("CLON_PARMS",ec1_spar_name),ec1_spar,sizeof(ec1_spar));
E 48
    ec1_spar[flen]=NULL;
D 48
    flen=readlink(env_name("CLON_ROOT",ec2_spar_name),ec2_spar,sizeof(ec2_spar));
E 48
I 48
    flen=readlink(env_name("CLON_PARMS",ec2_spar_name),ec2_spar,sizeof(ec2_spar));
E 48
    ec2_spar[flen]=NULL;
D 48
    flen=readlink(env_name("CLON_ROOT",lac_spar_name),lac_spar,sizeof(lac_spar));
E 48
I 48
    flen=readlink(env_name("CLON_PARMS",lac_spar_name),lac_spar,sizeof(lac_spar));
E 48
    lac_spar[flen]=NULL;
    
    
E 53
I 53
  flen=readlink(env_name("CLON_PARMS",sc_spar_name),sc_spar,sizeof(sc_spar));
  sc_spar[flen]=NULL;
  flen=readlink(env_name("CLON_PARMS",cc_spar_name),cc_spar,sizeof(cc_spar));
  cc_spar[flen]=NULL;
  flen=readlink(env_name("CLON_PARMS",ec1_spar_name),ec1_spar,sizeof(ec1_spar));
  ec1_spar[flen]=NULL;
  flen=readlink(env_name("CLON_PARMS",ec2_spar_name),ec2_spar,sizeof(ec2_spar));
  ec2_spar[flen]=NULL;
  flen=readlink(env_name("CLON_PARMS",lac_spar_name),lac_spar,sizeof(lac_spar));
  lac_spar[flen]=NULL;
  
  
E 53
E 39
E 22
I 21
  // read pretrig summary data
D 39
  sprintf(filename,pretrig_file_name,session,run);
D 22
  ifstream pretrigfile(filename);
  find_tag_line(pretrigfile,"*???*",line,sizeof(line));
E 22
I 22
  ifstream pretrigfile(env_name("CLON_ROOT",filename));
I 23
  if(!pretrigfile.bad()) {
E 23
 
D 23
  find_tag_line(pretrigfile,"*EC_Mean*",line,sizeof(line));
E 22
  get_next_line(pretrigfile,line,sizeof(line));
D 22
  istrstream buf(line,sizeof(line));
  for (i=0; i<sizeof(pretrig_data)/sizeof(int); i++){ buf >> pretrig_data[i]; }
  pretrigfile.close();
E 22
I 22
  istrstream ec(line,sizeof(line));
  ec >> ec_inner_hi >> ec_inner_lo >> ec_outer_hi >> ec_outer_lo >> ec_total_hi >> ec_total_lo;
E 23
I 23
D 30
    find_tag_line(pretrigfile,"*EC_Mean*",line,sizeof(line));
    get_next_line(pretrigfile,line,sizeof(line));
    istrstream ec(line,sizeof(line));
D 27
    ec >> ec_inner_hi >> ec_inner_lo >> ec_outer_hi >> ec_outer_lo >> ec_total_hi >> ec_total_lo;
E 27
I 27
    ec >> ec_inner_hi >> ec_outer_hi >> ec_total_hi >> ec_inner_lo >> ec_outer_lo >> ec_total_lo;
E 30
I 30
    if(find_tag_line(pretrigfile,"*EC_Mean*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	istrstream ec(line,sizeof(line));
	ec >> ec_inner_hi >> ec_outer_hi >> ec_total_hi >> ec_inner_lo >> ec_outer_lo >> ec_total_lo;
E 39
I 39
D 53
    sprintf(filename,pretrig_file_name,session,run);
D 48
    ifstream pretrigfile(env_name("CLON_ROOT",filename));
E 48
I 48
    ifstream pretrigfile(env_name("CLON_PARMS",filename));
E 48
    if(!pretrigfile.bad()) {
      
      if(find_tag_line(pretrigfile,"*EC_Mean*",line,sizeof(line))==0) {
	if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	  istrstream ec(line,sizeof(line));
	  ec >> ec_inner_hi >> ec_outer_hi >> ec_total_hi >> ec_inner_lo >> ec_outer_lo >> ec_total_lo;
	}
E 53
I 53
  sprintf(filename,pretrig_file_name,session,run);
  ifstream pretrigfile(env_name("CLON_PARMS",filename));
D 65
D 67
  if(!pretrigfile.bad()) {
E 67
I 67
  if(pretrigfile.is_open()) {
E 67
E 65
I 65
  if(pretrigfile.is_open()) {
E 65
    
    if(find_tag_line(pretrigfile,"*EC_Mean*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	istrstream ec(line,sizeof(line));
	ec >> ec_inner_hi >> ec_outer_hi >> ec_total_hi >> ec_inner_lo >> ec_outer_lo >> ec_total_lo;
E 53
E 39
      }
I 53
    }
E 53
D 39
    }
E 39
      
D 39
    if(find_tag_line(pretrigfile,"*CC_Mean*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	istrstream cc(line,sizeof(line));
	cc >> cc_hi >> cc_lo;
E 39
I 39
D 53
      if(find_tag_line(pretrigfile,"*CC_Mean*",line,sizeof(line))==0) {
	if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	  istrstream cc(line,sizeof(line));
	  cc >> cc_hi >> cc_lo;
	}
E 53
I 53
    if(find_tag_line(pretrigfile,"*CC_Mean*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	istrstream cc(line,sizeof(line));
	cc >> cc_hi >> cc_lo;
E 53
E 39
      }
D 39
    }
E 30
D 28
    //    ec >> ec_inner_hi >> ec_inner_lo >> ec_outer_hi >> ec_outer_lo >> ec_total_hi >> ec_total_lo;
E 28
E 27
    
D 30
    find_tag_line(pretrigfile,"*CC_Mean*",line,sizeof(line));
    get_next_line(pretrigfile,line,sizeof(line));
    istrstream cc(line,sizeof(line));
    cc >> cc_hi >> cc_lo;
E 30
I 30
    if(find_tag_line(pretrigfile,"*SC_MeanThr*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	sscanf(line,"%d",&sc_thresh);
E 39
I 39
D 53
      
      if(find_tag_line(pretrigfile,"*SC_MeanThr*",line,sizeof(line))==0) {
	if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	  sscanf(line,"%d",&sc_thresh);
	}
E 53
I 53
    }
    
    if(find_tag_line(pretrigfile,"*SC_MeanThr*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	sscanf(line,"%d",&sc_thresh);
E 53
E 39
      }
D 39
    }
E 30
    
D 30
    find_tag_line(pretrigfile,"*SC_MeanThr*",line,sizeof(line));
    get_next_line(pretrigfile,line,sizeof(line));
    sscanf(line,"%d",&sc_thresh);
E 30
I 30
    if(find_tag_line(pretrigfile,"*SC_MeanWid*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	sscanf(line,"%d",&sc_width);
E 39
I 39
D 53
      
      if(find_tag_line(pretrigfile,"*SC_MeanWid*",line,sizeof(line))==0) {
	if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	  sscanf(line,"%d",&sc_width);
	}
E 53
I 53
    }
    
    if(find_tag_line(pretrigfile,"*SC_MeanWid*",line,sizeof(line))==0) {
      if(get_next_line(pretrigfile,line,sizeof(line))==0) {
	sscanf(line,"%d",&sc_width);
E 53
E 39
      }
D 39
    }
E 30
    
D 30
    find_tag_line(pretrigfile,"*SC_MeanWid*",line,sizeof(line));
    get_next_line(pretrigfile,line,sizeof(line));
    sscanf(line,"%d",&sc_width);
    
E 30
    pretrigfile.close();
  } 
E 23
 
E 39
I 39
D 53
      
      pretrigfile.close();
    } 
  } else {
    strcpy(sc_spar,"none");
    strcpy(cc_spar,"none");
    strcpy(ec1_spar,"none");
    strcpy(ec2_spar,"none");
    strcpy(lac_spar,"none");
  }
E 53
I 53
    }
    
    pretrigfile.close();
  } 
E 53
E 39
D 23
  find_tag_line(pretrigfile,"*CC_Mean*",line,sizeof(line));
  get_next_line(pretrigfile,line,sizeof(line));
  istrstream cc(line,sizeof(line));
  cc >> cc_hi >> cc_lo;
E 23
 
D 23
  find_tag_line(pretrigfile,"*SC_MeanThr*",line,sizeof(line));
  get_next_line(pretrigfile,line,sizeof(line));
  sscanf(line,"%d",&sc_thresh);
E 22
E 21
D 13
  // connect to msql database
  int connNum = msqlConnect(getenv("MSQL_TCP_HOST"));
  msqlSelectDB(connNum,msql_database);
  
E 13

I 22
  find_tag_line(pretrigfile,"*SC_MeanWid*",line,sizeof(line));
  get_next_line(pretrigfile,line,sizeof(line));
  sscanf(line,"%d",&sc_width);
E 22
I 21

E 21
D 13
  // form msql query, execute, then close msql connection
  query << "select runNumber,config from sessions where name='"
	<< session <<"'"<<ends;
  msqlQuery(connNum,query.str());
  result = msqlStoreResult();
  row_out = msqlFetchRow(result);
  msqlClose(connNum);
  

  // get run number 
  run=atoi(row_out[0]);


  // get config
  config=row_out[1];


  // form start date
  tm *tstruct = localtime(&start);
  strftime(startdate, 25, "%d-%b-%Y %H:%M", tstruct);
  

  // create sql string
E 13
I 13
D 22
  // done collecting data...create sql string
E 13
  sql << "insert into ingres.run_log_begin"
D 5
      << "(run, start_date, session, config, ts_file, l1_file, discr_file, thresh_file";
E 5
I 5
D 10
      << "(run, start_date, session_name, config, ts_file, l1_file, discr_file, thresh_file";
E 10
I 10
D 13
      << "(run, start_date, session_name, config, ts_file, l1_prog, l1_thresh, discr_file, thresh_file";
E 13
I 13
D 14
      << "(run, start_date, session_name, config, ts_file, l1_prog, l1_thresh, discr_file, "
E 14
I 14
D 16
      << "(run, start_date, session_name, configuration, ts_file, l1_program, l1_thresh, discr_file, "
E 14
      << "croc06_file, croc07_file, croc08_file, croc11_file, croc19_file";
E 16
I 16
D 21
      << "(run, start_date, session_name, configuration, ts_file, l1_program, pretrig_file, "
      << "discr_file, croc06_spar, croc07_spar, croc08_spar, croc11_spar, croc19_spar";
E 21
I 21
      << "(run, start_date, session_name, configuration, ts_file, l1_program, "
      << "croc06_spar, croc07_spar, croc08_spar, croc11_spar, croc19_spar";
E 22
I 22
  pretrigfile.close();
 
 
 
E 23
D 49
  // done collecting data...create sql string ---------------------------------
  sql << "insert into ingres.run_log_begin ("
      << "run,start_date,session_name,configuration,trigger_config,channel_config,"
      << "ts_file,l1_program,ts_csr,ts_control,ts_roc_enable,ts_synch,"
D 24
      << "ts_timer1,ts_timer2,ts_timer3,ts_timer4,ts_timer5,"
E 24
I 24
      << "ts_timer_1,ts_timer_2,ts_timer_3,ts_timer_4,ts_timer_5,"
E 24
      << "sc_spar,cc_spar,ec1_spar,ec2_spar,lac_spar,"
      << "ec_inner_hi,ec_inner_lo,ec_outer_hi,ec_outer_lo,ec_total_hi,ec_total_lo,"
      << "cc_hi,cc_lo,sc_thresh,sc_width";
E 22
E 21
E 16
E 13
E 10
E 5

I 22
D 42
  // add prescale registers
E 42
I 42
  // prescale registers
E 42
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){
    sql << comma << "prescale_" << i+1;
  }
  
D 42
  // add epics data
E 42
I 42
  // epics data
E 42
E 22
D 14
  for (i=0; i<sizeof(epics_chan)/sizeof(char *); i++){
E 14
I 14
  for (i=0; i<nepics; i++){
E 14
D 3
    sql << comma << epics_name[i];
E 3
I 3
    sql << comma << db_name[i];
E 3
  }

I 11
D 22
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){
D 16
    sql << comma << "prescale_" << i;
E 16
I 16
    sql << comma << "prescale_" << i+1;
E 16
  }
E 22

E 11
D 3
  sql << ") "
      << "values ("
E 3
I 3
  sql << ") values ("
E 3
D 21
      << run   << comma
E 21
I 21
D 22
      << run  << comma
E 21
D 14
      << prime << startdate   << prime << comma
      << prime << session     << prime << comma
      << prime << config      << prime << comma
      << prime << ts_file     << prime << comma
D 10
      << prime << l1_file     << prime << comma
E 10
I 10
      << prime << l1_prog     << prime << comma
      << prime << l1_thresh   << prime << comma
E 10
      << prime << discr_file  << prime << comma
E 14
I 14
D 16
      << prime << startdate   		 << prime << comma
      << prime << session     		 << prime << comma
      << prime << config      		 << prime << comma
      << prime << NAME_ONLY(ts_file)     << prime << comma
D 15
      << prime << NAME_ONLY(l1_prog)     << prime << comma
E 15
I 15
      << prime << (l1_prog)              << prime << comma
E 15
      << prime << NAME_ONLY(l1_thresh)   << prime << comma
      << prime << NAME_ONLY(discr_file)  << prime << comma
E 14
D 13
      << prime << thresh_file << prime;
E 13
I 13
      << prime << NAME_ONLY(croc06_file) << prime << comma
      << prime << NAME_ONLY(croc07_file) << prime << comma
      << prime << NAME_ONLY(croc08_file) << prime << comma
      << prime << NAME_ONLY(croc11_file) << prime << comma
      << prime << NAME_ONLY(croc19_file) << prime;
E 16
I 16
      << prime << startdate   		  << prime << comma
      << prime << session     		  << prime << comma
      << prime << config      		  << prime << comma
      << prime << NAME_ONLY(ts_file)      << prime << comma
      << prime << l1_prog                 << prime << comma
D 21
      << prime << NAME_ONLY(pretrig_file) << prime << comma
      << prime << NAME_ONLY(discr_file)   << prime << comma
E 21
      << prime << NAME_ONLY(croc06_spar)  << prime << comma
      << prime << NAME_ONLY(croc07_spar)  << prime << comma
      << prime << NAME_ONLY(croc08_spar)  << prime << comma
      << prime << NAME_ONLY(croc11_spar)  << prime << comma
      << prime << NAME_ONLY(croc19_spar)  << prime;
E 16
E 13

I 13

E 13
D 14
  for (i=0; i<sizeof(epics_chan)/sizeof(char *); i++){
E 14
I 14
  for (i=0; i<nepics; i++){
E 14
D 18
    sql << comma << epics_val[i];
E 18
I 18
    sql << comma << (int)epics_val[i];
E 22
I 22
      << run
      << comma	<< prime << startdate  		       << prime
      << comma	<< prime << session    		       << prime
      << comma	<< prime << config     		       << prime
      << comma	<< prime << NAME_ONLY(trigger_config)  << prime
      << comma	<< prime << NAME_ONLY(channel_config)  << prime
      << comma	<< prime << NAME_ONLY(ts_file)         << prime
      << comma	<< prime << l1_prog                    << prime
D 23
      << comma << ts_csr << comma << ts_control << comma << ts_roc_enable << comma << ts_synch;
E 23
I 23
      << comma << (long)ts_csr << comma << (long)ts_control 
      << comma << (long)ts_roc_enable << comma << (long)ts_synch;
E 23
  for (i=0; i<5; i++) {
D 23
    sql << comma << ts_timer[i];
E 23
I 23
    sql << comma << (long)ts_timer[i];
E 23
E 22
E 18
  }
I 22
  sql 
      << comma << prime	<< NAME_ONLY(sc_spar)   << prime 
      << comma << prime	<< NAME_ONLY(cc_spar)   << prime 
      << comma << prime	<< NAME_ONLY(ec1_spar)  << prime 
      << comma << prime	<< NAME_ONLY(ec2_spar)  << prime 
      << comma << prime	<< NAME_ONLY(lac_spar)  << prime 
      << comma << ec_inner_hi << comma << ec_inner_lo
      << comma << ec_outer_hi << comma << ec_outer_lo
      << comma << ec_total_hi << comma << ec_total_lo
      << comma << cc_hi       << comma << cc_lo
      << comma << sc_thresh   << comma << sc_width;
E 22

I 11
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){
    sql << comma << prescale[i];
  }
I 22
  for (i=0; i<nepics; i++){
    sql << comma << epics_val[i];
  }
E 22

E 11
  sql << ")" << ends;
  
E 49
D 22

E 22
  return;
}

I 76
//----------------------------------------------------------------
E 76

I 76

int
read_from_file(void)
{
  int ii,ind,flen,ret;
  char *p, date1[30], time1[30];
  char line[4096];

  // read run log archive file
  sprintf(filename,archive_file_name,session,run);
  ifstream file(env_name("CLON_PARMS",filename));
  if(!file.is_open())
  {
    printf("File >%s< does not exist - exit\n",filename);
    return(-1);
  }
  else
  {
    printf("Use file >%s<\n",env_name("CLON_PARMS",filename));
  }

  if(find_tag_line(file,"*RUN*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%d",&run);
  }

  if(find_tag_line(file,"*STARTDATE*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s %s",date1,time1);
    strcpy(startdate,date1);
    strcat(startdate," ");
    strcat(startdate,time1);
  }

  if(find_tag_line(file,"*SESSION*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",session);
  }

  if(find_tag_line(file,"*CONFIG*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
      sscanf(line,"%s",config);
    else
      strcpy(config,"");
  }

  if(find_tag_line(file,"*TRIGGER_CONFIG*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",trigger_config);
  }

  if(find_tag_line(file,"*CHANNEL_CONFIG*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",channel_config);
  }

  if(find_tag_line(file,"*TS_FILE*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",ts_file);
  }

  if(find_tag_line(file,"*L1_PROG*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",l1_prog);
  }

  if(find_tag_line(file,"*SCSPAR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",sc_spar);
  }

  if(find_tag_line(file,"*CCSPAR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",cc_spar);
  }

  if(find_tag_line(file,"*EC1SPAR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",ec1_spar);
  }

  if(find_tag_line(file,"*EC2SPAR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",ec2_spar);
  }

  if(find_tag_line(file,"*LACSPAR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%s",lac_spar);
  }
    
  if(find_tag_line(file,"*ECDISCR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%d %d %d %d %d %d",
      &ec_inner_hi,&ec_inner_lo,&ec_outer_hi,&ec_outer_lo,&ec_total_hi,&ec_total_lo);
  }
    
  if(find_tag_line(file,"*CCDISCR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%d %d",&cc_hi,&cc_lo);
  }

  if(find_tag_line(file,"*SCDISCR*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%d %d",&sc_thresh,&sc_width);
  }

  if(find_tag_line(file,"*TS_REG*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%x %x %x %x",&ts_csr,&ts_control,&ts_roc_enable,&ts_synch);
  }

  if(find_tag_line(file,"*TS_TIMERS*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%d %d %d %d %d",
    &ts_timer[0],&ts_timer[1],&ts_timer[2],&ts_timer[3],&ts_timer[4]);
  }

  if(find_tag_line(file,"*TS_PRESCALE*",line,sizeof(line))==0)
  {
    if(get_next_line(file,line,sizeof(line))==0)
    sscanf(line,"%d %d %d %d %d %d %d %d",
    &prescale[0],&prescale[1],&prescale[2],&prescale[3],
    &prescale[4],&prescale[5],&prescale[6],&prescale[7]);
  }

  if(find_tag_line(file,"*EPICS*",line,sizeof(line))==0)
  {
    ii = 0;
    while(get_next_line(file,line,sizeof(line))==0)
	{
      sscanf(line,"%f %d",&epics_val[ii],db_name[ii]);
      ii++;
    }
	if(ii != nepics) printf("WARN: ii=%d != nepics=%d\n",ii,nepics); 
  }

  if(find_tag_line(file,"*POLAR*",line,sizeof(line))==0)
  {
    ii = 0;
    while(get_next_line(file,line,sizeof(line))==0)
	{
      sscanf(line,"%f %d",&polar_epics_val[ii],polar_db_name[ii]);
      ii++;
    }
	if(ii != npolepics) printf("WARN: ii=%d != npolepics=%d\n",ii,npolepics); 
  }

I 81
#ifdef _RTPC_RUN_LOG_
  if(find_tag_line(file,"*RTPC*",line,sizeof(line))==0)
  {
    ii = 0;
    while(get_next_line(file,line,sizeof(line))==0)
	{
	  sscanf(line,"%f %d",&rtpc_epics_val[ii],rtpc_db_name[ii]);
	  ii++;
	}
	if(ii != nrtpcepics) printf("WARN: ii=%d != nrtpcepics=%d\n",ii,nrtpcepics); 
  }
#endif
E 81



D 81

E 81
  file.close();

  return(0);
}


E 76
D 49

E 49
I 11
//--------------------------------------------------------------------------


D 13
void read_prescale_factors(void){

  pid_t pid;
  int status;

  // fork process to read prescale factors and write to file
  switch (pid=fork()) {
  case -1:
    cerr << "?unable to fork get_prescale_factors" << endl;
    break;

  case 0:
    execlp("/usr/local/clas/bin/get_prescale_factors",NULL,(char *)0);
    break;

  default:
    waitpid(pid,&status,0);
    break;
  }

}


E 11
//--------------------------------------------------------------------------


E 13
D 72
void get_epics_data(){
E 72
I 72
void
get_epics_data()
{
  int i, result;
E 72

D 72
  cdevGroup group;
I 13
  int i;
E 13


  // count number of callbacks received
  ncallback=0;


D 13
  // create callback for each channel in one group (for efficiency in CA)
  group.start();
  for(int i=0; i<sizeof(epics_chan)/sizeof(char *); i++){
E 13
I 13
  // create request objects and callbacks
D 14
  for(i=0; i<sizeof(epics_chan)/sizeof(char *); i++){
E 14
I 14
  for(i=0; i<nepics; i++){
E 72
I 72
  for(i=0; i<nepics; i++)
  {
E 72
E 14
E 13
D 17
    epics_val[i]=-1;
E 17
I 17
D 38
    epics_val[i]=-1.0;
E 38
I 38
    epics_val[i]=-9999.0;
E 38
E 17
D 3
    cdevRequestObject *obj = cdevRequestObject::attachPtr(epics_chan[i],"get");
E 3
I 3
D 13
    cdevRequestObject *obj = cdevRequestObject::attachPtr(epics_chan[i],epics_get[i]);
E 3
    cdevCallback cb(epics_callback_func,(void*)i);
    obj->sendCallback(NULL,cb);
E 13
I 13
D 22
    obj[i] = cdevRequestObject::attachPtr(epics_chan[i],epics_get[i]);
E 22
I 22
D 51
    obj[i] = cdevRequestObject::attachPtr(epics_chan[i],"get");
E 51
I 51
D 55
D 62
D 64
D 67
    obj[i] = cdevRequestObject::attachPtr(epics_chan[i],epics_get[i]);
E 67
I 67
D 72
    obj[i] = cdevRequestObject::attachPtr((char*)epics_chan[i],(char*)epics_get[i]);
E 67
E 64
I 64
    obj[i] = cdevRequestObject::attachPtr((char*)epics_chan[i],(char*)epics_get[i]);
E 64
E 62
I 62
    obj[i] = cdevRequestObject::attachPtr((char*)epics_chan[i],(char*)epics_get[i]);
E 62
E 55
I 55
    obj[i] = cdevRequestObject::attachPtr((char*)epics_chan[i],(char*)epics_get[i]);
E 55
E 51
E 22
    cb[i] = new cdevCallback(epics_callback_func,(void*)i);
E 72
E 13
  }
I 72
  result = getepics(nepics, epics_chan, epics_val);
E 72
D 73

E 73
I 73
  /*
  printf("after: nepics=%d\n",nepics);
  for(i=0; i<nepics; i++)
  {
    printf("[%3d] name=>%30.30s< value=%13f\n",i,epics_chan[i],epics_val[i]);
  }
  */
E 73
I 13
D 72

  // get results in one group
  group.start();
D 14
  for(i=0; i<sizeof(epics_chan)/sizeof(char *); i++){
E 14
I 14
  for(i=0; i<nepics; i++){
E 14
    if(obj[i]!=NULL)obj[i]->sendCallback(NULL,*cb[i]);
  }

E 13

  // process group of callbacks
  group.pend((double)cdev_pend_time);

  
  // check if all callbacks received
D 3
  if(ncallback<sizeof(epics_chan)/sizeof(char *))cerr << "only received " << ncallback << " callbacks" << endl;
E 3
I 3
D 14
  if(ncallback<sizeof(epics_chan)/sizeof(char *))
    cerr << "?only received " << ncallback << " callbacks" << " out of " 
	 << sizeof(epics_chan)/sizeof(char *) << endl;
E 14
I 14
  if(ncallback<nepics){
D 49
    cerr << "?only received " << ncallback << " callbacks" << " out of " << nepics << endl;
E 49
I 49
    cerr << "?only received " << ncallback << " rlb callbacks" << " out of " << nepics << endl;
E 49
  }
E 14
E 3

E 72
D 14

E 14
  return;
}


//---------------------------------------------------------------------------


D 49
void epics_callback_func(int status, void *userarg, cdevRequestObject &epics_req_obj,
			    cdevData& result){
E 49
I 49
D 72
void epics_callback_func(int status, void *userarg,
			 cdevRequestObject &epics_req_obj,
			 cdevData& result){
E 72
I 72
void
get_polar_epics_data()
{
  int i, result;
E 72
E 49

D 72
  ncallback++;
D 17
  epics_val[(int)userarg] = (int) result;
E 17
I 17
D 41
  epics_val[(int)userarg] = (float) result;
E 41
I 41
  epics_val[(int)userarg] = (double) result;
E 41
E 17

  return;
}


//---------------------------------------------------------------------------


D 22
void insert_into_database(char *entry){
E 22
I 22
D 42
void insert_into_ipc(char *entry){
E 42
I 42
D 49
void insert_into_ipc(char *entry) {
E 49
I 49
void get_polar_epics_data(){
E 49
E 42
E 22

I 49
  cdevGroup group;
E 49
I 22
  int i;
E 22

I 22

E 22
D 49
  // disable gmd timeout
  T_OPTION opt=TutOptionLookup("Server_Delivery_Timeout");
  TutOptionSetNum(opt,0.0);
E 49
I 49
  // count number of callbacks received
  npolcallback=0;
E 49


D 49
  // connect to server
  TipcSrv &server=TipcSrv::Instance();
  dbr_init(uniq_dgrp,application,id_string);
E 49
I 49
  // create request objects and callbacks
  for(i=0; i<npolepics; i++){
E 72
I 72
  for(i=0; i<npolepics; i++)
  {
E 72
    polar_epics_val[i]=-9999.0;
D 51
    polobj[i] = cdevRequestObject::attachPtr(polar_epics_chan[i],"get");
E 51
I 51
D 55
D 62
D 64
D 67
    polobj[i] = cdevRequestObject::attachPtr(polar_epics_chan[i],polar_epics_get[i]);
E 67
I 67
D 72
    polobj[i] = cdevRequestObject::attachPtr((char*)polar_epics_chan[i],(char*)polar_epics_get[i]);
E 67
E 64
I 64
    polobj[i] = cdevRequestObject::attachPtr((char*)polar_epics_chan[i],(char*)polar_epics_get[i]);
E 64
E 62
I 62
    polobj[i] = cdevRequestObject::attachPtr((char*)polar_epics_chan[i],(char*)polar_epics_get[i]);
E 62
E 55
I 55
    polobj[i] = cdevRequestObject::attachPtr((char*)polar_epics_chan[i],(char*)polar_epics_get[i]);
E 55
E 51
    polcb[i] = new cdevCallback(polar_epics_callback_func,(void*)i);
E 72
  }
I 72
D 73
  result = getepics(nepics, polar_epics_chan, polar_epics_val);
E 72
E 49

E 73
I 73
  result = getepics(npolepics, polar_epics_chan, polar_epics_val);
  /*
  printf("after: npolepics=%d\n",npolepics);
  for(i=0; i<npolepics; i++)
  {
    printf("[%3d] name=>%30.30s< value=%13f\n",i,polar_epics_chan[i],polar_epics_val[i]);
  }
  */
E 73
D 72

D 22
  // construct dbr_request message
  TipcMsg msg = TipcMsg("dbr_request");
  msg.Dest(dest);
  msg.Sender(uniq_dgrp);
  msg.UserProp(0.0);
  msg.DeliveryMode(T_IPC_DELIVERY_ALL);
E 22
I 22
D 49
  // construct and send dbr_request message
  if(no_dbr==0) {
E 49
I 49
  // get results in one group
  group.start();
  for(i=0; i<npolepics; i++){
    if(polobj[i]!=NULL)polobj[i]->sendCallback(NULL,*polcb[i]);
  }
E 49
E 22

I 22
D 49
    TipcMsg dbr = TipcMsg("dbr_request");
    dbr.Dest(dest);
    dbr.Sender(uniq_dgrp);
    dbr.UserProp(0.0);
    dbr.DeliveryMode(T_IPC_DELIVERY_ALL);
    dbr << (T_INT4) 1 << entry;
    server.Send(dbr);
E 49
I 49

  // process group of callbacks
  group.pend((double)cdev_pend_time);

  
  // check if all callbacks received
  if(npolcallback<npolepics){
    cerr << "?only received " << npolcallback << " rlp callbacks" << " out of " << npolepics << endl;
E 49
  }
D 49
    
E 49
E 22

E 72
D 22
  // fill message 
  msg << (T_INT4) 1 << entry;
E 22
I 22
D 40
  // construct and send info_server message
E 40
I 40
D 49
  // info_server message
E 49
I 49
  return;
}

I 81
//---------------------------------------------------------------------------
E 81

I 81

#ifdef _RTPC_RUN_LOG_

void
get_rtpc_epics_data()
{
  int i, result;

  for(i=0; i<nrtpcepics; i++)
  {
    rtpc_epics_val[i]=-9999.0;
  }
  result = getepics(nrtpcepics, rtpc_epics_chan, rtpc_epics_val);
  /*
  printf("after: nrtpcepics=%d\n",nrtpcepics);
  for(i=0; i<nrtpcepics; i++)
  {
    printf("[%3d] name=>%30.30s< value=%13f\n",i,rtpc_epics_chan[i],rtpc_epics_val[i]);
  }
  */
  return;
}

#endif


E 81
//---------------------------------------------------------------------------

I 81
#ifdef _RTPC_RUN_LOG_
E 81

D 72
void polar_epics_callback_func(int status, void *userarg,
			    cdevRequestObject &polepics_req_obj,
			    cdevData& result){

  npolcallback++;
  polar_epics_val[(int)userarg] = (double) result;

  return;
}


//---------------------------------------------------------------------------


E 72
D 73
void create_sql(strstream &rlb, strstream &rlp) {

E 73
I 73
void
I 81
create_sql(strstream &rlb, strstream &rlp, strstream &rlr)
{
  int i;
  const char *comma = ",", *prime = "'";

  // run_log_begin
  rlb << "insert into run_log_begin ("
      << "run,start_date,session_name,configuration,trigger_config,channel_config,"
      << "ts_file,l1_program,ts_csr,ts_control,ts_roc_enable,ts_synch,"
      << "ts_timer_1,ts_timer_2,ts_timer_3,ts_timer_4,ts_timer_5,"
      << "sc_spar,cc_spar,ec1_spar,ec2_spar,lac_spar,"
      << "ec_inner_hi,ec_inner_lo,ec_outer_hi,ec_outer_lo,ec_total_hi,ec_total_lo,"
      << "cc_hi,cc_lo,sc_thresh,sc_width";

  // prescale registers
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){
    rlb << comma << "prescale_" << i+1;
  }
  
  // epics data
  for (i=0; i<nepics; i++)
  {
    rlb << comma << db_name[i];
  }

  rlb << ") values ("
      << run
      << comma	<< prime << startdate  		       << prime
      << comma	<< prime << session    		       << prime
      << comma	<< prime << config     		       << prime
      << comma	<< prime << name_only(trigger_config)  << prime
      << comma	<< prime << name_only(channel_config)  << prime
      << comma	<< prime << name_only(ts_file)         << prime
      << comma	<< prime << l1_prog                    << prime
      << comma << (long)ts_csr << comma << (long)ts_control 
      << comma << (long)ts_roc_enable << comma << (long)ts_synch;
  for (i=0; i<5; i++) 
  {
    rlb << comma << (long)ts_timer[i];
  }

  rlb 
      << comma << prime	<< name_only(sc_spar)   << prime 
      << comma << prime	<< name_only(cc_spar)   << prime 
      << comma << prime	<< name_only(ec1_spar)  << prime 
      << comma << prime	<< name_only(ec2_spar)  << prime 
      << comma << prime	<< name_only(lac_spar)  << prime 
      << comma << ec_inner_hi << comma << ec_inner_lo
      << comma << ec_outer_hi << comma << ec_outer_lo
      << comma << ec_total_hi << comma << ec_total_lo
      << comma << cc_hi       << comma << cc_lo
      << comma << sc_thresh   << comma << sc_width;

  for (i=0; i<sizeof(prescale)/sizeof(int); i++)
  {
    rlb << comma << prescale[i];
  }
  for (i=0; i<nepics; i++){
    rlb << comma << epics_val[i];
  }

  rlb << ")" << ends;
  

  // run_log_polar -------------------------------
  rlp << "insert into run_log_polar ("
      << "session_name,run";

  // polar epics names
  for (i=0; i<npolepics; i++){
    rlp << comma << polar_db_name[i];
  }

  rlp << ") values ("
       << prime << session << prime << comma << run;

  // polar epics data
  for (i=0; i<npolepics; i++){
    rlp << comma << polar_epics_val[i];
  }

  rlp << ")" << ends;


  // run_log_rtpc -------------------------------
  rlr << "insert into run_log_rtpc ("
      << "session_name,run";

  // rtpc epics names
  for (i=0; i<nrtpcepics; i++){
    rlr << comma << rtpc_db_name[i];
  }

  rlr << ") values ("
       << prime << session << prime << comma << run;

  // rtpc epics data
  for (i=0; i<nrtpcepics; i++){
    rlr << comma << rtpc_epics_val[i];
  }

  rlr << ")" << ends;


  return;
}


//--------------------------------------------------------------------------

#else

//--------------------------------------------------------------------------

void
E 81
create_sql(strstream &rlb, strstream &rlp)
{
E 73
  int i;
D 55
D 62
D 64
D 67
  char *comma = ",", *prime = "'";
E 67
I 67
  const char *comma = ",", *prime = "'";
E 67
E 64
I 64
  const char *comma = ",", *prime = "'";
E 64
E 62
I 62
  const char *comma = ",", *prime = "'";
E 62
E 55
I 55
  const char *comma = ",", *prime = "'";
E 55
D 73
  
E 73

  // run_log_begin
D 72
  rlb << "insert into ingres.run_log_begin ("
E 72
I 72
  rlb << "insert into run_log_begin ("
E 72
      << "run,start_date,session_name,configuration,trigger_config,channel_config,"
      << "ts_file,l1_program,ts_csr,ts_control,ts_roc_enable,ts_synch,"
      << "ts_timer_1,ts_timer_2,ts_timer_3,ts_timer_4,ts_timer_5,"
      << "sc_spar,cc_spar,ec1_spar,ec2_spar,lac_spar,"
      << "ec_inner_hi,ec_inner_lo,ec_outer_hi,ec_outer_lo,ec_total_hi,ec_total_lo,"
      << "cc_hi,cc_lo,sc_thresh,sc_width";

  // prescale registers
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){
    rlb << comma << "prescale_" << i+1;
  }
  
  // epics data
D 73
  for (i=0; i<nepics; i++){
E 73
I 73
  for (i=0; i<nepics; i++)
  {
E 73
    rlb << comma << db_name[i];
  }

  rlb << ") values ("
      << run
      << comma	<< prime << startdate  		       << prime
      << comma	<< prime << session    		       << prime
      << comma	<< prime << config     		       << prime
D 70
      << comma	<< prime << NAME_ONLY(trigger_config)  << prime
      << comma	<< prime << NAME_ONLY(channel_config)  << prime
      << comma	<< prime << NAME_ONLY(ts_file)         << prime
E 70
I 70
      << comma	<< prime << name_only(trigger_config)  << prime
      << comma	<< prime << name_only(channel_config)  << prime
      << comma	<< prime << name_only(ts_file)         << prime
E 70
      << comma	<< prime << l1_prog                    << prime
      << comma << (long)ts_csr << comma << (long)ts_control 
      << comma << (long)ts_roc_enable << comma << (long)ts_synch;
D 73
  for (i=0; i<5; i++) {
E 73
I 73
  for (i=0; i<5; i++) 
  {
E 73
    rlb << comma << (long)ts_timer[i];
  }

  rlb 
D 70
      << comma << prime	<< NAME_ONLY(sc_spar)   << prime 
      << comma << prime	<< NAME_ONLY(cc_spar)   << prime 
      << comma << prime	<< NAME_ONLY(ec1_spar)  << prime 
      << comma << prime	<< NAME_ONLY(ec2_spar)  << prime 
      << comma << prime	<< NAME_ONLY(lac_spar)  << prime 
E 70
I 70
      << comma << prime	<< name_only(sc_spar)   << prime 
      << comma << prime	<< name_only(cc_spar)   << prime 
      << comma << prime	<< name_only(ec1_spar)  << prime 
      << comma << prime	<< name_only(ec2_spar)  << prime 
      << comma << prime	<< name_only(lac_spar)  << prime 
E 70
      << comma << ec_inner_hi << comma << ec_inner_lo
      << comma << ec_outer_hi << comma << ec_outer_lo
      << comma << ec_total_hi << comma << ec_total_lo
      << comma << cc_hi       << comma << cc_lo
      << comma << sc_thresh   << comma << sc_width;

D 73
  for (i=0; i<sizeof(prescale)/sizeof(int); i++){
E 73
I 73
  for (i=0; i<sizeof(prescale)/sizeof(int); i++)
  {
E 73
    rlb << comma << prescale[i];
  }
  for (i=0; i<nepics; i++){
    rlb << comma << epics_val[i];
  }

  rlb << ")" << ends;
  

  // run_log_polar -------------------------------
D 72
  rlp << "insert into ingres.run_log_polar ("
E 72
I 72
  rlp << "insert into run_log_polar ("
E 72
      << "session_name,run";

  // polar epics names
  for (i=0; i<npolepics; i++){
    rlp << comma << polar_db_name[i];
  }

  rlp << ") values ("
       << prime << session << prime << comma << run;

  // polar epics data
  for (i=0; i<npolepics; i++){
    rlp << comma << polar_epics_val[i];
  }

  rlp << ")" << ends;

  return;
}

I 81
#endif
E 81

//--------------------------------------------------------------------------


D 73
void insert_into_ipc(void) {

E 73
I 73
void
insert_into_ipc(void)
{
E 73
  int i;

D 73

E 49
E 40
  if(no_info==0) {
E 22

E 73
I 73
  if(no_info==0)
  {
E 73
I 22
D 55
D 62
D 64
D 67
    TipcMsg info = TipcMsg("info_server");
D 24
    info.Dest(dest);
E 24
I 24
D 40
    info.Dest("info_server");
E 40
I 40
    info.Dest("info_server/in/run_log_begin");
E 67
I 67
    TipcMsg info = TipcMsg((T_STR)"info_server");
    info.Dest((T_STR)"info_server/in/run_log_begin");
E 67
E 64
I 64
    TipcMsg info = TipcMsg((T_STR)"info_server");
    info.Dest((T_STR)"info_server/in/run_log_begin");
E 64
E 62
I 62
    TipcMsg info = TipcMsg((T_STR)"info_server");
    info.Dest((T_STR)"info_server/in/run_log_begin");
E 62
E 55
I 55
    TipcMsg info = TipcMsg((T_STR)"info_server");
    info.Dest((T_STR)"info_server/in/run_log_begin");
E 55
E 40
E 24
D 49
    info.Sender(uniq_dgrp);
E 49
I 49
    info.Sender(uniq_subj);
E 49
D 40
    info.UserProp(0.0);
    info.DeliveryMode(T_IPC_DELIVERY_BEST_EFFORT);
E 40
E 22

D 22
  // send, flush msg
  server.Send(msg);
E 22
I 22
D 55
D 62
D 64
D 67
    info << "run_log_begin"
E 67
I 67
    info << (T_STR)"run_log_begin"
E 67
E 64
I 64
    info << (T_STR)"run_log_begin"
E 64
E 62
I 62
    info << (T_STR)"run_log_begin"
E 62
E 55
I 55
    info << (T_STR)"run_log_begin"
E 55
	 << (T_INT4) run << startdate << session << config 
D 70
	 << NAME_ONLY(trigger_config) << NAME_ONLY(channel_config)
	 << NAME_ONLY(ts_file) << l1_prog
E 70
I 70
	 << name_only(trigger_config) << name_only(channel_config)
	 << name_only(ts_file) << l1_prog
E 70
	 << (T_INT4)ts_csr << (T_INT4)ts_control << (T_INT4)ts_roc_enable << (T_INT4)ts_synch;
    for (i=0; i<5; i++) {
      info << (T_INT4)ts_timer[i];
    }
D 70
    info << NAME_ONLY(sc_spar) << NAME_ONLY(cc_spar) << NAME_ONLY(ec1_spar) 
	 << NAME_ONLY(ec2_spar) << NAME_ONLY(lac_spar)
E 70
I 70
    info << name_only(sc_spar) << name_only(cc_spar) << name_only(ec1_spar) 
	 << name_only(ec2_spar) << name_only(lac_spar)
E 70
	 << (T_INT4)ec_inner_hi << (T_INT4)ec_inner_lo << (T_INT4)ec_outer_hi << (T_INT4)ec_outer_lo 
	 << (T_INT4)ec_total_hi << (T_INT4)ec_total_lo
	 << (T_INT4)cc_hi << (T_INT4)cc_lo << (T_INT4)sc_thresh << (T_INT4)sc_width;

    for (i=0; i<sizeof(prescale)/sizeof(int); i++) { info << (T_INT4)prescale[i];}
D 41
    for (i=0; i<nepics; i++) {info << epics_val[i];}
E 41
I 41
    for (i=0; i<nepics; i++) {info << (T_REAL8)epics_val[i];}
I 54
    for (i=0; i<npolepics; i++) {info << (T_REAL8)polar_epics_val[i];}
I 81
#ifdef _RTPC_RUN_LOG_
    for (i=0; i<nrtpcepics; i++) {info << (T_REAL8)rtpc_epics_val[i];}
#endif
E 81
E 54
E 41

I 49
D 81

E 81
    // send and flush
E 49
    server.Send(info);
I 49
    server.Flush();
E 49
  }

I 49
  return;
}
E 49

D 49
  // flush messages
E 22
  server.Flush();
E 49
I 49
//----------------------------------------------------------------
  
E 49

I 49
D 59
D 62
D 64
D 67
void insert_into_database(char *entry) {
E 67
I 67
D 73
void insert_into_database(const char *entry) {
E 67
E 64
I 64
void insert_into_database(const char *entry) {
E 64
E 62
I 62
void insert_into_database(const char *entry) {
E 62
E 59
I 59
void insert_into_database(const char *entry) {
E 59
E 49

D 49
  // allow gmd to acknowledge receipt
  dbr_check((double) gmd_time);
E 49
I 49
  if(no_dbr==0) {
E 49

E 73
I 73
void
insert_into_database(const char *entry)
{
  if(no_dbr==0)
  {
E 73
I 49
    // disable gmd timeout
D 55
D 62
D 64
D 67
    T_OPTION opt=TutOptionLookup("Server_Delivery_Timeout");
E 67
I 67
    T_OPTION opt=TutOptionLookup((T_STR)"Server_Delivery_Timeout");
E 67
E 64
I 64
    T_OPTION opt=TutOptionLookup((T_STR)"Server_Delivery_Timeout");
E 64
E 62
I 62
    T_OPTION opt=TutOptionLookup((T_STR)"Server_Delivery_Timeout");
E 62
E 55
I 55
    T_OPTION opt=TutOptionLookup((T_STR)"Server_Delivery_Timeout");
E 55
    TutOptionSetNum(opt,0.0);
E 49

D 49
  // close ipc connection
  dbr_close();
E 49
I 49
D 55
D 62
D 64
D 67
    TipcMsg dbr = TipcMsg("dbr_request");
    dbr.Dest("dbrouter");
E 67
I 67
    TipcMsg dbr = TipcMsg((T_STR)"dbr_request");
    dbr.Dest((T_STR)"dbrouter");
E 67
E 64
I 64
    TipcMsg dbr = TipcMsg((T_STR)"dbr_request");
    dbr.Dest((T_STR)"dbrouter");
E 64
E 62
I 62
    TipcMsg dbr = TipcMsg((T_STR)"dbr_request");
    dbr.Dest((T_STR)"dbrouter");
E 62
E 55
I 55
    TipcMsg dbr = TipcMsg((T_STR)"dbr_request");
    dbr.Dest((T_STR)"dbrouter");
E 55
    dbr.Sender(uniq_subj);
    dbr.UserProp(0.0);
    dbr.DeliveryMode(T_IPC_DELIVERY_ALL);
D 60
D 62
D 64
D 67
    dbr << (T_INT4) 1 << entry;
E 67
I 67
    dbr << (T_INT4) 1 << (T_STR)entry;
E 67
E 64
I 64
    dbr << (T_INT4) 1 << (T_STR)entry;
E 64
E 62
I 62
    dbr << (T_INT4) 1 << (T_STR)entry;
E 62
E 60
I 60
    dbr << (T_INT4) 1 << (T_STR)entry;
E 60
E 49

I 49
    // send and flush, wait for gmd
    server.Send(dbr);
    server.Flush();
    dbr_check((double) gmd_time);
  }
E 49

  return;
}

//----------------------------------------------------------------
  

D 21
void insert_into_dd(int &run, char *entry){
E 21
I 21
D 42
void insert_into_dd(char *entry){
E 42
I 42
D 49
void insert_into_data(char *entry) {
E 49
I 49
D 54
void insert_into_datastream(char *entry) {
E 54
I 54
D 59
D 62
D 64
D 67
void insert_into_datastream(char *entry, int banknum) {
E 67
I 67
D 73
void insert_into_datastream(const char *entry, int banknum) {
E 67
E 64
I 64
void insert_into_datastream(const char *entry, int banknum) {
E 64
E 62
I 62
void insert_into_datastream(const char *entry, int banknum) {
E 62
E 59
I 59
void insert_into_datastream(const char *entry, int banknum) {
E 59
E 54
E 49
E 42
E 21
  
D 42
  int status;
  int *p,i,nused,banksize,nhead,buflen;
  struct fifo_mode fmode;
  fifo_entry fev;
  int ctl[4] = {-1,-1,-1,-1};


  // connect to DD system INPUT fifo
  fmode.mode     = FMODE_ALL;
  fmode.wait     = FWAIT_SLEEP;
  fmode.suser    = FMODE_MULTI_USER;
  fmode.prescale = 1;
  fmode.p2ctl    = ctl;
  status=ddu_init("INPUT",fmode);
  if(status!=0){
    cerr << "?unable to attach to DD system INPUT fifo, status is: " << status << endl;
    return;
  }


  // get free fifo event
  status=ddu_req_fev(DDBUFFERSIZE,&fev);
  if(status!=0){
    cerr << "?unable to get fev, status is: " << status << endl;
    return;
  }


  // set pointer, reset counts, fill ctl words, etc.
  p=fev.p2da;
  nused=0;
  nhead=0;
  fev.ctlw1=ddctl[0];
  fev.ctlb1=ddctl[1];
  fev.ctlw2=ddctl[2];
  fev.ctlb2=ddctl[3];
E 42

E 73
I 73
void
insert_into_datastream(const char *entry, int banknum)
{
E 73
I 42
  char dest[128];
E 42

I 49
D 73
  if(no_data==0) {
E 73
I 73
  if(no_data==0)
  {
E 73
E 49
D 42
  // create segment header, then update pointer and counters
D 18
  status=create_header(p,DDBUFFERSIZE-nused,nhead,run,nevnt,nphys,trig);
E 18
I 18
  status=create_header(p,DDBUFFERSIZE-nused,nhead,'RUNP','ARMS',run,nevnt,nphys,trig);
E 18
  if(status==0){
    p+=nhead;
    nused+=nhead;
  }  
E 42

D 42

  // head bank
  status=va_add_bank(p,DDBUFFERSIZE-nused,"HEAD",0,"I",8,1,8,banksize,
	      nvers,run,nevnt,start,type,rocst,evcls,presc);
  if(status==0){
    p+=banksize;
    nused+=banksize;
  }


  // fill data bank with logbook info
D 16
  buflen=strlen(entry)/4;
E 16
I 16
  buflen=(strlen(entry)+3)/4;
E 16
D 4
  status=add_bank(p,DDBUFFERSIZE-nused,"RNLG",2,"A",1,1,buflen,banksize,(int *)entry);
E 4
I 4
  status=add_bank(p,DDBUFFERSIZE-nused,"RNLG",1,"A",1,1,buflen,banksize,(int *)entry);
E 4
  if(status==0){
    p+=banksize;
    nused+=banksize;
  }


I 17
D 36
  // fill special begin run bank
D 18
  status=va_add_bank(p,DDBUFFERSIZE-nused,"BRUN",0,"I",7,1,7,banksize,
E 18
I 18
D 21
  status=va_add_bank(p,DDBUFFERSIZE-nused,"BREP",2,"7F",7,1,7,banksize,
E 21
I 21
D 31
  status=va_add_bank(p,DDBUFFERSIZE-nused,"BREP",2,"F",11,1,11,banksize,
E 21
E 18
D 20
		     epics_chan[0],epics_chan[1],epics_chan[2],epics_chan[3],
D 18
		     epics_chan[4],epics_chan[6],epics_chan[8]);
E 18
I 18
		     epics_chan[4],epics_chan[5],epics_chan[7]);
E 20
I 20
D 22
		     epics_val[0],epics_val[1],epics_val[2],epics_val[3],
D 21
		     epics_val[4],epics_val[5],epics_val[7]);
E 21
I 21
		     epics_val[4],epics_val[5],epics_val[7],epics_val[9],
		     epics_val[10],epics_val[11]);
E 22
I 22
		     epics_val[0],epics_val[1],epics_val[2],epics_val[4],
		     epics_val[7],epics_val[8],epics_val[10],epics_val[12],
		     epics_val[13],epics_val[14]);
E 22
E 21
E 20
E 18
  if(status==0){
    p+=banksize;
    nused+=banksize;
  }
E 31
I 31
//   status=va_add_bank(p,DDBUFFERSIZE-nused,"BREP",2,"F",11,1,11,banksize,
// 		     epics_val[0],epics_val[1],epics_val[2],epics_val[4],
// 		     epics_val[7],epics_val[8],epics_val[10],epics_val[12],
// 		     epics_val[13],epics_val[14]);
//   if(status==0){
//     p+=banksize;
//     nused+=banksize;
//   }
E 31



E 36
E 17
  // all banks added...set fev and fpack overall word counts
  fev.len=nused;
  *(fev.p2da+10)=nused-nhead;
E 42
I 42
D 49
  TipcSrv &server=TipcSrv::Instance();
  dbr_init(uniq_dgrp,application,id_string);
E 42


D 42
  // insert event into DD system
  status=ddu_put_fev(fev);
  if(status!=0){
    cerr << "?unable to put fev, status is: " << status << endl;
    return;
  }
E 42
I 42
  TipcMsg msg("evt_bosbank");
  msg.Sender("run_log_begin");
  sprintf(dest,"evt_bosbank/%s",session);
  msg.Dest(dest);
  int buflen=(strlen(entry)+3)/4;
  msg << "RNLG" << (T_INT4)1 << "(A)" << (T_INT4)1 << (T_INT4)1 << (T_INT4)buflen
      << SetSize(buflen) << (T_INT4*)entry;
  server.Send(msg);
  server.Flush();
E 42


D 42
  // disconnect from DD system
  ddu_close();
E 42
I 42
  dbr_close();
E 42

E 49
I 49
D 55
D 62
D 64
D 67
    TipcMsg msg("evt_bosbank");
    msg.Sender("run_log_begin");
E 67
I 67
    TipcMsg msg((T_STR)"evt_bosbank");
    msg.Sender((T_STR)"run_log_begin");
E 67
E 64
I 64
    TipcMsg msg((T_STR)"evt_bosbank");
    msg.Sender((T_STR)"run_log_begin");
E 64
E 62
I 62
    TipcMsg msg((T_STR)"evt_bosbank");
    msg.Sender((T_STR)"run_log_begin");
E 62
E 55
I 55
    TipcMsg msg((T_STR)"evt_bosbank");
    msg.Sender((T_STR)"run_log_begin");
E 55
    sprintf(dest,"evt_bosbank/%s",session);
    msg.Dest(dest);
    int buflen=(strlen(entry)+3)/4;
D 54
    msg << "RNLG" << (T_INT4)1 << "(A)" << (T_INT4)1 << (T_INT4)1 << (T_INT4)buflen
E 54
I 54
D 55
D 62
D 64
D 67
    msg << "RNLG" << (T_INT4)banknum << "(A)" << (T_INT4)1 << (T_INT4)1 << (T_INT4)buflen
E 67
I 67
    msg << (T_STR)"RNLG" << (T_INT4)banknum << (T_STR)"(A)" << (T_INT4)1 
	<< (T_INT4)1 << (T_INT4)buflen
E 67
E 64
I 64
    msg << (T_STR)"RNLG" << (T_INT4)banknum << (T_STR)"(A)" << (T_INT4)1 
	<< (T_INT4)1 << (T_INT4)buflen
E 64
E 62
I 62
    msg << (T_STR)"RNLG" << (T_INT4)banknum << (T_STR)"(A)" << (T_INT4)1 
	<< (T_INT4)1 << (T_INT4)buflen
E 62
E 55
I 55
    msg << (T_STR)"RNLG" << (T_INT4)banknum << (T_STR)"(A)" << (T_INT4)1 
	<< (T_INT4)1 << (T_INT4)buflen
E 55
E 54
	<< SetSize(buflen) << (T_INT4*)entry;
    server.Send(msg);
    server.Flush();
  }
E 49

  return;
}

  
//----------------------------------------------------------------


I 7
D 21
void insert_into_file(int &run){
E 21
I 21
D 59
D 62
D 64
D 67
void insert_into_file(){
E 67
I 67
D 73
void insert_into_file() {
E 67
E 64
I 64
void insert_into_file() {
E 64
E 62
I 62
void insert_into_file() {
E 62
E 59
I 59
void insert_into_file() {
E 59
E 21

E 73
I 73
void
insert_into_file()
{
E 73
D 21
  char space = ' ';
E 21
I 21
  int i;
E 21
I 8
D 18
  char filename[120];
E 18
E 8

I 49
D 73
  if(no_file==0) {
E 49
D 8
  ofstream file(current_run_file);
  file << run << space << session << space << config << endl;
E 8
I 8
D 17
  sprintf(filename,current_run_file,session);
E 17
I 17
D 21
  sprintf(filename,current_run_name,session);
E 21
I 21

E 73
I 73
  if(no_file==0)
  {
E 73
I 24
D 49
  // current run file needed by logbook...temporary
  sprintf(filename,"%s/run_log/current_run_%s.txt",getenv("CLON_PARMS"),session);
  ofstream cfile(filename);
  if(cfile.bad()) return;
  cfile << run << " " << config << endl;
  cfile.close();
  

  // run log archive file
E 24
D 22
  sprintf(filename,archive_file_name,run,session);
E 21
E 17
  ofstream file(filename);
E 22
I 22
  sprintf(filename,archive_file_name,session,run);
D 48
  ofstream file(env_name("CLON_ROOT",filename));
E 48
I 48
  ofstream file(env_name("CLON_PARMS",filename));
E 48
E 22
D 21
  file << run << space << config << endl;
E 21
I 21
  if(file.bad()) return;


D 22
  file << "\n*run*\n"       << run << endl;
  file << "\n*startdate*\n" << startdate << endl;
  file << "\n*session*\n"   << session << endl;
  file << "\n*config*\n"    << config << endl;
  file << "\n*ts_file*\n"   << NAME_ONLY(ts_file) << endl;     
  file << "\n*l1_prog*\n"   << l1_prog << endl;
  file << "\n*croc06*\n"    << NAME_ONLY(croc06_spar) << endl;
  file << "\n*croc07*\n"    << NAME_ONLY(croc07_spar) << endl;
  file << "\n*croc08*\n"    << NAME_ONLY(croc08_spar) << endl;
  file << "\n*croc09*\n"    << NAME_ONLY(croc11_spar) << endl;
  file << "\n*croc19*\n"    << NAME_ONLY(croc19_spar) << endl;
E 22
I 22
  file << "\n*RUN*\n"       	 << run << endl;
  file << "\n*STARTDATE*\n" 	 << startdate << endl;
  file << "\n*SESSION*\n"   	 << session << endl;
  file << "\n*CONFIG*\n"    	 << config << endl;
  file << "\n*TRIGGER_CONFIG*\n" << NAME_ONLY(trigger_config) << endl;     
  file << "\n*CHANNEL_CONFIG*\n" << NAME_ONLY(channel_config) << endl;     
  file << "\n*TS_FILE*\n"   	 << NAME_ONLY(ts_file) << endl;     
  file << "\n*L1_PROG*\n"   	 << l1_prog << endl;
  file << "\n*SCSPAR*\n"    	 << NAME_ONLY(sc_spar) << endl;
  file << "\n*CCSPAR*\n"    	 << NAME_ONLY(cc_spar) << endl;
  file << "\n*EC1SPAR*\n"   	 << NAME_ONLY(ec1_spar) << endl;
  file << "\n*EC2SPAR*\n"   	 << NAME_ONLY(ec2_spar) << endl;
  file << "\n*LACSPAR*\n"   	 << NAME_ONLY(lac_spar) << endl;
E 22

I 22
  file << "\n*ECDISCR*\n" << ec_inner_hi << " " << ec_inner_lo << " " 
       << ec_outer_hi << " " << ec_outer_lo << " " 
       << ec_total_hi << " " << ec_total_lo << endl;
E 22

D 22
  file << "\n*epics*" << endl;
  for (i=0; i<nepics; i++){
    file << epics_val[i] << db_name[i] << endl;
  }
E 22
I 22
  file << "\n*CCDISCR*\n" << cc_hi << " " << cc_lo << endl;
  file << "\n*SCDISCR*\n" << sc_thresh << " " << sc_width << endl;;
E 22

I 22
  file << "\n*TS_REG*\n" << hex 
       << "0x" << ts_csr << "  " 
       << "0x" << ts_control << "  " 
       << "0x" << ts_roc_enable << "  " 
       << "0x" << ts_synch << dec << endl;
E 22

D 22
  file << "\n*prescale*" << endl;
  for (i=0; i<sizeof(prescale)/sizeof(int); i++) {
    file << prescale[i] << "  ";
  }
  file << endl << endl;
E 22
I 22
  file << "\n*TS_TIMERS*\n";
  for (i=0; i<5; i++) file << ts_timer[i] << " ";
  file << endl;
E 22

I 22
  file << "\n*TS_PRESCALE*" << endl;
  for (i=0; i<sizeof(prescale)/sizeof(int); i++) { file << prescale[i] << "  ";}
  file << endl;
E 22

I 22
  file << "\n*EPICS*" << endl;
  for (i=0; i<nepics; i++){ file << setw(25) << epics_val[i] << "   " << db_name[i] << endl;}
  file << endl << endl;
E 49
I 49
    // current run file needed by logbook...temporary
    sprintf(filename,"%s/run_log/current_run_%s.txt",getenv("CLON_PARMS"),session);
    ofstream cfile(filename);
D 65
D 67
    if(cfile.bad()) return;
E 67
I 67
    if(!cfile.is_open()) return;
E 67
E 65
I 65
    if(!cfile.is_open()) return;
E 65
    cfile << run << " " << config << endl;
    cfile.close();
  
E 49

E 22
E 21
E 8
D 49
  file.close();
E 49
I 49
    // run log archive file
    sprintf(filename,archive_file_name,session,run);
    ofstream file(env_name("CLON_PARMS",filename));
D 65
D 67
    if(file.bad()) return;
E 67
I 67
    if(!file.is_open()) return;
E 67
E 65
I 65
    if(!file.is_open()) return;
E 65
    

    file << "\n*RUN*\n"       	 << run << endl;
    file << "\n*STARTDATE*\n" 	 << startdate << endl;
    file << "\n*SESSION*\n"   	 << session << endl;
    file << "\n*CONFIG*\n"    	 << config << endl;
D 70
    file << "\n*TRIGGER_CONFIG*\n" << NAME_ONLY(trigger_config) << endl;     
    file << "\n*CHANNEL_CONFIG*\n" << NAME_ONLY(channel_config) << endl;     
    file << "\n*TS_FILE*\n"   	 << NAME_ONLY(ts_file) << endl;     
E 70
I 70
    file << "\n*TRIGGER_CONFIG*\n" << name_only(trigger_config) << endl;     
    file << "\n*CHANNEL_CONFIG*\n" << name_only(channel_config) << endl;     
    file << "\n*TS_FILE*\n"   	 << name_only(ts_file) << endl;     
E 70
    file << "\n*L1_PROG*\n"   	 << l1_prog << endl;
D 70
    file << "\n*SCSPAR*\n"    	 << NAME_ONLY(sc_spar) << endl;
    file << "\n*CCSPAR*\n"    	 << NAME_ONLY(cc_spar) << endl;
    file << "\n*EC1SPAR*\n"   	 << NAME_ONLY(ec1_spar) << endl;
    file << "\n*EC2SPAR*\n"   	 << NAME_ONLY(ec2_spar) << endl;
    file << "\n*LACSPAR*\n"   	 << NAME_ONLY(lac_spar) << endl;
E 70
I 70
    file << "\n*SCSPAR*\n"    	 << name_only(sc_spar) << endl;
    file << "\n*CCSPAR*\n"    	 << name_only(cc_spar) << endl;
    file << "\n*EC1SPAR*\n"   	 << name_only(ec1_spar) << endl;
    file << "\n*EC2SPAR*\n"   	 << name_only(ec2_spar) << endl;
    file << "\n*LACSPAR*\n"   	 << name_only(lac_spar) << endl;
E 70
    
    file << "\n*ECDISCR*\n" << ec_inner_hi << " " << ec_inner_lo << " " 
	 << ec_outer_hi << " " << ec_outer_lo << " " 
	 << ec_total_hi << " " << ec_total_lo << endl;
    
    file << "\n*CCDISCR*\n" << cc_hi << " " << cc_lo << endl;
    file << "\n*SCDISCR*\n" << sc_thresh << " " << sc_width << endl;;
    
    file << "\n*TS_REG*\n" << hex 
	 << "0x" << ts_csr << "  " 
	 << "0x" << ts_control << "  " 
	 << "0x" << ts_roc_enable << "  " 
	 << "0x" << ts_synch << dec << endl;
    
    file << "\n*TS_TIMERS*\n";
    for (i=0; i<5; i++) file << ts_timer[i] << " ";
    file << endl;
    
    file << "\n*TS_PRESCALE*" << endl;
    for (i=0; i<sizeof(prescale)/sizeof(int); i++) { file << prescale[i] << "  ";}
    file << endl;
    
    file << "\n*EPICS*" << endl;
    for (i=0; i<nepics; i++){ file << setw(25) << epics_val[i] << "   " << db_name[i] << endl;}
D 53
    file << endl << endl;
E 53
I 53
    file << endl;
E 53
    
D 53
    file.close();
E 53
I 53
    file << "\n*POLAR*" << endl;
    for (i=0; i<npolepics; i++) { 
      file << setw(25) << polar_epics_val[i] << "   " << polar_db_name[i] << endl;
    }
    file << endl << endl;
E 53

I 81
#ifdef _RTPC_RUN_LOG_
    file << "\n*RTPC*" << endl;
    for (i=0; i<nrtpcepics; i++) { 
      file << setw(25) << rtpc_epics_val[i] << "   " << rtpc_db_name[i] << endl;
    }
    file << endl << endl;
#endif

E 81
I 53
    file.close();
E 53
  }
E 49

I 21
D 22

  // copy file to fileserver
//   strstream cmd;
//   cmd << "cp " << filename << " /net/fs1/???" << ends;
//   system(cmd.str());


E 22
E 21
  return;
}


//----------------------------------------------------------------
  

I 17
D 21
void insert_into_mapmgr(int &run){
E 21
I 21
D 26
void insert_into_mapmgr(){
E 21
  
D 22
  map_put_float(mapmgr_file_name, "beam"    , "energy"   ,1, &epics_val[0], run);
  map_put_float(mapmgr_file_name, "currents", "torus"    ,1, &epics_val[4], run);
D 18
  map_put_float(mapmgr_file_name, "currents", "minitorus",1, &epics_val[6], run);
  map_put_float(mapmgr_file_name, "currents", "tagger"   ,1, &epics_val[8], run);
E 18
I 18
  map_put_float(mapmgr_file_name, "currents", "minitorus",1, &epics_val[5], run);
  map_put_float(mapmgr_file_name, "currents", "tagger"   ,1, &epics_val[7], run);
E 22
I 22
  map_put_float(env_name("CLON_ROOT",mapmgr_file_name),"beam"    ,"energy"   ,1,&epics_val[0], run);
  map_put_float(env_name("CLON_ROOT",mapmgr_file_name),"currents","torus"    ,1,&epics_val[4], run);
  map_put_float(env_name("CLON_ROOT",mapmgr_file_name),"currents","minitorus",1,&epics_val[5], run);
  map_put_float(env_name("CLON_ROOT",mapmgr_file_name),"currents","tagger"   ,1,&epics_val[7], run);
E 22
E 18

  return;
}


//----------------------------------------------------------------
  

E 26
E 17
E 7
D 73
void decode_command_line(int argc, char **argv)
E 73
I 73
void
decode_command_line(int argc, char **argv)
E 73
{
D 73

E 73
  int i=1;
D 39
  char *help="\nusage:\n\n  run_log_begin [-a application] [-u uniq_dgrp] [-i id_string] [-debug]\n"
D 7
               "        [-d destination]  [-m msql_database]\n"
               "        [-s session]      [-no_dbr]        [-no_dd]     [-g gmd_time]  [-c cdev_pend_time]\n\n\n";
E 7
I 7
D 16
               "        [-d destination]  [-m msql_database] [-f current_run_file]\n"
               "        [-s session] [-no_dbr] [-no_dd] [-no_file] [-g gmd_time]  [-c cdev_pend_time]\n\n\n";
E 16
I 16
D 17
       "        [-d destination]  [-m msql_database]\n"
       "        [-frun current_run_file] [-fpre current_pretrig_file] [-fdiscr current_discr_file]\n"
E 17
I 17
D 23
       "        [-d destination]  [-m msql_database] [-no_mapmgr] [-map mapmgr_file_name]\n"
E 23
I 23
D 26
       "        [-d destination]  [-m msql_database] [-no_mapmgr]\n"
E 26
I 26
       "        [-d destination]  [-m msql_database] \n"
E 39
I 39
D 49
  char *help="\nusage:\n\n  run_log_begin [-a application] [-u uniq_dgrp] [-i id_string] [-polar]\n"
       "        [-debug] [-d destination]  [-m msql_database] \n"
E 49
I 49
D 53
  char *help="\nusage:\n\n  run_log_begin [-a project] [-u uniq_subj] [-i id_string] [-polar]\n"
E 53
I 53
D 55
D 62
D 64
D 67
  char *help="\nusage:\n\n  run_log_begin [-a project] [-u uniq_subj] [-i id_string]\n"
E 67
I 67
D 76
  const char *help="\nusage:\n\n  run_log_begin [-a project] [-u uniq_subj] [-i id_string]\n"
E 67
E 64
I 64
  const char *help="\nusage:\n\n  run_log_begin [-a project] [-u uniq_subj] [-i id_string]\n"
E 64
E 62
I 62
  const char *help="\nusage:\n\n  run_log_begin [-a project] [-u uniq_subj] [-i id_string]\n"
E 62
E 55
I 55
  const char *help="\nusage:\n\n  run_log_begin [-a project] [-u uniq_subj] [-i id_string]\n"
E 55
E 53
D 68
       "        [-debug] [-m msql_database] \n"
E 49
E 39
E 26
E 23
E 17
D 22
       "        [-s session] [-no_dbr] [-no_dd] [-no_file] [-g gmd_time]  [-c cdev_pend_time]\n\n\n";
E 22
I 22
D 42
       "        [-s session] [-no_dbr] [-no_dd] [-no_info] [-no_file] [-g gmd_time]  [-c cdev_pend_time]\n\n\n";
E 42
I 42
       "        [-s session] [-no_dbr] [-no_data] [-no_info] [-no_file] [-g gmd_time]  [-c cdev_pend_time]\n\n\n";
E 68
I 68
D 70
       "              [-debug] [-m msql_database]  [-s session] [-c cdev_pend_time]"
E 70
I 70
D 72
       "              [-debug] [-m msql_database]  [-s session] [-c cdev_pend_time]\n"
E 72
I 72
       "              [-debug] [-m msql_database]  [-s session]\n"
E 72
E 70
       "              [-no_dbr] [-no_data] [-no_info] [-no_file] [-g gmd_time] \n\n\n";
E 76
I 76
  const char *help="\nusage:\n\n  run_log_begin [-a application] [-u uniq_subj] [-i id_string]\n"
       "              [-debug] [-m msql_database]  [-s session] [-no_dbr] [-no_data]\n"
       "              [-no_info] [-no_file] [-g gmd_time] file1 file2 ... \n\n\n";
E 76
E 68
E 42
E 22
E 16
E 7

D 73

  while(i<argc) {
    
E 73
I 73
  while(i<argc)
  {    
E 73
    if(strncasecmp(argv[i],"-h",2)==0){
      printf(help);
      exit(EXIT_SUCCESS);
    }
I 76
    else if (strncasecmp(argv[i],"-",1)!=0){
      filep=i;
      return;
    }
E 76
    else if (strncasecmp(argv[i],"-debug",6)==0){
      debug=1;
I 39
D 53
      i=i+1;
    }
    else if (strncasecmp(argv[i],"-polar",6)==0){
      polar=1;
E 53
E 39
      i=i+1;
    }
    else if (strncasecmp(argv[i],"-no_dbr",7)==0){
      no_dbr=1;
      i=i+1;
    }
I 22
    else if (strncasecmp(argv[i],"-no_info",8)==0){
      no_info=1;
      i=i+1;
    }
E 22
D 42
    else if (strncasecmp(argv[i],"-no_dd",6)==0){
      no_dd=1;
E 42
I 42
    else if (strncasecmp(argv[i],"-no_data",8)==0){
      no_data=1;
E 42
      i=i+1;
    }
I 7
    else if (strncasecmp(argv[i],"-no_file",8)==0){
      no_file=1;
      i=i+1;
    }
I 16
D 17
    else if (strncasecmp(argv[i],"-frun",2)==0){
      current_run_file=strdup(argv[i+1]);
      i=i+2;
E 17
I 17
D 26
    else if (strncasecmp(argv[i],"-no_mapmgr",10)==0){
      no_mapmgr=1;
      i=i+1;
E 17
    }
E 26
D 17
    else if (strncasecmp(argv[i],"-fpre",2)==0){
      current_pretrig_file=strdup(argv[i+1]);
E 17
I 17
D 23
    else if (strncasecmp(argv[i],"-map",4)==0){
      mapmgr_file_name=strdup(argv[i+1]);
E 17
      i=i+2;
    }
E 23
D 17
    else if (strncasecmp(argv[i],"-fdiscr",2)==0){
      current_discr_file=strdup(argv[i+1]);
      i=i+2;
    }
E 17
E 16
E 7
    else if (strncasecmp(argv[i],"-a",2)==0){
D 49
      application=strdup(argv[i+1]);
E 49
I 49
D 76
      project=strdup(argv[i+1]);
E 76
I 76
      application=strdup(argv[i+1]);
E 76
E 49
      i=i+2;
    }
    else if (strncasecmp(argv[i],"-u",2)==0){
D 49
      uniq_dgrp=strdup(argv[i+1]);
E 49
I 49
      uniq_subj=strdup(argv[i+1]);
E 49
      i=i+2;
    }
    else if (strncasecmp(argv[i],"-i",2)==0){
      id_string=strdup(argv[i+1]);
D 49
      i=i+2;
    }
    else if (strncasecmp(argv[i],"-d",2)==0){
      dest=strdup(argv[i+1]);
E 49
      i=i+2;
    }
    else if (strncasecmp(argv[i],"-g",2)==0){
      gmd_time=atoi(argv[i+1]);
      i=i+2;
    }
D 72
    else if (strncasecmp(argv[i],"-c",2)==0){
      cdev_pend_time=atoi(argv[i+1]);
      i=i+2;
    }
E 72
    else if (strncasecmp(argv[i],"-s",2)==0){
D 76
      session=strdup(argv[i+1]);
E 76
I 76
      strcpy(session,argv[i+1]);
E 76
      i=i+2;
    }
    else if (strncasecmp(argv[i],"-m",2)==0){
      msql_database=strdup(argv[i+1]);
      i=i+2;
    }
I 7
D 16
    else if (strncasecmp(argv[i],"-f",2)==0){
      current_run_file=strdup(argv[i+1]);
      i=i+2;
    }
E 16
E 7
  }
}


D 22
/*---------------------------------------------------------------------*/
E 22
I 22
//---------------------------------------------------------------------
E 22

I 22

D 55
D 62
D 64
D 67
char *env_name(char *env, char *name) {
E 67
I 67
D 78
char *env_name(const char *env, const char *name) {
E 67
E 64
I 64
char *env_name(const char *env, const char *name) {
E 64
E 62
I 62
char *env_name(const char *env, const char *name) {
E 62
E 55
I 55
char *env_name(const char *env, const char *name) {
E 55

E 78
I 78
char *
env_name(const char *env, const char *name)
{
E 78
  static char bigname[200];
  char *e=getenv(env);

  if(e!=NULL) {
    strcpy(bigname,e);
    strcat(bigname,"/");
    strcat(bigname,name);
  } else {
    strcpy(bigname,name);
  }
  
  return(bigname);
}


//---------------------------------------------------------------------
I 70


D 78
char *name_only(char *fullname) {

E 78
I 78
char *
name_only(char *fullname)
{
E 78
  char *p;

  p=strstr(fullname,"/parms/");
  if(p!=NULL) {
    return(p+7);
  } else {
    return(fullname);
  }
}


//---------------------------------------------------------------------

E 70
E 22
E 1
