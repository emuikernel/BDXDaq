#!/bin/sh
#
# makeStatTbl - make a table of status values
#
# Copyright 1984-1995 Wind River Systems, Inc.
#
# modification history
# --------------------
# 01q,29oct01,cyr  doc: fix SPR 8773 makeStatTbl
# 01p,24mar99,dgp  docs: final editing
# 01o,06oct98,dbt  doc: fixed documentation.
# 01n,09jun95,p_m  adpated to Tornado.
# 01m,09sep94,jmm  added include of rpc/xdr.h
# 01l,11mar93,jdi  documentation tweaks for 5.1.
# 01k,29may92,rrr  made includes from h/
# 01j,11apr91,jdi  documentation cleanup; doc review by dnw.
# 01i,05oct90,gae  made special case "errno.h" processing more descriminating.
#                  added copyright.
# 01h,05may90,llk  changed to not include S_[A-Z].  POSIX defines macros
#		     that start with S_[A-Z].  Fixed bug so that S_ constants
#		     from coffAout.h are not included as error stati.
# 01g,21nov89,jcf  changed to be independent of symLib.h which now hashes.
# 01f,17nov88,llk  included rpctypes.h, xdr_nfs.h auth.h, and clnt.h.
# 01e,28sep88,gae  documentation.
# 01d,21apr88,gae  added special "errno.h" case for UNIX style error statuses.
# 01c,18nov87,gae  Fixed removing of temporary file on exit.
# 01b,05nov87,jlf  Documentation update, mod history added
#
# SYNOPSIS
# .tS
# makeStatTbl <hdir> [...]
# .tE
#
# DESCRIPTION
# This tool creates an array of type SYMBOL that contains the
# names and values of all the status codes defined in the .h files in the
# specified directory(s).  All status codes must be prefixed with "S_"
# to be included in this table, with the exception of status codes
# in the UNIX-compatible header file errno.h.
# In each <hdir> there must be a *ModNum.h file which defines the module
# numbers, e.g., "M_".
# The generated code is written to standard output.
# On UNIX you can redirect this output to a file, for example:
# makeStatTbl target\h > statTbl.c
#
# The symbol array is accessible through the global variable
# `statTbl'.  The array contains `statTblSize' elements.
# These are the only external declarations in the generated code.
#
# This tool's primary use is for creating the VxWorks status table used
# by printErrno(), but may be used by applications as well.  For
# an example, see $WIND_BASE/target/config/all/statTbl.c, which is 
# generated by this tool from `$WIND_BASE/target/h/*'.
#
# FILES
# .TS
# tab(|);
# lf3 l.
# <hdir>/*ModNum.h  |  module number file for each h directory
# symLib.h          |  symbol header file 
# .TE
#
# SEE ALSO: errnoLib, symLib
#
# NOROUTINES

tool=`basename $0`
tmp=/tmp/$tool.$$
tmpe=/tmp/e$tool.$$

trap "rm -f $tmp $tmpe; exit" 0 1 2 3 15

# XXX should check argument count

# init file

cat </dev/null >$tmp

for dir in $*
do
    {
    (cd $dir; cat *.h) | egrep "^#define[ 	]*S_[^A-Z]" >>$tmp

    if (test -f $dir/errno.h) then
	cat $dir/errno.h | egrep "^#define[ 	]E" >$tmpe
    fi
    }
done

echo "\
/* statTbl.c - status code symbol table */

/* CREATED BY $tool"

for dir in $*
do
    {
    echo " *       FROM `cd $dir; pwd`"
    }
done

echo " *         ON `date`
 */
"'
#include "vxWorks.h"
#include "symbol.h"
#include "rpc/rpctypes.h"
#include "rpc/xdr.h"
#include "xdr_nfs.h"
#include "rpc/auth.h"
#include "rpc/clnt.h"
'
for dir in $*
do
    {
    if (test -f $dir/`cd $dir; echo *ModNum.h`) then
	echo "#include \"`cd $dir; echo *ModNum.h`"\"
    fi
    }
done

echo

cat $tmp $tmpe

echo '
SYMBOL statTbl [] =
    {'

sed -e 's/^.*define[ 	]*\([a-zA-Z0-9_]*\).*/    {{NULL},"S_errno_\1", (char *) (M_errno | \1),0},/' \
    $tmpe

sed -e 's/^.*define[ 	]*\(S_[a-zA-Z0-9_]*\).*/    {{NULL},"\1", (char *) \1,0},/' \
    $tmp

echo "    };

ULONG statTblSize = NELEMENTS (statTbl);"

exit 0
